<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบคำขอกู้เงิน</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-6xl mx-auto bg-white shadow-xl rounded-2xl p-6 space-y-6">

<h1 class="text-2xl font-bold text-center">หนังสือคำขอกู้เงิน</h1>

<!-- ================= MEMBER SEARCH ================= -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <input id="member_id" class="border p-2 rounded" placeholder="เลขสมาชิก">
  <button onclick="loadMember()" class="bg-blue-600 text-white px-4 py-2 rounded">
    ค้นหาสมาชิก
  </button>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <input id="full_name" class="border p-2 rounded" placeholder="ชื่อ-สกุล">
  <input id="phone" class="border p-2 rounded" placeholder="โทรศัพท์">
  <input id="group" class="border p-2 rounded" placeholder="กลุ่ม">
</div>

<!-- ================= REGISTER ADDRESS ================= -->
<div class="border-t pt-4">
<h2 class="font-bold mb-2">ที่อยู่ตามทะเบียนบ้าน</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<input id="house_no" class="border p-2 rounded" placeholder="เลขที่">
<input id="moo" class="border p-2 rounded" placeholder="หมู่">
<input id="village" class="border p-2 rounded" placeholder="หมู่บ้าน">
<input id="street" class="border p-2 rounded" placeholder="ถนน">
<input id="subdistrict" class="border p-2 rounded" placeholder="ตำบล">
<input id="district" class="border p-2 rounded" placeholder="อำเภอ">
<input id="province" class="border p-2 rounded" placeholder="จังหวัด">
<input id="postal_code" class="border p-2 rounded" placeholder="รหัสไปรษณีย์">
</div>
</div>

<!-- ================= CURRENT ADDRESS ================= -->
<div class="border-t pt-4">
<div class="flex justify-between items-center mb-2">
<h2 class="font-bold">ที่อยู่ปัจจุบัน</h2>
<button onclick="copyAddress()" class="bg-gray-700 text-white px-3 py-1 rounded">
คัดลอกจากทะเบียนบ้าน
</button>
</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<input id="c_house_no" class="border p-2 rounded" placeholder="เลขที่">
<input id="c_moo" class="border p-2 rounded" placeholder="หมู่">
<input id="c_village" class="border p-2 rounded" placeholder="หมู่บ้าน">
<input id="c_street" class="border p-2 rounded" placeholder="ถนน">
<input id="c_subdistrict" class="border p-2 rounded" placeholder="ตำบล">
<input id="c_district" class="border p-2 rounded" placeholder="อำเภอ">
<input id="c_province" class="border p-2 rounded" placeholder="จังหวัด">
<input id="c_postal_code" class="border p-2 rounded" placeholder="รหัสไปรษณีย์">
</div>
</div>

<!-- ================= LOAN TYPE ================= -->
<div class="border-t pt-4 space-y-2">
<label class="font-semibold">ประเภทเงินกู้</label>
<select id="loan_type" class="border p-2 rounded w-full">
<option value="">-- เลือกประเภท --</option>
<option value="emergency">ระยะฉุกเฉิน</option>
<option value="short">ระยะสั้น</option>
<option value="medium">ระยะปานกลาง</option>
<option value="long">ระยะยาว</option>
</select>
</div>

<!-- ================= PURPOSE ================= -->
<div class="border-t pt-4 space-y-2">
<label class="font-semibold">วัตถุประสงค์การกู้เงิน</label>

<select id="loan_purpose" class="border p-2 rounded w-full"
        onchange="handlePurposeChange()">
<option value="">-- เลือกวัตถุประสงค์ --</option>
<option value="เพื่อเป็นทุนสำรองค่าใช้จ่ายภายในบ้าน">เพื่อเป็นทุนสำรองค่าใช้จ่ายภายในบ้าน</option>
<option value="เพื่อเป็นทุนหมุนเวียนในการทำธุรกิจ">เพื่อเป็นทุนหมุนเวียนในการทำธุรกิจ</option>
<option value="เพื่อซ่อมแซมบ้านอยู่อาศัย">เพื่อซ่อมแซมบ้านอยู่อาศัย</option>
<option value="เพื่อเป็นทุนการศึกษา">เพื่อเป็นทุนการศึกษา</option>
<option value="other">อื่นๆ</option>
</select>

<div id="other_purpose_box" class="hidden">
<input id="other_purpose_text"
       class="border p-2 rounded w-full mt-2"
       placeholder="โปรดระบุวัตถุประสงค์เพิ่มเติม">
</div>
</div>

<!-- ================= SAVE ================= -->
<div class="text-center pt-4">
<button onclick="saveLoan()" class="bg-green-600 text-white px-6 py-3 rounded-xl">
บันทึกข้อมูล
</button>
</div>

</div>

<script>
/* ================= SUPABASE ================= */
const sb = window.supabase.createClient(
  'https://ttottijljxoinptmhgtu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
);

/* ================= LOAD MEMBER ================= */
async function loadMember(){
const id = member_id.value;
if(!id) return alert('กรอกเลขสมาชิก');

const {data,error} = await sb
  .from('members')
  .select('*')
  .eq('member_id', id)
  .single();

if(error || !data) return alert('ไม่พบสมาชิก');

full_name.value = (data.first_name||'') + ' ' + (data.last_name||'');
phone.value = data.phone || '';
group.value = data.group || '';

house_no.value = data.house_no || '';
moo.value = data.moo || '';
village.value = data.village || '';
street.value = data.street || '';
subdistrict.value = data.subdistrict || '';
district.value = data.district || '';
province.value = data.province || '';
postal_code.value = data.postal_code || '';
}

/* ================= COPY ADDRESS ================= */
function copyAddress(){
c_house_no.value = house_no.value;
c_moo.value = moo.value;
c_village.value = village.value;
c_street.value = street.value;
c_subdistrict.value = subdistrict.value;
c_district.value = district.value;
c_province.value = province.value;
c_postal_code.value = postal_code.value;
}

/* ================= PURPOSE CHANGE ================= */
function handlePurposeChange(){
const purpose = loan_purpose.value;
const box = document.getElementById('other_purpose_box');

if(purpose === 'other'){
  box.classList.remove('hidden');
}else{
  box.classList.add('hidden');
  other_purpose_text.value = '';
}
}

/* ================= SAVE ================= */
async function saveLoan(){
const purposeValue =
loan_purpose.value === 'other'
? other_purpose_text.value
: loan_purpose.value;

const payload = {
member_id: member_id.value,
loan_type: loan_type.value,
purpose: purposeValue,
house_no: house_no.value,
current_house_no: c_house_no.value
};

const {error} = await sb.from('loan_requests').insert(payload);

if(error) alert('บันทึกไม่สำเร็จ');
else alert('บันทึกสำเร็จ');
}
</script>

</body>
</html>
