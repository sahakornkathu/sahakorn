<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>แบบฟอร์มคำขอกู้เงิน</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-5xl mx-auto bg-white shadow-xl rounded-2xl p-6 space-y-6">
  <h1 class="text-2xl font-bold text-center">หนังสือคำขอกู้เงิน</h1>

  <!-- MEMBER SEARCH -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="font-semibold">เลขทะเบียนสมาชิก</label>
      <input id="member_id" class="w-full border p-2 rounded" placeholder="กรอก member_id" />
    </div>
    <div class="flex items-end">
      <button onclick="loadMember()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">ค้นหาสมาชิก</button>
    </div>
  </div>

  <!-- PERSONAL INFO -->
  <div class="border-t pt-4">
    <h2 class="font-bold text-lg mb-2">ข้อมูลส่วนบุคคล</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <input id="full_name" class="border p-2 rounded" placeholder="ชื่อ-นามสกุล" />
      <input id="group" class="border p-2 rounded" placeholder="กลุ่ม" />
      <input id="phone" class="border p-2 rounded" placeholder="โทรศัพท์" />
      <input id="id_card" class="border p-2 rounded" placeholder="บัตรประชาชน" />
      <input id="birthday" class="border p-2 rounded" placeholder="วันเกิด" />
      <input id="age" class="border p-2 rounded" placeholder="อายุ" />
    </div>
  </div>

  <!-- ADDRESS REGISTER -->
  <div>
    <h2 class="font-bold text-lg mb-2">ที่อยู่ตามทะเบียนบ้าน</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <input id="house_no" class="border p-2 rounded" placeholder="เลขที่บ้าน" />
      <input id="moo" class="border p-2 rounded" placeholder="หมู่" />
      <input id="village" class="border p-2 rounded" placeholder="หมู่บ้าน" />
      <input id="street" class="border p-2 rounded" placeholder="ถนน" />
      <input id="subdistrict" class="border p-2 rounded" placeholder="ตำบล" />
      <input id="district" class="border p-2 rounded" placeholder="อำเภอ" />
      <input id="province" class="border p-2 rounded" placeholder="จังหวัด" />
      <input id="postal_code" class="border p-2 rounded" placeholder="รหัสไปรษณีย์" />
    </div>
  </div>

  <!-- ADDRESS CURRENT -->
  <div class="border-t pt-4">
    <div class="flex justify-between items-center mb-2">
      <h2 class="font-bold text-lg">ที่อยู่ปัจจุบัน</h2>
      <button onclick="copyAddress()" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
        คัดลอกจากทะเบียนบ้าน
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <input id="c_house_no" class="border p-2 rounded" placeholder="เลขที่บ้าน" />
      <input id="c_moo" class="border p-2 rounded" placeholder="หมู่" />
      <input id="c_village" class="border p-2 rounded" placeholder="หมู่บ้าน" />
      <input id="c_street" class="border p-2 rounded" placeholder="ถนน" />
      <input id="c_subdistrict" class="border p-2 rounded" placeholder="ตำบล" />
      <input id="c_district" class="border p-2 rounded" placeholder="อำเภอ" />
      <input id="c_province" class="border p-2 rounded" placeholder="จังหวัด" />
      <input id="c_postal_code" class="border p-2 rounded" placeholder="รหัสไปรษณีย์" />
    </div>
  </div>

  <!-- LOAN INFO -->
  <div class="border-t pt-4">
    <h2 class="font-bold text-lg mb-2">ข้อมูลเงินกู้</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <select id="loan_type" class="border p-2 rounded" onchange="calcInstallment()">
        <option value="">ประเภทเงินกู้</option>
        <option value="emergency">ระยะฉุกเฉิน (ผ่อนรายเดือน)</option>
        <option value="short">ระยะสั้น (ผ่อนรายปี)</option>
        <option value="medium">ระยะปานกลาง (ผ่อนรายปี)</option>
        <option value="long">ระยะยาว (ผ่อนรายปี)</option>
      </select>

      <input id="loan_amount" class="border p-2 rounded" placeholder="จำนวนเงิน" oninput="calcInstallment()" />
      <input id="months" class="border p-2 rounded" placeholder="จำนวนงวด" oninput="calcInstallment()" />

      <input id="interest_rate" class="border p-2 rounded bg-gray-100" value="7.75" oninput="calcInstallment()" />

      <input id="monthly_pay" class="border p-2 rounded" placeholder="ยอดผ่อน (แก้ได้)" oninput="calcTableFromManual()" />

      <input id="purpose" class="border p-2 rounded md:col-span-2" placeholder="วัตถุประสงค์" />
    </div>
    <p class="text-sm text-gray-500 mt-1">* ระยะฉุกเฉิน = ผ่อนรายเดือน / อื่น ๆ = ผ่อนรายปี</p>
  </div>

  <!-- INSTALLMENT TABLE -->
  <div class="border-t pt-4">
    <h2 class="font-bold text-lg mb-2">ตารางผ่อนชำระ</h2>
    <div class="overflow-auto">
      <table class="w-full border text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">งวดที่</th>
            <th class="border p-2">ยอดชำระ</th>
            <th class="border p-2">ดอกเบี้ย</th>
            <th class="border p-2">เงินต้นคงเหลือ</th>
          </tr>
        </thead>
        <tbody id="installmentTable"></tbody>
      </table>
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="text-center">
    <button onclick="saveLoan()" class="bg-green-600 text-white px-6 py-3 rounded-xl">บันทึกคำขอกู้</button>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  'https://ttottijljxoinptmhgtu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
);

function getPeriodConfig() {
  const type = loan_type.value;
  if (type === 'emergency') {
    return { divisor: 12, label: 'เดือน' }; // รายเดือน
  }
  return { divisor: 1, label: 'ปี' }; // รายปี
}

function calcInstallment() {
  const amount = parseFloat(loan_amount.value) || 0;
  const periods = parseInt(months.value) || 0;
  const rate = (parseFloat(interest_rate.value) || 0) / 100;

  if (amount <= 0 || periods <= 0) return;

  const cfg = getPeriodConfig();

  const interestTotal = amount * rate * (periods / cfg.divisor);
  const totalPay = amount + interestTotal;
  const perPeriod = totalPay / periods;

  monthly_pay.value = perPeriod.toFixed(2);
  renderTable(perPeriod);
}

function calcTableFromManual() {
  const per = parseFloat(monthly_pay.value) || 0;
  if (per > 0) renderTable(per);
}

function renderTable(perPeriod) {
  const amount = parseFloat(loan_amount.value) || 0;
  const periods = parseInt(months.value) || 0;
  const rate = (parseFloat(interest_rate.value) || 0) / 100;
  const cfg = getPeriodConfig();

  const tbody = document.getElementById('installmentTable');
  tbody.innerHTML = '';

  let remain = amount;
  const periodRate = rate / cfg.divisor;

  for (let i = 1; i <= periods; i++) {
    const interest = remain * periodRate;
    const principal = perPeriod - interest;
    remain -= principal;
    if (remain < 0) remain = 0;

    tbody.innerHTML += `
      <tr>
        <td class="border p-2 text-center">${i}</td>
        <td class="border p-2 text-right">${perPeriod.toFixed(2)}</td>
        <td class="border p-2 text-right">${interest.toFixed(2)}</td>
        <td class="border p-2 text-right">${remain.toFixed(2)}</td>
      </tr>`;
  }
}

function copyAddress() {
  c_house_no.value = house_no.value;
  c_moo.value = moo.value;
  c_village.value = village.value;
  c_street.value = street.value;
  c_subdistrict.value = subdistrict.value;
  c_district.value = district.value;
  c_province.value = province.value;
  c_postal_code.value = postal_code.value;
}

async function saveLoan() {
  const payload = {
    member_id: member_id.value,
    loan_type: loan_type.value,
    loan_amount: loan_amount.value,
    periods: months.value,
    pay_per_period: monthly_pay.value,
    interest_rate: interest_rate.value,
    purpose: purpose.value,
    status: 'pending'
  };

  const { error } = await supabase.from('loan_requests').insert(payload);

  if (error) alert('บันทึกไม่สำเร็จ');
  else alert('บันทึกสำเร็จ');
}
</script>

</body>
</html>
