<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบสมาชิก</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
<div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-4">ระบบสมาชิก</h1>

  <form id="memberForm" class="grid grid-cols-2 gap-4 mb-6">
    <input name="first_name" placeholder="ชื่อ" class="border p-2 rounded" required>
    <input name="last_name" placeholder="นามสกุล" class="border p-2 rounded" required>
    <input name="house_no" placeholder="บ้านเลขที่" class="border p-2 rounded">
    <input name="village_no" placeholder="หมู่" class="border p-2 rounded">
    <input name="street" placeholder="ถนน" class="border p-2 rounded">
    <input name="village" placeholder="หมู่บ้าน" class="border p-2 rounded">
    <input name="sub_district" placeholder="ตำบล" class="border p-2 rounded">
    <input name="district" placeholder="อำเภอ" class="border p-2 rounded">
    <input name="province" placeholder="จังหวัด" class="border p-2 rounded">
    <input name="postal_code" placeholder="เลขไปรษณีย์" class="border p-2 rounded">
    <input name="phone" placeholder="เบอร์โทรศัพท์" class="border p-2 rounded">
    <input name="alt_phone" placeholder="เบอร์โทรศัพท์สำรอง" class="border p-2 rounded">
    <select name="gender" class="border p-2 rounded">
      <option value="">เลือกเพศ</option>
      <option value="ชาย">ชาย</option>
      <option value="หญิง">หญิง</option>
      <option value="อื่นๆ">อื่นๆ</option>
    </select>
    <select name="status" class="border p-2 rounded">
      <option value="Active">Active</option>
      <option value="Inactive">Inactive</option>
    </select>
    <button type="submit" class="col-span-2 bg-blue-500 text-white p-2 rounded">บันทึกสมาชิก</button>
  </form>

  <ul id="membersList" class="space-y-2"></ul>
</div>

<script>
const API_URL = "https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members";
let editId = null;

async function fetchMembers() {
  const res = await fetch(API_URL);
  const data = await res.json();
  const list = document.getElementById("membersList");
  list.innerHTML = data.map(m => `
    <li class="flex justify-between bg-gray-50 p-2 rounded border">
      <div>
        ${m.first_name} ${m.last_name} - ${m.phone} - ${m.status} - ${m.province}
      </div>
      <div>
        <button onclick="editMember('${m.id}')" class="bg-yellow-400 text-white px-2 rounded mr-2">แก้ไข</button>
        <button onclick="deleteMember('${m.id}')" class="bg-red-500 text-white px-2 rounded">ลบ</button>
      </div>
    </li>
  `).join('');
}

document.getElementById("memberForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const body = Object.fromEntries(formData.entries());
  const method = editId ? "PUT" : "POST";
  if(editId) body.id = editId;

  await fetch(API_URL, {
    method,
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body)
  });
  e.target.reset();
  editId = null;
  fetchMembers();
});

async function editMember(id) {
  const res = await fetch(API_URL);
  const members = await res.json();
  const member = members.find(m => m.id === id);
  if(!member) return;
  const form = document.getElementById("memberForm");
  for (const key in member) {
    if(form[key]) form[key].value = member[key] ?? "";
  }
  editId = id;
}

async function deleteMember(id) {
  if(!confirm("ต้องการลบสมาชิกนี้หรือไม่?")) return;
  await fetch(API_URL, {
    method: "DELETE",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ id })
  });
  fetchMembers();
}

fetchMembers();
</script>
</body>
</html>
