<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üèÉ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">üèÉ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</h1>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å Tag ID -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
      <h2 class="text-lg font-semibold mb-2">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Tag ID</h2>
      <form id="tagForm" class="flex space-x-2">
        <input id="tagInput" type="text" placeholder="‡πÉ‡∏™‡πà Tag ID"
          class="flex-1 border rounded-lg px-3 py-2 focus:outline-none">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </form>
      <p id="status" class="text-sm text-gray-600 mt-2"></p>
    </div>

    <!-- Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold mb-4">üìä Dashboard</h2>
      <div id="runner-list" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // üîπ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
    const SUPABASE_URL = "https://qokvocorqzmytchzylvk.supabase.co";   // üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFva3ZvY29ycXpteXRjaHp5bHZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDQ4MDQsImV4cCI6MjA3MjYyMDgwNH0.IvBeOvmIBvcfCMKRSR3Of914cQeah8zCD5QgJCCg8Zk";           // üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Public Anon Key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const FUNCTION_URL = "https://<PROJECT>.functions.supabase.co/rfid-reader"; // üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    const runnerList = document.getElementById("runner-list");
    const statusEl = document.getElementById("status");

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö
    async function loadRunners() {
      const { data, error } = await supabase
        .from("Runner")
        .select(`
          id,
          name,
          type,
          Record (lap)
        `);

      if (error) {
        console.error(error);
        return;
      }

      runnerList.innerHTML = "";
      data.forEach(runner => {
        const laps = runner.Record.length > 0
          ? Math.max(...runner.Record.map(r => r.lap))
          : 0;

        runnerList.innerHTML += `
          <div class="flex justify-between items-center border-b pb-2">
            <span class="font-medium">${runner.name} (${runner.type || "-"})</span>
            <span class="text-blue-600 font-bold">${laps} ‡∏£‡∏≠‡∏ö</span>
          </div>
        `;
      });
    }

    // Subscribe realtime update ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Record
    supabase
      .channel("runner-updates")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "Record" }, payload => {
        console.log("Realtime update:", payload);
        loadRunners();
      })
      .subscribe();

    // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏£‡∏≠‡∏Å Tag ID
    document.getElementById("tagForm").addEventListener("submit", async e => {
      e.preventDefault();
      const tagId = document.getElementById("tagInput").value.trim();
      if (!tagId) return;

      try {
        const resp = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ tag_id: tagId })
        });

        const result = await resp.json();
        if (result.error) {
          statusEl.textContent = "‚ùå " + result.error;
        } else {
          statusEl.textContent = `‚úÖ ${result.runner} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${result.lap}`;
          document.getElementById("tagInput").value = "";
        }
      } catch (err) {
        statusEl.textContent = "‚ùå Error: " + err.message;
      }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    loadRunners();
  </script>
</body>
</html>
