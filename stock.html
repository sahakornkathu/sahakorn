<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÉ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">
<div class="max-w-3xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">üèÉ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</h1>

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° scan Tag ID -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <input id="tagInput" type="text" placeholder="‡∏™‡πÅ‡∏Å‡∏ô Tag ID"
      class="w-full border rounded-lg px-3 py-2 focus:outline-none" autofocus>
    <p id="status" class="text-sm text-gray-600 mt-2"></p>
  </div>

  <!-- Dashboard -->
  <div class="bg-white p-4 rounded-lg shadow">
    <h2 class="text-lg font-semibold mb-4">üìä Dashboard</h2>
    <div id="runner-list" class="space-y-2"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://qokvocorqzmytchzylvk.supabase.co"; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFva3ZvY29ycXpteXRjaHp5bHZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDQ4MDQsImV4cCI6MjA3MjYyMDgwNH0.IvBeOvmIBvcfCMKRSR3Of914cQeah8zCD5QgJCCg8Zk";         // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const FUNCTION_URL = "https://qokvocorqzmytchzylvk.functions.supabase.co/rfid-reader"; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const runnerList = document.getElementById("runner-list");
const statusEl = document.getElementById("status");
const tagInput = document.getElementById("tagInput");

// ‡πÇ‡∏´‡∏•‡∏î Dashboard
async function loadRunners() {
  const { data, error } = await supabase.from("runner")
    .select(`id, name, type, record (lap)`);

  if (error) return console.error(error);

  runnerList.innerHTML = "";
  data.forEach(r => {
    const laps = r.record.length > 0 ? Math.max(...r.record.map(x=>x.lap)) : 0;
    runnerList.innerHTML += `
      <div class="flex justify-between items-center border-b pb-2">
        <span class="font-medium">${r.name} (${r.type || '-'})</span>
        <span class="text-blue-600 font-bold">${laps} ‡∏£‡∏≠‡∏ö</span>
      </div>
    `;
  });
}

// Handle scan Tag ID
tagInput.addEventListener("keyup", async e => {
  if (e.key === "Enter") {
    const tagId = tagInput.value.trim();
    if (!tagId) return;

    try {
      const resp = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({ tag_id: tagId })
      });
      const result = await resp.json();

      if (result.error) {
        statusEl.textContent = "‚ùå " + result.error;
      } else {
        statusEl.textContent = `‚úÖ ${result.runner} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${result.lap}`;
        tagInput.value = "";   // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á input
      }

      loadRunners(); // refresh Dashboard
    } catch (err) {
      statusEl.textContent = "‚ùå Error: " + err.message;
    }
  }
});

// ‡πÇ‡∏´‡∏•‡∏î Dashboard ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
loadRunners();
</script>
</body>
</html>
