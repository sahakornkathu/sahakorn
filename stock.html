<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supabase Profile & Order</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
  body { font-family: Arial; padding: 20px; }
  form { margin-bottom: 20px; }
  input, select { margin-bottom: 10px; padding: 5px; width: 200px; }
  button { padding: 5px 10px; }
  p { font-weight: bold; }
</style>
</head>
<body>

<h2>เพิ่มผู้ใช้ (Profile)</h2>
<form id="profileForm">
  <input type="text" id="userId" placeholder="User ID" required><br>
  <input type="text" id="prefix" placeholder="คำนำหน้า"><br>
  <input type="text" id="name" placeholder="ชื่อ" required><br>
  <input type="text" id="lastname" placeholder="นามสกุล" required><br>
  <input type="text" id="group" placeholder="กลุ่ม/แผนก"><br>
  <button type="submit">บันทึกผู้ใช้</button>
</form>
<p id="profileStatus"></p>

<hr>

<h2>สร้างคำสั่งซื้อ (Order)</h2>
<form id="orderForm">
  <select id="userSelect" required>
    <option value="">เลือกผู้ใช้</option>
  </select><br>
  <input type="number" id="price" placeholder="ราคา" required><br>
  <button type="submit">บันทึก Order</button>
</form>
<p id="orderStatus"></p>

<script>
  // ใส่ URL และ ANON KEY ของคุณ
  const supabaseUrl = "https://fxbcdfjsimnecrpsosov.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4YmNkZmpzaW1uZWNycHNvc292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODg4NjAsImV4cCI6MjA3MTY2NDg2MH0.3hWqTZfuj_lmJ3uKdx_1cas8nQEdRJ8e08l0EWJcN7w";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const profileForm = document.getElementById("profileForm");
  const profileStatus = document.getElementById("profileStatus");
  const orderForm = document.getElementById("orderForm");
  const orderStatus = document.getElementById("orderStatus");
  const userSelect = document.getElementById("userSelect");

  // โหลดผู้ใช้ไปยัง select
  async function loadUsers() {
    const { data, error } = await supabase.from("profile").select("*");
    if (!error) {
      userSelect.innerHTML = '<option value="">เลือกผู้ใช้</option>';
      data.forEach(user => {
        const option = document.createElement("option");
        option.value = user.userId;
        option.textContent = `${user.prefix || ''} ${user.name} ${user.lastname} (${user.group || ''})`;
        userSelect.appendChild(option);
      });
    }
  }

  loadUsers();

  // บันทึก Profile
  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = document.getElementById("userId").value;
    const prefix = document.getElementById("prefix").value;
    const name = document.getElementById("name").value;
    const lastname = document.getElementById("lastname").value;
    const group = document.getElementById("group").value;

    const { error } = await supabase.from("profile").insert([{ userId, prefix, name, lastname, "group": group }]);
    if (error) {
      profileStatus.textContent = "เกิดข้อผิดพลาด: " + error.message;
      profileStatus.style.color = "red";
    } else {
      profileStatus.textContent = "บันทึกผู้ใช้สำเร็จ!";
      profileStatus.style.color = "green";
      profileForm.reset();
      loadUsers();
    }
  });

  // บันทึก Order
  orderForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = userSelect.value;
    const price = parseFloat(document.getElementById("price").value);

    if (!userId) {
      orderStatus.textContent = "กรุณาเลือกผู้ใช้";
      orderStatus.style.color = "red";
      return;
    }

    // ดึงข้อมูลผู้ใช้
    const { data: userData, error: userError } = await supabase.from("profile").select("*").eq("userId", userId).single();
    if (userError || !userData) {
      orderStatus.textContent = "ไม่พบผู้ใช้";
      orderStatus.style.color = "red";
      return;
    }

    const { prefix, name, lastname, group } = userData;

    const { error } = await supabase.from("Order").insert([{ userId, prefix, name, lastname, "group": group, price }]);
    if (error) {
      orderStatus.textContent = "เกิดข้อผิดพลาด: " + error.message;
      orderStatus.style.color = "red";
    } else {
      orderStatus.textContent = "บันทึก Order สำเร็จ!";
      orderStatus.style.color = "green";
      orderForm.reset();
    }
  });
</script>

</body>
</html>
