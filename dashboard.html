<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üìä Dashboard ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 p-6">
<h1 class="text-2xl font-bold mb-4 text-center">üìä Dashboard ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

<div class="max-w-3xl mx-auto flex space-x-4 mb-4">
  <button data-type="TOP100MEN" class="tab bg-blue-500 text-white px-3 py-1 rounded">MEN</button>
  <button data-type="TOP100WOMEN" class="tab bg-pink-500 text-white px-3 py-1 rounded">WOMEN</button>
</div>

<div class="max-w-4xl mx-auto bg-white p-4 rounded-lg shadow">
  <div id="runner-list" class="space-y-2"></div>
</div>

<script>
const SUPABASE_URL = "https://qokvocorqzmytchzylvk.supabase.co";  // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFva3ZvY29ycXpteXRjaHp5bHZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDQ4MDQsImV4cCI6MjA3MjYyMDgwNH0.IvBeOvmIBvcfCMKRSR3Of914cQeah8zCD5QgJCCg8Zk";                     // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentType = "TOP100MEN";

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô HH:MM:SS
function formatDuration(ms) {
  let totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  totalSeconds %= 3600;
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

async function loadDashboard() {
  // ‡∏î‡∏∂‡∏á‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  const { data: runners, error: err1 } = await supabase
    .from("runner")
    .select("id, name, type")
    .eq("type", currentType);

  if (err1) return console.error(err1);

  // ‡∏î‡∏∂‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const { data: records, error: err2 } = await supabase
    .from("record")
    .select("runner_id, lap, start_time, finish_time");

  if (err2) return console.error(err2);

  // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const list = runners.map(r => {
    const recs = records.filter(x => x.runner_id === r.id);
    let totalTime = 0;
    let completedLaps = 0;
    recs.forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    return { ...r, recs, totalTime, completedLaps };
  });

  // ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô
  const finished = list
    .filter(r => r.completedLaps >= 4)
    .sort((a,b) => a.totalTime - b.totalTime)
    .map((r,i)=>({...r, rank: i+1}));

  const unfinished = list
    .filter(r => r.completedLaps < 4)
    .sort((a,b)=>b.completedLaps - a.completedLaps);

  const finalList = [...finished, ...unfinished];

  const runnerList = document.getElementById("runner-list");
  runnerList.innerHTML = "";

  finalList.forEach(r => {
    let lapsHtml = r.recs.sort((a,b)=>a.lap-b.lap).map(rec=>{
      let dur = "-";
      if (rec.start_time && rec.finish_time) {
        dur = formatDuration(new Date(rec.finish_time)-new Date(rec.start_time));
      }
      return `Lap ${rec.lap}: ${dur}`;
    }).join(", ");

    let rankText = r.rank ? `üèÜ ${r.rank}` : "-";
    let totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";

    runnerList.innerHTML += `<div class="border-b py-2 flex justify-between">
      <div>
        <div class="font-semibold">${r.name} (${r.type})</div>
        <div class="text-sm text-gray-600">${lapsHtml}</div>
      </div>
      <div class="text-right">
        ‡∏£‡∏≠‡∏ö ${r.completedLaps}/4<br>
        ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: ${totalTimeText}<br>
        ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ${rankText}
      </div>
    </div>`;
  });
}

loadDashboard();
</script>
</body>
</html>
