<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Race Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-center mb-6">üèÅ Dashboard - ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>
    
    <div id="ranking" class="overflow-x-auto bg-white shadow rounded-lg p-4">
      <table class="min-w-full text-center border border-gray-300">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
            <th class="px-4 py-2 border">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="px-4 py-2 border">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th class="px-4 py-2 border">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö</th>
            <th class="px-4 py-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
          </tr>
        </thead>
        <tbody id="rankingBody">
          <tr><td colspan="5" class="p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // --- ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    const SUPABASE_URL = "https://qokvocorqzmytchzylvk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFva3ZvY29ycXpteXRjaHp5bHZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDQ4MDQsImV4cCI6MjA3MjYyMDgwNH0.IvBeOvmIBvcfCMKRSR3Of914cQeah8zCD5QgJCCg8Zk";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadRanking() {
      try {
        const { data, error } = await supabase
          .from('record')
          .select('*');

        if (error) throw error;

        // ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏≤‡∏° userId
        const grouped = {};
        data.forEach(r => {
          if (!grouped[r.userId]) {
            grouped[r.userId] = {
              name: r.name,
              type: r.type,
              count: 0,
              lastTime: ''
            };
          }
          grouped[r.userId].count += Number(r.count);
          grouped[r.userId].lastTime = r.time;
        });

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array + ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° count
        const ranking = Object.values(grouped).sort((a, b) => b.count - a.count);

        const tbody = document.getElementById('rankingBody');
        tbody.innerHTML = ranking.map((r, i) => `
          <tr class="border hover:bg-gray-50">
            <td class="border px-4 py-2">${i + 1}</td>
            <td class="border px-4 py-2">${r.name}</td>
            <td class="border px-4 py-2">${r.type}</td>
            <td class="border px-4 py-2 font-bold">${r.count}</td>
            <td class="border px-4 py-2">${new Date(r.lastTime).toLocaleString()}</td>
          </tr>
        `).join('');

      } catch (err) {
        console.error(err);
        document.getElementById('rankingBody').innerHTML = `<tr><td colspan="5" class="p-4 text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    loadRanking();
    setInterval(loadRanking, 5000);
  </script>

</body>
</html>
