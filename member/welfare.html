<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
  body { font-family: "Prompt", sans-serif; background: #f3f4f6; padding: 20px; }
  .container { background: #fff; border-radius: 12px; max-width: 1000px; margin: 0 auto; padding: 20px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  h2 { color: #1e40af; margin-bottom: 20px; text-align: center; }
  .form-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
  input, select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; flex: 1 1 220px; font-size: 14px; }
  button { border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer; font-size: 14px; transition: all 0.2s ease-in-out; }

  .saveBtn { background: #3b82f6; color: white; font-weight: 500; }
  .saveBtn:hover { background: #2563eb; transform: translateY(-1px); }
  .view-btn { background: #6b7280; color: white; font-weight: 500; margin-left: 6px; }
  .view-btn:hover { background: #4b5563; transform: translateY(-1px); }
  .delete-btn { background: #dc2626; color: white; padding: 6px 10px; border-radius: 6px; }
  .delete-btn:hover { background: #b91c1c; }
  #printReportBtn { background:#059669; color:white; font-weight: 500; }
  #printReportBtn:hover { background:#047857; }

  td button { display: inline-flex; align-items: center; justify-content: center; gap: 4px; margin: 2px; vertical-align: middle; }

  #memberTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
  #memberTable th, #memberTable td { padding: 8px 10px; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
  #memberTable th { background: #e0e7ff; }

  .history-row { background: #f9fafb; display: none; }
  .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .history-table th, .history-table td { border: 1px solid #ddd; padding: 6px 8px; }
  .history-table th { background: #f1f5f9; }
</style>
</head>
<body>
<div class="container">
  <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

  <div class="form-group">
    <input type="text" id="searchMemberId" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...">
    <input type="text" id="searchName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•...">
    <input type="date" id="filterDateStart">
    <input type="date" id="filterDateEnd">
    <input type="text" id="filterGroup" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°...">
    <button id="printReportBtn">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <table id="memberTable">
    <thead>
      <tr>
        <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="memberBody"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// ===========================
async function loadMembers() {
  const { data, error } = await db
    .from('members')
    .select('member_id, title, first_name, last_name, group');

  if (error) { console.error(error); alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏î‡πâ"); return; }

  const tbody = document.getElementById("memberBody");
  tbody.innerHTML = "";
  data.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m.member_id}</td>
      <td>${m.title}${m.first_name} ${m.last_name}</td>
      <td>${m.group || '-'}</td>
      <td><input type="date" class="receiveDate"></td>
      <td><input type="number" class="amount" placeholder="0.00"></td>
      <td>
        <select class="note">
          <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏--</option>
          <option value="‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
          <option value="‡πÅ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÅ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
          <option value="‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
        </select>
      </td>
      <td>
        <div style="display:flex; gap:6px;">
          <button class="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="view-btn">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);

    const historyTr = document.createElement("tr");
    historyTr.classList.add("history-row");
    historyTr.innerHTML = `<td colspan="7"><div class="history"></div></td>`;
    tbody.appendChild(historyTr);
  });

  // ... (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ + ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç + ‡∏•‡∏ö) ‚Äî ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ...
}

// ===========================
loadMembers();

// ===========================
// ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏•‡πÇ‡∏Å‡πâ
// ===========================
document.getElementById("printReportBtn").addEventListener("click", async () => {
  const start = document.getElementById("filterDateStart").value;
  const end = document.getElementById("filterDateEnd").value;
  const group = document.getElementById("filterGroup").value.trim();

  if (!start || !end) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"); return; }

  const logoUrl = "https://upload.wikimedia.org/wikipedia/commons/6/6b/Thailand_emblem.png"; // üîÅ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

  let query = db.from("welfare")
    .select("member_id, receive_date, amount, note, members(title, first_name, last_name, group)")
    .gte("receive_date", start)
    .lte("receive_date", end);

  if (group) query = query.eq("members.group", group);

  const { data, error } = await query;
  if (error) { console.error(error); alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); return; }

  let reportWindow = window.open("", "_blank");
  let html = `
    <html>
    <head>
      <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
      <style>
        body { font-family: "Prompt", sans-serif; margin: 40px; }
        h2 { text-align: center; margin-bottom: 6px; }
        p { text-align: center; margin: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
        th { background: #e0e7ff; }
        .logo { width: 90px; display: block; margin: 0 auto 10px auto; }
        hr { border: 1px solid #ddd; margin-top: 15px; }
      </style>
    </head>
    <body>
      <img src="${logoUrl}" class="logo">
      <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
      <p>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${start} ‡∏ñ‡∏∂‡∏á ${end}</p>
      ${group ? `<p>‡∏Å‡∏•‡∏∏‡πà‡∏°: ${group}</p>` : ""}
      <hr>
      <table>
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(r => `
            <tr>
              <td>${r.receive_date}</td>
              <td>${r.member_id}</td>
              <td>${r.members?.title || ''}${r.members?.first_name || ''} ${r.members?.last_name || ''}</td>
              <td>${r.members?.group || '-'}</td>
              <td>${r.amount}</td>
              <td>${r.note}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    </body></html>
  `;

  reportWindow.document.write(html);
  reportWindow.print();
});
</script>
</body>
</html>
