<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
  body { font-family: "Prompt", sans-serif; background: #f3f4f6; padding: 20px; }
  .container { background: #fff; border-radius: 12px; max-width: 1100px; margin: 0 auto; padding: 20px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  h2 { color: #1e40af; margin-bottom: 20px; text-align: center; }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
  }
  .filter-bar select, .filter-bar input {
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  .filter-bar button {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: 0.2s;
  }
  .filter-btn { background: #2563eb; color: white; }
  .filter-btn:hover { background: #1d4ed8; }
  .print-btn { background: #0ea5e9; color: white; }
  .print-btn:hover { background: #0284c7; }

  /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: center; }
  th { background: #e0e7ff; }
  tr:nth-child(even) { background: #f9fafb; }
</style>
</head>
<body>
<div class="container">
  <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

  <!-- üîπ ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏á -->
  <div class="filter-bar">
    <select id="filterGroup">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
    </select>
    <input type="date" id="filterStartDate">
    <input type="date" id="filterEndDate">
    <button class="filter-btn" id="applyFilter">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="print-btn" id="printReport">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <!-- üîπ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
  <table id="reportTable">
    <thead>
      <tr>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let allData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

// ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô dropdown
async function loadGroups() {
  const { data, error } = await db.from("members").select("group").not("group", "is", null);
  if (!error && data.length) {
    const uniqueGroups = [...new Set(data.map(item => item.group))];
    const groupSelect = document.getElementById("filterGroup");
    uniqueGroups.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      groupSelect.appendChild(opt);
    });
  }
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• welfare + ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
async function loadData() {
  const { data, error } = await db
    .from("welfare")
    .select(`
      receive_date, amount, note,
      members:member_id (member_id, title, first_name, last_name, group)
    `)
    .order("receive_date", { ascending: false });

  if (error) {
    console.error(error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    return;
  }

  allData = data;
  renderTable(allData);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function renderTable(data) {
  const tbody = document.getElementById("reportBody");
  tbody.innerHTML = "";
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:gray;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  data.forEach(row => {
    const m = row.members;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.receive_date || '-'}</td>
      <td>${m.member_id || '-'}</td>
      <td>${m.title || ''}${m.first_name || ''} ${m.last_name || ''}</td>
      <td>${m.group || '-'}</td>
      <td>${row.amount || '-'}</td>
      <td>${row.note || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

// üîπ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
document.getElementById("applyFilter").addEventListener("click", () => {
  const group = document.getElementById("filterGroup").value;
  const start = document.getElementById("filterStartDate").value;
  const end = document.getElementById("filterEndDate").value;

  const filtered = allData.filter(row => {
    const inGroup = !group || row.members.group === group;
    const inDate =
      (!start || row.receive_date >= start) &&
      (!end || row.receive_date <= end);
    return inGroup && inDate;
  });

  renderTable(filtered);
});

// üîπ ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
document.getElementById("printReport").addEventListener("click", () => {
  const tableHTML = document.getElementById("reportTable").outerHTML;
  const group = document.getElementById("filterGroup").value || "‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°";
  const start = document.getElementById("filterStartDate").value || "-";
  const end = document.getElementById("filterEndDate").value || "-";

  const printWin = window.open("", "_blank");
  printWin.document.write(`
    <html><head><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
    <style>
      body { font-family: "Prompt", sans-serif; margin: 40px; }
      h2 { text-align: center; margin-bottom: 5px; }
      p { text-align: center; margin-bottom: 20px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
      th { background: #f1f5f9; }
    </style>
    </head><body>
      <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
      <p><b>‡∏Å‡∏•‡∏∏‡πà‡∏°:</b> ${group} | <b>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${start} ‡∏ñ‡∏∂‡∏á ${end}</p>
      ${tableHTML}
    </body></html>
  `);
  printWin.document.close();
  printWin.print();
});

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
loadGroups();
loadData();
</script>
</body>
</html>
