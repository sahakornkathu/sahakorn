<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
body { font-family:"Prompt",sans-serif; background:#f0f4f8; margin:20px; color:#333; }
h2 { text-align:center; color:#1e40af; margin-bottom:15px; }
form { max-width:950px; margin:auto; background:#fff; padding:20px 25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.08); }
input, select, button { padding:6px 10px; border:1px solid #ccc; border-radius:6px; font-size:14px; margin:5px 1%; }
button { cursor:pointer; background:#4a90e2; color:#fff; border:none; transition:0.2s; }
button:hover { background:#357abd; }
#resultCount { font-weight:500; margin-left:10px; }
table { border-collapse: collapse; width:100%; margin:20px auto; font-size:13px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
th, td { border:1px solid #e2e8f0; padding:6px 8px; text-align:center; }
th { background:#4a90e2; color:#fff; font-weight:500; }
tr:nth-child(even){ background:#f9fafb; }
tr:hover{ background:#edf2f7; }
button.edit { background:#4a90e2; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.delete { background:#f56565; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.edit:hover { background:#357abd; }
button.delete:hover { background:#c53030; }
#filterDiv { background:#fff; padding:12px 15px; border-radius:10px; max-width:950px; margin:25px auto 15px; box-shadow:0 4px 12px rgba(0,0,0,0.08); display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
#filterDiv input, #filterDiv select { padding:5px 8px; border:1px solid #ccc; border-radius:6px; font-size:13px; flex:1 1 150px; }
#filterDiv label { font-size:13px; color:#1e40af; margin:0 3px; }
.bottom-filters { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:5px; }
@media (max-width:768px){ #filterDiv{ flex-direction: column; align-items:flex-start; } .bottom-filters{ flex-direction: column; align-items:flex-start; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>

<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

<form id="welfareForm">
  <input list="membersList" id="memberSelect" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" required>
  <datalist id="membersList"></datalist>

  <input type="date" id="receiveDate" required>
  <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" required>
  <select id="note" required>
    <option value="">--‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏--</option>
    <option value="‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    <option value="‡πÅ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÅ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    <option value="‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
  </select>
  
  <div style="margin-top:10px;">
    <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button type="button" id="clearBtn">üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
  </div>
</form>

<h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</h2>
<table id="welfareTable">
  <thead>
    <tr>
      <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<span id="resultCount"></span>

<script>
const supabaseUrl = 'https://ttottijljxoinptmhgtu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let allMembers = [];
let editId = null;

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
async function loadMembers() {
  const { data, error } = await supabaseClient
    .from('members')
    .select('member_id, title, first_name, last_name, "group"');
  if(error) return alert(error.message);
  allMembers = data;
  const datalist = document.getElementById('membersList');
  datalist.innerHTML = '';
  allMembers.forEach(m=>{
    const option = document.createElement('option');
    option.value = `${m.member_id} | ${m.title || ''} ${m.first_name || ''} ${m.last_name || ''}`;
    datalist.appendChild(option);
  });
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£
async function loadWelfare() {
  const { data, error } = await supabaseClient
    .from('welfare')
    .select('*')
    .order('receive_date', { ascending:false });
  if(error) return alert(error.message);
  renderWelfare(data);
}

function renderWelfare(data) {
  const tbody = document.querySelector('#welfareTable tbody');
  tbody.innerHTML = '';
  data.forEach(item=>{
    const tr = document.createElement('tr');
    const member = allMembers.find(m=>m.member_id === item.member_id);
    const name = member ? `${member.title || ''} ${member.first_name || ''} ${member.last_name || ''}` : '';
    tr.innerHTML = `
      <td>${item.member_id}</td>
      <td>${name}</td>
      <td>${item.receive_date}</td>
      <td>${item.amount}</td>
      <td>${item.note}</td>
      <td><button class="edit" onclick="editWelfare('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      <td><button class="delete" onclick="deleteWelfare('${item.id}')">‡∏•‡∏ö</button></td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('resultCount').textContent = `‡∏û‡∏ö ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
document.getElementById('welfareForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const val = document.getElementById('memberSelect').value;
  const memberId = val.split('|')[0].trim();
  const receiveDate = document.getElementById('receiveDate').value;
  const amount = document.getElementById('amount').value;
  const note = document.getElementById('note').value;

  const obj = { member_id: memberId, receive_date: receiveDate, amount, note };

  let result;
  if(editId){
    result = await supabaseClient.from('welfare').update(obj).eq('id', editId);
  } else {
    result = await supabaseClient.from('welfare').insert(obj);
  }

  if(result.error) return alert(result.error.message);
  
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏¥‡∏•‡∏î‡πå
  editId = null;
  document.getElementById('welfareForm').reset();
  loadWelfare();
});

// ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏∏‡πà‡∏°
document.getElementById('clearBtn').addEventListener('click', ()=>{
  editId = null;
  document.getElementById('welfareForm').reset();
});

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
async function editWelfare(id){
  editId = id;
  const { data, error } = await supabaseClient.from('welfare').select('*').eq('id', id).single();
  if(error) return alert(error.message);
  const member = allMembers.find(m=>m.member_id===data.member_id);
  document.getElementById('memberSelect').value = `${data.member_id} | ${member ? member.title+' '+member.first_name+' '+member.last_name : ''}`;
  document.getElementById('receiveDate').value = data.receive_date;
  document.getElementById('amount').value = data.amount;
  document.getElementById('note').value = data.note;
}

// ‡∏•‡∏ö
async function deleteWelfare(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  const { error } = await supabaseClient.from('welfare').delete().eq('id', id);
  if(error) return alert(error.message);
  loadWelfare();
}

loadMembers().then(loadWelfare);
</script>
</body>
</html>
