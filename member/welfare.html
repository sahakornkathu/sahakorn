<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบสวัสดิการสมาชิก</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.input{width:100%;background:#020617;border:1px solid #334155;padding:8px;border-radius:8px;color:#fff}
.label{font-size:13px;color:#cbd5f5;margin-bottom:4px;display:block}
.btn{padding:8px 18px;border-radius:10px;font-weight:500}
.red{background:#dc2626}.gray{background:#475569}.green{background:#16a34a}.blue{background:#2563eb}
.filter-box{background:linear-gradient(135deg,#0f172a,#1e293b);padding:22px;border-radius:16px}
.filter-title{color:#38bdf8;font-size:22px;margin-bottom:18px}
.filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:16px}
.filter-actions{display:flex;justify-content:flex-end;gap:12px}
</style>
</head>

<body class="bg-slate-900 text-slate-100 p-6">
<div class="max-w-7xl mx-auto space-y-8">

<h1 class="text-2xl font-bold text-center text-green-400">
ระบบสวัสดิการสมาชิก
</h1>

<!-- ================= FORM ================= -->
<div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
<h2 class="font-bold text-yellow-400 mb-4">บันทึกสวัสดิการ</h2>

<form id="welfareForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">

<input id="member_id" class="input"type="number" inputmode="numeric" oninput="if(this.value.length>8)this.value=this.value.slice(0,8)"required>
<div><label class="label">คำนำหน้า</label><input id="title" class="input" readonly></div>
<div><label class="label">ชื่อ</label><input id="first_name" class="input" readonly></div>
<div><label class="label">นามสกุล</label><input id="last_name" class="input" readonly></div>
<div><label class="label">กลุ่ม</label><input id="group" class="input" readonly></div>

<div><label class="label">วันที่รับสวัสดิการ</label><input id="receive_date" type="date" class="input" required></div>
<!-- <div><label class="label">จำนวนเงิน</label><input id="amount" type="number" class="input" required></div> -->
<div>
  <label class="label">จำนวนเงิน</label>
  <select id="amount" class="input" required>
    <option value="">-- เลือกจำนวนเงิน --</option>
    <option value="500">500</option>
    <option value="2000">2,000</option>
    <option value="5000">5,000</option>
  </select>
</div>

<div>
  <label class="label">หมายเหตุ</label>
  <select id="remark" class="input" required>
    <option value="">-- เลือก --</option>
    <option value="ตนเองเสียชีวิต">ตนเองเสียชีวิต</option>
    <option value="บิดาเสียชีวิต">บิดาเสียชีวิต</option>
    <option value="มารดาเสียชีวิต">มารดาเสียชีวิต</option>
    <option value="คู่สมรสเสียชีวิต">คู่สมรสเสียชีวิต</option>
    <option value="รักษาพยาบาล">รักษาพยาบาล</option>
  </select>
</div>

<div class="col-span-full">
  <label class="label">บันทึกเพิ่มเติม</label>
  <textarea id="note" class="input"></textarea>
</div>

<div class="col-span-full flex justify-center gap-4 mt-2">
  <button class="btn green">บันทึก</button>
  <button type="reset" class="btn gray" onclick="clearEdit()">ล้างฟอร์ม</button>
</div>
</form>
</div>

<!-- ================= FILTER ================= -->
<div class="filter-box">
<h2 class="filter-title">ค้นหา / กรองข้อมูล</h2>

<div class="filter-grid">
  <div><label class="label">รหัสสมาชิก</label><input id="f_member_id" class="input"></div>
  <div><label class="label">กลุ่ม</label><input id="f_group" class="input"></div>
  <div>
    <label class="label">หมายเหตุ</label>
    <select id="f_remark" class="input">
      <option value="">ทั้งหมด</option>
      <option value="ตนเองเสียชีวิต">ตนเองเสียชีวิต</option>
      <option value="บิดาเสียชีวิต">บิดาเสียชีวิต</option>
      <option value="มารดาเสียชีวิต">มารดาเสียชีวิต</option>
    </select>
  </div>
</div>

<div class="filter-grid">
  <div><label class="label">วันที่ (จาก)</label><input id="f_date_from" type="date" class="input"></div>
  <div><label class="label">วันที่ (ถึง)</label><input id="f_date_to" type="date" class="input"></div>
</div>

<div class="filter-actions">
  <button class="btn gray" onclick="clearFilter()">ล้างตัวกรอง</button>
  <button class="btn green" onclick="exportExcel()">Export</button>
  <button class="btn blue" onclick="printReport()">Print</button>
</div>
</div>

<!-- ================= TABLE ================= -->
<div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
<h2 class="font-bold text-orange-400 mb-2">
รายการสวัสดิการ (<span id="resultCount">0</span>)
</h2>

<table class="w-full text-center text-sm">
<thead class="bg-slate-700">
<tr>
<th>รหัส</th>
<th>ชื่อ</th>
<th>กลุ่ม</th>
<th>วันที่รับ</th>
<th>จำนวนเงิน</th>
<th>หมายเหตุ</th>
<th>จัดการ</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div class="flex justify-center gap-4 mt-4">
<button class="btn gray" onclick="prevPage()">ก่อนหน้า</button>
<span id="pageInfo"></span>
<button class="btn gray" onclick="nextPage()">ถัดไป</button>
</div>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL='https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const COOP_LOGO_URL='https://ttottijljxoinptmhgtu.supabase.co/storage/v1/object/public/slips/logo.png'
const db=createClient(SUPABASE_URL,SUPABASE_KEY)

let allData=[], page=1, pageSize=10
let editing=false, editId=null

/* ===== ดึงข้อมูลสมาชิก ===== */
member_id.addEventListener('blur', async ()=>{
  const r=await db.from('members')
    .select('title,first_name,last_name,group')
    .eq('member_id',member_id.value).single()
  if(!r.data){Swal.fire('ไม่พบสมาชิก','','error');return}
  title.value=r.data.title
  first_name.value=r.data.first_name
  last_name.value=r.data.last_name
  group.value=r.data.group
})

/* ===== LOAD ===== */
async function load(){
  let q=db.from('welfare')
    .select('*, members(title,first_name,last_name,group)')
    .order('created_at',{ascending:false})

  if(f_member_id.value) q=q.eq('member_id',f_member_id.value)
  if(f_remark.value) q=q.eq('remark',f_remark.value)
  if(f_date_from.value) q=q.gte('receive_date',f_date_from.value)
  if(f_date_to.value) q=q.lte('receive_date',f_date_to.value)

  const r=await q
  let rowsData=r.data||[]

  if(f_group.value){
    rowsData=rowsData.filter(x=>(x.members&&x.members.group||'').includes(f_group.value))
  }

  allData=rowsData
  page=1
  resultCount.innerText=allData.length
  render()
}

/* ===== RENDER ===== */
function render(){
  rows.innerHTML=''
  const start=(page-1)*pageSize, end=page*pageSize
  for(let i=start;i<Math.min(end,allData.length);i++){
    const r=allData[i]
    rows.innerHTML+=
      '<tr>'+
      '<td>'+r.member_id+'</td>'+
      '<td>'+r.members.title+r.members.first_name+' '+r.members.last_name+'</td>'+
      '<td>'+r.members.group+'</td>'+
      '<td>'+r.receive_date+'</td>'+
      '<td>'+r.amount+'</td>'+
      '<td>'+r.remark+'</td>'+
      '<td>'+
      '<button class="text-blue-400" onclick="editRow('+i+')">แก้ไข </button> '+
      '<button class="text-red-400" onclick="del('+r.id+')">ลบ</button>'+
      '</td>'+
      '</tr>'
  }
  pageInfo.innerText='หน้า '+page+'/'+Math.max(1,Math.ceil(allData.length/pageSize))
}
window.nextPage=()=>{if(page*pageSize<allData.length){page++;render()}}
window.prevPage=()=>{if(page>1){page--;render()}}

/* ===== EDIT / DELETE ===== */
window.editRow = async i=>{
  if(!(await checkPassword())) return

  const r=allData[i]
  editing=true
  editId=r.id

  member_id.value=r.member_id
  receive_date.value=r.receive_date
  amount.value=r.amount
  remark.value=r.remark
  note.value=r.note||''
}

window.del = async id=>{
  if(!(await checkPassword())) return

  const ok = await Swal.fire({
    title:'ยืนยันการลบ?',
    showCancelButton:true
  })
  if(!ok.isConfirmed) return

  await db.from('welfare').delete().eq('id',id)
  Swal.fire('ลบแล้ว','','success')
  load()
}

window.clearEdit=()=>{editing=false;editId=null;welfareForm.reset()}

/* ===== SUBMIT (กันซ้ำ member_id + remark) ===== */
welfareForm.onsubmit=async e=>{
  e.preventDefault()
  const payload={
    member_id:member_id.value,
    receive_date:receive_date.value,
    amount:amount.value,
    remark:remark.value,
    note:note.value
  }
  if(!editing){
    const c=await db.from('welfare').select('id')
      .eq('member_id',payload.member_id)
      .eq('remark',payload.remark).maybeSingle()
    if(c.data){
      Swal.fire('บันทึกซ้ำไม่ได้','กรณีนี้มีข้อมูลแล้ว','warning');return
    }
    await db.from('welfare').insert([payload])
    Swal.fire('บันทึกสำเร็จ','','success')
  }else{
    await db.from('welfare').update(payload).eq('id',editId)
    Swal.fire('แก้ไขสำเร็จ','','success')
  }
  clearEdit(); load()
}

/* ===== FILTER EVENTS ===== */
;[f_member_id,f_group,f_remark,f_date_from,f_date_to]
  .forEach(el=>el.addEventListener('input',()=>{page=1;load()}))
window.clearFilter=()=>{
  f_member_id.value=f_group.value=f_remark.value=f_date_from.value=f_date_to.value=''
  load()
}

/* ===== EXPORT (แก้แล้ว: ไม่เอา members) ===== */
window.exportExcel=()=>{
  if(!allData.length){Swal.fire('ไม่มีข้อมูล','','warning');return}

  const exportData = allData.map(r=>({
    member_id: r.member_id,
    title: r.members?.title || '',
    first_name: r.members?.first_name || '',
    last_name: r.members?.last_name || '',
    group: r.members?.group || '',
    receive_date: r.receive_date,
    amount: r.amount,
    remark: r.remark,
    note: r.note || ''
  }))

  const ws=XLSX.utils.json_to_sheet(exportData)
  const wb=XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb,ws,'รายงานสวัสดิการ')
  XLSX.writeFile(wb,'รายงานสวัสดิการสมาชิก.xlsx')
}

/* ===== PRINT ===== */
function getFY(){
  const d=new Date(), y=d.getFullYear(), m=d.getMonth()+1
  return (m<4?y-1:y)+543
}
window.printReport=()=>{
  if(!allData.length){Swal.fire('ไม่มีข้อมูล','','warning');return}
  const fy=getFY()
  let body=''
  for(let i=0;i<allData.length;i++){
    const r=allData[i]
    body+='<tr><td>'+(i+1)+'</td><td>'+r.member_id+'</td><td>'+
      r.members.title+r.members.first_name+' '+r.members.last_name+
      '</td><td>'+r.members.group+'</td><td>'+r.receive_date+
      '</td><td>'+r.amount+'</td><td>'+r.remark+'</td></tr>'
  }
  const w=window.open('')
  w.document.write('<html><head><meta charset="UTF-8"><style>@page{margin:20mm}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:6px;text-align:center}</style></head><body>'+
  '<div style="text-align:center"><img src="'+COOP_LOGO_URL+'" width="80"><h2>รายงานสวัสดิการสมาชิก</h2>'+
  '<div><b>ประจำปี '+fy+'</b></div><div>1 เมษายน '+fy+' - 31 มีนาคม '+(fy+1)+'</div>'+
  '<div>รวม '+allData.length+' ราย</div></div>'+
  '<table><thead><tr><th>ลำดับ</th><th>รหัส</th><th>ชื่อ</th><th>กลุ่ม</th><th>วันที่</th><th>จำนวน</th><th>หมายเหตุ</th></tr></thead><tbody>'+
  body+'</tbody></table></body></html>')
  w.document.close(); w.print()
}

load()
// ตรวจสอบ password แก้ไขและลบ
  async function checkPassword(){
  const { value } = await Swal.fire({
    title: 'กรุณาใส่รหัสผ่าน',
    input: 'password',
    inputPlaceholder: 'รหัสผ่าน',
    showCancelButton: true,
    confirmButtonText: 'ยืนยัน',
    cancelButtonText: 'ยกเลิก'
  })

  if (!value) return false

  if (value !== '159357') {
    Swal.fire('รหัสผ่านไม่ถูกต้อง','','error')
    return false
  }

  return true
}

</script>

</body>
</html>
