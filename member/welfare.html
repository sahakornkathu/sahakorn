<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
  body { font-family:"Prompt",sans-serif; background:#f0f4f8; margin:20px; color:#333; }
  h2 { text-align:center; color:#1e40af; margin-bottom:15px; }
  form { max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  input, select, button { padding:6px 10px; margin:5px 0; border:1px solid #ccc; border-radius:6px; font-size:14px; }
  button { background:#4a90e2; color:#fff; border:none; cursor:pointer; transition:0.2s; }
  button:hover { background:#357abd; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  th, td { border:1px solid #e2e8f0; padding:8px; text-align:center; }
  th { background:#4a90e2; color:#fff; }
  tr:nth-child(even){ background:#f9fafb; }
  tr:hover{ background:#edf2f7; }
</style>
</head>
<body>

<h2>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

<form id="welfareForm">
  <label>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
  <select id="memberSelect" required>
    <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
  </select><br>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
  <input type="date" id="receiveDate" required><br>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
  <input type="number" id="amount" required><br>

  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
  <select id="note" required>
    <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•--</option>
    <option value="‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    <option value="‡πÅ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÅ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    <option value="‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
  </select><br>

  <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button type="button" id="clearBtn">üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
</form>

<h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</h2>
<table id="historyTable">
  <thead>
    <tr>
      <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
  // --- Supabase Initialization ---
  const supabaseUrl = 'https://ttottijljxoinptmhgtu.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ANON KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
   const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const memberSelect = document.getElementById('memberSelect');
  const welfareForm = document.getElementById('welfareForm');
  const clearBtn = document.getElementById('clearBtn');
  const historyTable = document.querySelector('#historyTable tbody');

  let editId = null;

  // --- Load Members ---
  async function loadMembers(){
    const { data, error } = await supabase
      .from('members')
      .select('member_id, title, first_name, last_name, "group"');

    if(error) return alert(error.message);

    memberSelect.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>';
    data.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.member_id;
      opt.textContent = `${m.title} ${m.first_name} ${m.last_name} (‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group})`;
      memberSelect.appendChild(opt);
    });
  }

  // --- Load Welfare History ---
  async function loadHistory(){
    const { data, error } = await supabase
      .from('welfare')
      .select('id, member_id, receive_date, amount, note, members(title, first_name, last_name, "group")');

    if(error) return alert(error.message);

    historyTable.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      const member = row.members ? `${row.members.title} ${row.members.first_name} ${row.members.last_name} (‡∏Å‡∏•‡∏∏‡πà‡∏° ${row.members.group})` : row.member_id;
      tr.innerHTML = `
        <td>${member}</td>
        <td>${row.receive_date}</td>
        <td>${row.amount}</td>
        <td>${row.note}</td>
        <td><button onclick="editRecord(${row.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        <td><button onclick="deleteRecord(${row.id})">‡∏•‡∏ö</button></td>
      `;
      historyTable.appendChild(tr);
    });
  }

  // --- Submit Form ---
  welfareForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const member_id = memberSelect.value;
    const receive_date = document.getElementById('receiveDate').value;
    const amount = document.getElementById('amount').value;
    const note = document.getElementById('note').value;

    if(!member_id || !receive_date || !amount || !note) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

    if(editId){
      // Update
      const { error } = await supabase
        .from('welfare')
        .update({ member_id, receive_date, amount, note })
        .eq('id', editId);
      if(error) return alert(error.message);
      editId = null;
    } else {
      // Insert
      const { error } = await supabase
        .from('welfare')
        .insert([{ member_id, receive_date, amount, note }]);
      if(error) return alert(error.message);
    }

    welfareForm.reset();
    loadHistory();
  });

  // --- Clear Form ---
  clearBtn.addEventListener('click', ()=> welfareForm.reset());

  // --- Edit Record ---
  async function editRecord(id){
    const { data, error } = await supabase
      .from('welfare')
      .select('*')
      .eq('id', id)
      .single();
    if(error) return alert(error.message);

    editId = id;
    memberSelect.value = data.member_id;
    document.getElementById('receiveDate').value = data.receive_date;
    document.getElementById('amount').value = data.amount;
    document.getElementById('note').value = data.note;
  }

  // --- Delete Record ---
  async function deleteRecord(id){
    if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) return;
    const { error } = await supabase
      .from('welfare')
      .delete()
      .eq('id', id);
    if(error) return alert(error.message);
    loadHistory();
  }

  // --- Initialize ---
  loadMembers();
  loadHistory();
</script>
</body>
</html>
