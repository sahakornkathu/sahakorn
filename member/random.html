<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏™‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="icon" href="data:,">

<style>
.spinBox{
  font-size:28px;
  font-weight:bold;
  height:110px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:16px;
  background:linear-gradient(45deg,#0ea5e9,#9333ea);
  color:white;
}
.glow{animation: glow 1s infinite alternate;}
@keyframes glow{
 from{box-shadow:0 0 10px #fff}
 to{box-shadow:0 0 30px #facc15}
}
</style>
</head>

<body class="bg-slate-900 text-white p-6">

<div class="max-w-3xl mx-auto space-y-6">

<h1 class="text-2xl text-center text-yellow-400 font-bold">
‡∏™‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà
</h1>

<div class="grid md:grid-cols-3 gap-3">
<select id="groupSel" class="text-black p-2 rounded">
<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
<option>1</option><option>2</option><option>3</option>
<option>4</option><option>5</option><option>6</option>
<option>7</option><option>8</option><option>9</option>
</select>

<select id="fiscalYear" class="text-black p-2 rounded"></select>

<input id="quota" class="text-black p-2 rounded" placeholder="‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
</div>

<button onclick="loadPool()" class="w-full bg-blue-600 p-3 rounded">
‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
</button>

<div id="spinBox" class="spinBox">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°</div>

<div class="flex justify-center">
<button onclick="randomMember()" class="bg-purple-600 px-10 py-4 rounded text-lg">
üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
</button>
</div>

<div id="remainBox" class="text-center text-sky-400"></div>

<div class="bg-slate-800 p-4 rounded-xl">
<h2 class="text-yellow-400 font-bold mb-3">‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß</h2>
<div id="winnerList"></div>
</div>

</div>

<script>
/* ===== SUPABASE CONNECT ===== */
const sb = supabase.createClient(
 'https://ttottijljxoinptmhgtu.supabase.co',
 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

let pool=[]
let lockPool=[]
let normalPool=[]
let winner=null

/* ===== LOAD YEAR ===== */
async function loadFiscalYear(){
 const {data}=await sb.from('member_meeting').select('fiscal_year')
 const years=[...new Set((data||[]).map(d=>d.fiscal_year))]
 fiscalYear.innerHTML='<option value="">‡∏õ‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>'
 years.forEach(y=> fiscalYear.innerHTML+=`<option>${y}</option>`)
}

/* ===== LOAD MEMBER ===== */
async function loadPool(){
 const g=groupSel.value
 const fy=fiscalYear.value
 if(!g||!fy) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏õ‡∏µ')

 const {data}=await sb.from('member_meeting')
 .select('*')
 .eq('meeting_type','‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°')
 .eq('group',g)
 .eq('fiscal_year',fy)

 pool=data||[]
 lockPool = pool.filter(m=>m.is_lock == true)
 normalPool = pool.filter(m=>m.is_lock != true)

 remainBox.innerText=`‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${pool.length} | Lock ${lockPool.length}`
 loadWinnerList()
}

/* ===== RANDOM ===== */
async function randomMember(){

 const q=parseInt(quota.value||0)
 if(!q) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤')

 const {data:used}=await sb.from('meeting_random')
 .select('member_id')
 .eq('group',groupSel.value)
 .eq('fiscal_year',fiscalYear.value)

 if((used||[]).length>=q) return alert('‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß')

 if(lockPool.length>0){
  winner=lockPool[Math.floor(Math.random()*lockPool.length)]
 }else{
  winner=normalPool[Math.floor(Math.random()*normalPool.length)]
 }

 if(!winner) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠')

 spinBox.innerText=winner.first_name+' '+winner.last_name
}

/* ===== SAVE ===== */
async function saveWinner(){

 const {data:dup}=await sb.from('meeting_random')
 .select('member_id')
 .eq('member_id',winner.member_id)
 .eq('group',winner.group)
 .eq('fiscal_year',fiscalYear.value)

 if(dup.length>0) return alert('‡∏ã‡πâ‡∏≥')

 await sb.from('meeting_random').insert([{
  member_id:winner.member_id,
  first_name:winner.first_name,
  last_name:winner.last_name,
  group:winner.group,
  fiscal_year:fiscalYear.value
 }])

 loadWinnerList()
}

/* ===== LIST ===== */
async function loadWinnerList(){
 const {data}=await sb.from('meeting_random')
 .select('*')
 .eq('group',groupSel.value)
 .eq('fiscal_year',fiscalYear.value)

 winnerList.innerHTML=''
 ;(data||[]).forEach(r=>{
  winnerList.innerHTML+=`
  <div class="flex justify-between bg-slate-700 p-2 rounded mb-2">
   <div>${r.first_name} ${r.last_name}</div>
  </div>`
 })
}

loadFiscalYear()
</script>

</body>
</html>
