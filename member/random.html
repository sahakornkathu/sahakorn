<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏™‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
.spinBox{
  font-size:28px;
  font-weight:bold;
  height:110px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:16px;
  background:linear-gradient(45deg,#0ea5e9,#9333ea);
  color:white;
  box-shadow:0 0 20px #38bdf8;
}
.glow{animation: glow 1s infinite alternate;}
@keyframes glow{
  from{box-shadow:0 0 10px #fff}
  to{box-shadow:0 0 30px #facc15}
}
</style>
</head>

<body class="bg-slate-900 text-white p-6">

<div class="max-w-3xl mx-auto space-y-6">

<h1 class="text-2xl text-center text-yellow-400 font-bold">
‡∏™‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà
</h1>

<div class="grid md:grid-cols-3 gap-3">
<select id="groupSel" class="text-black p-2 rounded">
<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
<option>1</option><option>2</option><option>3</option>
<option>4</option><option>5</option><option>6</option>
<option>7</option><option>8</option><option>9</option>
</select>

<select id="fiscalYear" class="text-black p-2 rounded"></select>

<input id="quota" class="text-black p-2 rounded"
 placeholder="‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
</div>

<button onclick="loadPool()"
 class="w-full bg-blue-600 p-3 rounded">
‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
</button>

<div id="spinBox" class="spinBox">
‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°
</div>

<div class="flex justify-center">
  <button onclick="randomMember()"
   class="bg-purple-600 px-10 py-4 rounded text-lg font-bold
          hover:bg-purple-700 shadow-lg transition">
   üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
  </button>
</div>

 <div class="flex justify-center mt-4">
  <button onclick="printWinnersReport()"
   class="bg-indigo-600 px-8 py-3 rounded text-lg font-bold
          hover:bg-indigo-700 shadow-lg transition">
   üßæ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
  </button>
</div>


<div id="remainBox" class="text-center text-sky-400"></div>

<!-- ===== LIST WINNER ===== -->
<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mt-4">
<h2 class="text-yellow-400 font-bold text-center mb-2">
‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
</h2>

<div id="winnerCount" class="text-center text-sky-400 mb-2"></div>

<table class="w-full text-center text-sm">
<thead class="bg-slate-700">
<tr>
<th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
<th>‡∏ä‡∏∑‡πà‡∏≠</th>
<th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
<th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="winnerRows"></tbody>
</table>
</div>

</div>

<script>
const sb = supabase.createClient(
'https://ttottijljxoinptmhgtu.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

let pool=[]
let winner=null

function toast(msg){
Swal.fire({
 toast:true,
 position:'top-end',
 icon:'success',
 title:msg,
 showConfirmButton:false,
 timer:1500
})
}

async function loadFiscalYear(){
 const {data} = await sb.from('member_meeting')
 .select('fiscal_year')

 const years=[...new Set(data.map(d=>d.fiscal_year))]
 fiscalYear.innerHTML='<option value="">‡∏õ‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>'
 years.forEach(y=>{
 fiscalYear.innerHTML+=`<option>${y}</option>`
 })
}

async function loadPool(){
 const g=groupSel.value
 const fy=fiscalYear.value
 if(!g||!fy) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏õ‡∏µ')

 const {data}=await sb.from('member_meeting')
 .select('*')
 .eq('meeting_type','‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°')
 .eq('group',g)
 .eq('fiscal_year',fy)

 const {data:used}=await sb.from('meeting_random')
 .select('member_id')
 .eq('fiscal_year',fy)

 const usedIds=used.map(u=>u.member_id)
 pool=data.filter(m=>!usedIds.includes(m.member_id))

 remainBox.innerText=`‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${pool.length} ‡∏Ñ‡∏ô`
 toast('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
 loadWinnerList()
}

async function randomMember(){
 if(pool.length==0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô')

 if(winner) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')

 const quotaNum=parseInt(quota.value||0)

 const {data:used}=await sb.from('meeting_random')
 .select('*')
 .eq('group',groupSel.value)
 .eq('fiscal_year',fiscalYear.value)

 if(quotaNum > 0 && used.length >= quotaNum){
  await Swal.fire({
    icon: 'warning',
    title: '‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß',
    html: `
      <div style="font-size:18px">
        ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß<br>
        <b>${quotaNum} ‡∏Ñ‡∏ô</b>
      </div>
    `,
    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
    confirmButtonColor: '#eab308'
  })
  return
}


 let box=document.getElementById('spinBox')
 box.classList.remove('glow')

 let t=0
 const iv=setInterval(()=>{
 const r=pool[Math.floor(Math.random()*pool.length)]
 box.innerText=r.first_name+' '+r.last_name
 t++
 if(t>20){
 clearInterval(iv)
 winner=r
 box.innerText=r.first_name+' '+r.last_name
 box.classList.add('glow')
 showPopup(r)
 }
 },150)
}

async function showPopup(r){
 const res=await Swal.fire({
 title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå?',
 html:`<b>${r.first_name} ${r.last_name}</b>`,
 showCancelButton:true,
 confirmButtonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
 cancelButtonText:'‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
 backdrop:false
 })

 if(!res.isConfirmed){
 winner=null
 spinBox.innerText='‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
 return
 }

 await sb.from('meeting_random').insert([{
 member_id:r.member_id,
 first_name:r.first_name,
 last_name:r.last_name,
 group:r.group,
 fiscal_year:fiscalYear.value
 }])

 toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß')
 winner=null
 loadPool()
}

async function loadWinnerList(){
 const g=groupSel.value
 const fy=fiscalYear.value
 if(!fy) return

 let q=sb.from('meeting_random').select('*')
 if(g) q=q.eq('group',g)
 if(fy) q=q.eq('fiscal_year',fy)

 const {data}=await q.order('member_id')

 winnerRows.innerHTML=''
 winnerCount.innerText=`‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏Ñ‡∏ô`

 data.forEach((r,i)=>{
 winnerRows.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${r.first_name}</td>
<td>${r.last_name}</td>
<td>
<button onclick="removeWinner(${r.id})"
 class="bg-red-600 px-2 py-1 rounded">
‡∏•‡∏ö
</button>
</td>
</tr>`
 })
}

async function removeWinner(id){
 const cf=await Swal.fire({
 title:'‡∏•‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
 showCancelButton:true
 })
 if(!cf.isConfirmed) return

 await sb.from('meeting_random').delete().eq('id',id)
 loadWinnerList()
}

loadFiscalYear()
 
// ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
 async function printWinnersReport(){
  const g = groupSel.value
  const fy = fiscalYear.value

  if(!g || !fy){
    Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô','','warning')
    return
  }

  const { data, error } = await sb
    .from('meeting_random')
    .select('*')
    .eq('group', g)
    .eq('fiscal_year', fy)
    .order('member_id')

  if(error){
    Swal.fire(error.message,'','error')
    return
  }

  if(!data || data.length === 0){
    Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','','info')
    return
  }

  const rowsHtml = data.map((r,i)=>`
<tr>
  <td>${i+1}</td>
  <td>${r.member_id} ${r.first_name} ${r.last_name}</td>
  <td style="text-align:left">${r.address || ''}</td>
  <td></td>
  <td></td>
</tr>
`).join('')

  const today = new Date().toLocaleDateString('th-TH')

  const html = `
<html>
<head>
<meta charset="UTF-8">
<style>
@page{ margin:20mm; }
body{
  font-family:"TH Sarabun New","Sarabun",sans-serif;
  font-size:20px;
  color:#000;
}
h2{
  text-align:center;
  margin-bottom:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid #000;
  padding:8px;
  text-align:center;
}
td:nth-child(3){ text-align:left }
td:nth-child(4){ height:45px }
td:nth-child(5){ height:45px }
</style>
</head>

<body>
<h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà</h2>

<div style="text-align:center">
‡∏Å‡∏•‡∏∏‡πà‡∏° ${g} | ‡∏õ‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${fy}<br>
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today}
</div>

<table>
<thead>
<tr>
  <th style="width:50px">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
  <th style="width:240px">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
  <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
  <th style="width:120px">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
  <th style="width:180px">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</th>
</tr>
</thead>
<tbody>
${rowsHtml}
</tbody>
</table>

</body>
</html>
`

  const w = window.open('')
  w.document.write(html)
  w.document.close()
  w.print()
}


</script>

</body>
</html>
