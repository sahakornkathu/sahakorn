<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸ªà¸¸à¹ˆà¸¡à¸ªà¸¡à¸²à¸Šà¸´à¸à¸›à¸£à¸°à¸Šà¸¸à¸¡à¹ƒà¸«à¸à¹ˆ</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-6">

<div class="max-w-3xl mx-auto space-y-6">

<h1 class="text-2xl text-center text-yellow-400 font-bold">
ğŸ¯ à¸ªà¸¸à¹ˆà¸¡à¸ªà¸¡à¸²à¸Šà¸´à¸à¸›à¸£à¸°à¸Šà¸¸à¸¡à¹ƒà¸«à¸à¹ˆ
</h1>

<div class="bg-slate-800 p-6 rounded-xl space-y-4">

<select id="group" class="w-full p-2 text-black rounded">
<option value="">à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¸à¹ˆà¸¡</option>
<option>1</option><option>2</option><option>3</option>
<option>4</option><option>5</option><option>6</option>
<option>7</option><option>8</option><option>9</option>
</select>

<select id="year" class="w-full p-2 text-black rounded"></select>

<button onclick="randomMember()"
class="w-full bg-yellow-500 text-black py-2 rounded font-bold">
à¸ªà¸¸à¹ˆà¸¡
</button>

<div id="result" class="text-center text-xl mt-4"></div>

</div>
</div>

<script>
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* ===== LOAD YEAR ===== */
async function loadYear(){
  const { data } = await db
    .from('member_meeting')
    .select('fiscal_year')

  const years = [...new Set((data||[]).map(d=>d.fiscal_year))]
  year.innerHTML = years.map(y=>`<option>${y}</option>`).join('')
}

/* ===== RANDOM ===== */
async function randomMember(){

  if(!group.value || !year.value){
    Swal.fire('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¸à¹ˆà¸¡à¹à¸¥à¸°à¸›à¸µà¸šà¸±à¸à¸Šà¸µ')
    return
  }

  /* à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œ */
  const { data: members } = await db
    .from('member_meeting')
    .select('*')
    .eq('meeting_type','à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸à¸¥à¸¸à¹ˆà¸¡')
    .eq('fiscal_year',year.value)
    .eq('group',group.value)

  if(!members || members.length === 0){
    Swal.fire('à¹„à¸¡à¹ˆà¸à¸šà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­')
    return
  }

  /* à¸„à¸™à¸—à¸µà¹ˆà¹€à¸„à¸¢à¸ªà¸¸à¹ˆà¸¡à¹à¸¥à¹‰à¸§ */
  const { data: used } = await db
    .from('member_random')
    .select('member_id')
    .eq('fiscal_year',year.value)
    .eq('group',group.value)

  const usedIds = (used || []).map(u=>u.member_id)

  const available = members.filter(m=>!usedIds.includes(m.member_id))

  if(available.length === 0){
    Swal.fire('à¸à¸¥à¸¸à¹ˆà¸¡à¸™à¸µà¹‰à¸–à¸¹à¸à¸ªà¸¸à¹ˆà¸¡à¸„à¸£à¸šà¹à¸¥à¹‰à¸§')
    return
  }

  const pick = available[Math.floor(Math.random()*available.length)]

  const confirm = await Swal.fire({
    title:'à¸¢à¸·à¸™à¸¢à¸±à¸™à¸œà¸¥à¸ªà¸¸à¹ˆà¸¡?',
    html:`${pick.first_name} ${pick.last_name}`,
    showCancelButton:true
  })

  if(!confirm.isConfirmed) return

  await db.from('member_random').insert([{
    member_id:pick.member_id,
    title:pick.title,
    first_name:pick.first_name,
    last_name:pick.last_name,
    group:pick.group,
    fiscal_year:pick.fiscal_year
  }])

  result.innerHTML =
  `ğŸ‰ ${pick.first_name} ${pick.last_name}`
}

loadYear()
</script>

</body>
</html>
