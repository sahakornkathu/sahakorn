<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏™‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.spin{
  animation: spin 0.2s linear infinite;
}
@keyframes spin{
  from{transform:rotate(0)}
  to{transform:rotate(360deg)}
}
</style>
</head>

<body class="bg-slate-900 text-white p-6">

<div class="max-w-xl mx-auto space-y-4">

<h1 class="text-2xl text-center text-yellow-400 font-bold">
‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà
</h1>

<select id="fiscal_year" class="w-full p-2 rounded text-black"></select>

<select id="group" class="w-full p-2 rounded text-black">
<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
<option>1</option><option>2</option><option>3</option>
<option>4</option><option>5</option><option>6</option>
<option>7</option><option>8</option><option>9</option>
</select>

<input id="quota" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå"
class="w-full p-2 rounded text-black">

<button onclick="randomMember()"
class="w-full bg-yellow-500 p-2 rounded font-bold">
‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
</button>

<div id="result" class="text-center text-xl mt-4"></div>

</div>

<script>
const db = supabase.createClient(
'https://ttottijljxoinptmhgtu.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

async function loadYears(){
  const { data } = await db
  .from('member_meeting')
  .select('fiscal_year')

  const years=[...new Set(data.map(d=>d.fiscal_year))]
  fiscal_year.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>'
  years.forEach(y=>{
    fiscal_year.innerHTML+=`<option>${y}</option>`
  })
}
loadYears()

async function randomMember(){

if(!fiscal_year.value || !group.value || !quota.value){
  Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö')
  return
}

const { data } = await db
.from('member_meeting')
.select('*')
.eq('meeting_type','‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°')
.eq('group',group.value)
.eq('fiscal_year',parseInt(fiscal_year.value))

if(!data.length){
  Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠')
  return
}

const { data:used } = await db
.from('meeting_random')
.select('member_id')
.eq('fiscal_year',parseInt(fiscal_year.value))

const usedIds = used.map(u=>u.member_id)
const pool = data.filter(m=>!usedIds.includes(m.member_id))

if(!pool.length){
  Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°')
  return
}

result.innerHTML='üé≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°...'
let i=0
const interval=setInterval(()=>{
  const r = pool[Math.floor(Math.random()*pool.length)]
  result.innerHTML = r.first_name
  i++
  if(i>25){
    clearInterval(interval)
    confirmSave(r)
  }
},200)
}

async function confirmSave(member){

const ok = await Swal.fire({
title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?',
text:member.first_name+' '+member.last_name,
showCancelButton:true
})

if(!ok.isConfirmed) return

await db.from('meeting_random').insert([{
member_id:member.member_id,
first_name:member.first_name,
last_name:member.last_name,
group:member.group,
fiscal_year:member.fiscal_year
}])

Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß')
}
</script>
</body>
</html>
