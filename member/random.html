<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สุ่มสมาชิกประชุมใหญ่</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.roll{
  font-size:28px;
  font-weight:bold;
  animation:pulse .4s infinite;
}
@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.1)}
  100%{transform:scale(1)}
}
</style>
</head>

<body class="bg-slate-900 text-white p-6">

<div class="max-w-xl mx-auto space-y-6">

<h1 class="text-2xl text-center text-yellow-400 font-bold">
สุ่มสมาชิกเข้าประชุมใหญ่
</h1>

<div class="bg-slate-800 p-6 rounded-xl space-y-4">

<select id="group_no" class="w-full p-2 text-black rounded">
<option value="">เลือกกลุ่ม</option>
<option>1</option><option>2</option><option>3</option>
<option>4</option><option>5</option><option>6</option>
<option>7</option><option>8</option><option>9</option>
</select>

<select id="year" class="w-full p-2 text-black rounded"></select>

<button onclick="randomOne()"
 class="w-full bg-yellow-500 py-2 rounded text-black font-bold">
สุ่ม 1 คน
</button>

<div id="result" class="text-center text-xl"></div>

</div>

</div>

<script>
const db = supabase.createClient(
'https://ttottijljxoinptmhgtu.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

const yearSelect = document.getElementById('year')
const result = document.getElementById('result')

/* ===== LOAD YEAR ===== */
async function loadYears(){
  const {data} = await db
    .from('member_meeting')
    .select('fiscal_year')

  const years=[...new Set(data.map(d=>d.fiscal_year))]
  yearSelect.innerHTML='<option value="">เลือกปีบัญชี</option>'
  years.sort((a,b)=>b-a).forEach(y=>{
    yearSelect.innerHTML+=`<option>${y}</option>`
  })
}
loadYears()

/* ===== ANIMATION ===== */
function rollAnimation(list){
  return new Promise(resolve=>{
    let rolling=setInterval(()=>{
      const r=list[Math.floor(Math.random()*list.length)]
      result.innerHTML=`<div class="roll">${r.first_name}</div>`
    },80)

    setTimeout(()=>{
      clearInterval(rolling)
      resolve()
    },5000)
  })
}

/* ===== RANDOM ONE ===== */
async function randomOne(){

  const group_no = document.getElementById('group_no').value
  const year = yearSelect.value

  if(!group_no || !year){
    Swal.fire('เลือกกลุ่มและปีบัญชี')
    return
  }

  // คนที่มาประชุมกลุ่ม
  const {data:members} = await db
    .from('member_meeting')
    .select('*')
    .eq('meeting_type','ประชุมกลุ่ม')
    .eq('fiscal_year',year)
    .eq('group',group_no)

  // คนที่ถูกสุ่มไปแล้ว
  const {data:used} = await db
    .from('member_random')
    .select('member_id')
    .eq('fiscal_year',year)
    .eq('group_no',group_no)

  const usedIds=(used||[]).map(u=>u.member_id)
  const available=members.filter(m=>!usedIds.includes(m.member_id))

  if(!available.length){
    Swal.fire('ไม่มีรายชื่อให้สุ่ม')
    return
  }

  await rollAnimation(available)

  const pick = available[Math.floor(Math.random()*available.length)]

  const confirm = await Swal.fire({
    title:'ยืนยัน?',
    html:`${pick.member_id} ${pick.first_name} ${pick.last_name}`,
    showCancelButton:true
  })

  if(!confirm.isConfirmed) return

  const {error} = await db.from('member_random').insert([{
    member_id:pick.member_id,
    title:pick.title,
    first_name:pick.first_name,
    last_name:pick.last_name,
    group_no:pick.group,
    fiscal_year:pick.fiscal_year
  }])

  if(error){
    Swal.fire(error.message)
    return
  }

  result.innerHTML=`
  <div class="text-green-400 font-bold">
  ${pick.member_id} ${pick.first_name} ${pick.last_name}
  </div>`
}
</script>
</body>
</html>
