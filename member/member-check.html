<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- BLOCK NON LIFF -->
<div id="blockBrowser" class="hidden fixed inset-0 bg-black flex items-center justify-center text-center p-6">
  <div>
    <div class="text-2xl font-bold mb-3">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å Browser</div>
    <div class="text-slate-400">
      ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    </div>
  </div>
</div>

<!-- SEARCH -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-xl px-4 py-2 text-black"
    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
    oninput="resetAndRender()">
</div>

<!-- SUMMARY -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="totalCount" class="text-2xl font-bold">0</div>
    <div class="text-sm text-slate-400">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="memberCount" class="text-2xl font-bold text-green-400">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="associateCount" class="text-2xl font-bold text-blue-400">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
  </div>
</div>

<!-- MAP -->
<div class="px-4">
  <div id="map" class="h-72 rounded-xl"></div>
</div>

<!-- CARDS -->
<div id="cardList" class="p-4 space-y-3"></div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 10
let map, markers = []
let myGroup = null
let isSuperAdmin = false

/* ================= INIT ================= */
async function init(){

  // ‚ùå Block Browser
  if (!window.liff) {
    document.getElementById('blockBrowser').classList.remove('hidden')
    return
  }

  await liff.init({ liffId: LIFF_ID })

  if (!liff.isLoggedIn()) {
    liff.login()
    return
  }

  if (!liff.isInClient()) {
    document.getElementById('blockBrowser').classList.remove('hidden')
    return
  }

  const profile = await liff.getProfile()

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', profile.userId)
    .maybeSingle()

  if (!admin || admin.approve_status !== 'approved') {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á')
    return
  }

  if (admin.position === 'SUPER_ADMIN') {
    isSuperAdmin = true
  } else {
    myGroup = admin.position.match(/\d+/)?.[0]
  }

  initMap()
  loadMembers()
}

/* ================= MAP ================= */
function initMap(){
  map = L.map('map').setView([13.7, 100.5], 11)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
}

function renderMarkers(){
  markers.forEach(m => map.removeLayer(m))
  markers = []

  allMembers.forEach(m => {
    if (m.lat && m.lng) {
      markers.push(
        L.marker([m.lat, m.lng])
          .addTo(map)
          .bindPopup(`${m.member_id}<br>${m.first_name} ${m.last_name}`)
      )
    }
  })
}

/* ================= LOAD ================= */
async function loadMembers(){
  let query = supabaseClient
    .from('members')
    .select(`
      member_id,
      title,
      first_name,
      last_name,
      group,
      house_no,
      moo,
      subdistrict,
      district,
      province,
      phone,
      member_status,
      lat,
      lng
    `)
    .in('member_status', ['‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å','‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö'])

  if (!isSuperAdmin) {
    query = query.eq('group', myGroup)
  }

  const { data, error } = await query

  if (error) {
    alert(error.message)
    return
  }

  // ‚≠ê SORT 100%
  allMembers = data.sort((a,b)=>Number(a.member_id)-Number(b.member_id))

  updateSummary()
  renderMarkers()
  resetAndRender()
}

/* ================= SUMMARY ================= */
function updateSummary(){
  totalCount.innerText = allMembers.length
  memberCount.innerText = allMembers.filter(m=>m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length
  associateCount.innerText = allMembers.filter(m=>m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö').length
}

/* ================= RENDER ================= */
function resetAndRender(){
  renderIndex = 0
  cardList.innerHTML = ''
  renderMore()
}

function renderMore(){
  const kw = searchInput.value.toLowerCase()

  const list = allMembers
    .filter(m =>
      m.member_id.toString().includes(kw) ||
      m.first_name.toLowerCase().includes(kw) ||
      m.last_name.toLowerCase().includes(kw)
    )
    // ‚≠ê SORT AGAIN (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏∏‡∏î)
    .sort((a,b)=>Number(a.member_id)-Number(b.member_id))

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    cardList.innerHTML += `
      <div class="bg-slate-800 rounded-xl p-4 space-y-2">
        <div class="flex justify-between">
          <div class="font-bold text-lg">
            ${m.member_id} ¬∑ ${m.title}${m.first_name} ${m.last_name}
          </div>
          <span class="text-xs px-2 py-1 rounded bg-slate-700">
            ${m.member_status}
          </span>
        </div>

        <div class="text-sm text-slate-400">
          ‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group} ¬∑ üìç ${m.house_no || '-'} ‡∏°.${m.moo || '-'}
        </div>

        <div class="flex gap-2">
          <button onclick="pinGPS(${m.member_id})"
            class="flex-1 bg-blue-600 rounded py-1">
            üìç ‡∏õ‡∏±‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î
          </button>
          <span class="flex-1 text-center text-xs rounded py-1
            ${m.lat ? 'bg-emerald-700' : 'bg-red-700'}">
            ${m.lat ? 'üìç ‡∏õ‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å'}
          </span>
        </div>

        <a href="tel:${m.phone}" class="block text-green-400 font-bold">
          üìû ${m.phone}
        </a>
      </div>
    `
  })

  renderIndex += PAGE_SIZE
}

/* ================= GPS ================= */
function pinGPS(memberId){
  navigator.geolocation.getCurrentPosition(async pos => {
    await supabaseClient
      .from('members')
      .update({
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      })
      .eq('member_id', memberId)

    loadMembers()
  })
}

/* ================= SCROLL ================= */
window.addEventListener('scroll',()=>{
  if(innerHeight+scrollY>=document.body.offsetHeight-200){
    renderMore()
  }
})

init()
</script>
</body>
</html>
