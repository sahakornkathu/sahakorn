<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸²à¸Šà¸´à¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- SEARCH -->
<div class="sticky top-0 z-50 bg-slate-800 p-3">
  <input id="searchInput"
    class="w-full rounded-xl px-4 py-2 text-black"
    placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸²à¹€à¸¥à¸‚à¸ªà¸¡à¸²à¸Šà¸´à¸ / à¸Šà¸·à¹ˆà¸­"
    oninput="resetAndRender()">
</div>

<!-- SUMMARY -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="totalCount" class="text-2xl font-bold">0</div>
    <div class="text-sm text-slate-400">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="memberCount" class="text-2xl font-bold text-green-400">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="associateCount" class="text-2xl font-bold text-blue-400">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸—à¸š</div>
  </div>
</div>

<!-- MAP -->
<div class="px-4">
  <div id="map" class="h-72 rounded-xl"></div>
</div>

<!-- CARDS -->
<div id="cardList" class="p-4 space-y-3"></div>

<!-- MODAL MAP -->
<div id="mapModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-slate-800 rounded-xl w-[90%] h-[70%] p-3">
    <div class="flex justify-between mb-2">
      <div id="modalTitle" class="font-bold"></div>
      <button onclick="closeMap()" class="text-red-400">âœ•</button>
    </div>
    <div id="singleMap" class="h-full rounded"></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 10
let map, markers=[]

/* INIT */
async function init(){
  await liff.init({ liffId: LIFF_ID })
  if(!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()
  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', profile.userId)
    .maybeSingle()

  if(!admin || admin.approve_status!=='approved'){
    alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œ')
    return
  }

  const group = admin.position.match(/\d+/)[0]
  initMap()
  loadMembers(group)
}

/* MAP */
function initMap(){
  map = L.map('map').setView([13.7,100.5],12)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
}

function renderMarkers(){
  markers.forEach(m=>map.removeLayer(m))
  markers=[]
  allMembers.forEach(m=>{
    if(m.lat && m.lng){
      const mk=L.marker([m.lat,m.lng]).addTo(map)
        .bindPopup(`${m.member_id}<br>${m.first_name}`)
      markers.push(mk)
    }
  })
}

/* LOAD */
async function loadMembers(group){
  const { data } = await supabaseClient
    .from('members')
    .select('*')
    .eq('group',group)
    .in('member_status',['à¸ªà¸¡à¸²à¸Šà¸´à¸','à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š'])
    .order('member_id',{ascending:true})

  allMembers=data
  updateSummary()
  renderMarkers()
  resetAndRender()
}

/* SUMMARY */
function updateSummary(){
  totalCount.innerText=allMembers.length
  memberCount.innerText=allMembers.filter(m=>m.member_status==='à¸ªà¸¡à¸²à¸Šà¸´à¸').length
  associateCount.innerText=allMembers.filter(m=>m.member_status==='à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š').length
}

/* RENDER */
function resetAndRender(){
  renderIndex=0
  cardList.innerHTML=''
  renderMore()
}

function renderMore(){
  const kw=searchInput.value.toLowerCase()
  const list=allMembers.filter(m=>
    m.member_id.toString().includes(kw) ||
    m.first_name.toLowerCase().includes(kw) ||
    m.last_name.toLowerCase().includes(kw)
  )

  list.slice(renderIndex,renderIndex+PAGE_SIZE).forEach(m=>{
    cardList.innerHTML+=`
    <div class="bg-slate-800 rounded-xl p-4 space-y-2">
      <div class="font-bold">${m.member_id} Â· ${m.title}${m.first_name} ${m.last_name}</div>

      <input class="w-full bg-slate-700 rounded px-2 py-1"
        value="${m.house_no||''}"
        onchange="updateField(${m.member_id},'house_no',this.value)">

      <div class="flex gap-2">
        <button onclick="pinGPS(${m.member_id})"
          class="flex-1 bg-blue-600 rounded py-1">ğŸ“ à¸›à¸±à¸à¸à¸´à¸à¸±à¸”</button>
        <button onclick="openMap(${m.lat},${m.lng},'${m.first_name}')"
          class="flex-1 bg-emerald-600 rounded py-1">ğŸ—ºï¸ à¸”à¸¹à¹à¸œà¸™à¸—à¸µà¹ˆ</button>
      </div>

      <a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}"
        target="_blank"
        class="block text-center bg-slate-700 rounded py-1">ğŸ§­ à¸™à¸³à¸—à¸²à¸‡</a>

      <a href="tel:${m.phone}" class="text-green-400 font-bold block">ğŸ“ ${m.phone}</a>
    </div>`
  })
  renderIndex+=PAGE_SIZE
}

/* UPDATE */
async function updateField(id,field,value){
  await supabaseClient.from('members').update({[field]:value}).eq('member_id',id)
}

/* GPS */
function pinGPS(id){
  navigator.geolocation.getCurrentPosition(async pos=>{
    await supabaseClient.from('members')
      .update({lat:pos.coords.latitude,lng:pos.coords.longitude})
      .eq('member_id',id)
    loadMembers(allMembers[0].group)
  })
}

/* MODAL MAP */
let singleMap
function openMap(lat,lng,name){
  mapModal.classList.remove('hidden')
  modalTitle.innerText=name
  setTimeout(()=>{
    singleMap=L.map('singleMap').setView([lat,lng],16)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(singleMap)
    L.marker([lat,lng]).addTo(singleMap)
  },100)
}
function closeMap(){
  mapModal.classList.add('hidden')
  singleMap.remove()
}

window.addEventListener('scroll',()=>{
  if(innerHeight+scrollY>=document.body.offsetHeight-200){
    renderMore()
  }
})

init()
</script>
</body>
</html>
