<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- LINE LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

<div id="loading" class="text-center text-lg">
  ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...
</div>

<div id="noAccess" class="hidden text-center text-red-600 text-xl font-bold">
  ‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
</div>

<div id="content" class="hidden max-w-7xl mx-auto bg-white p-6 rounded-xl shadow">

  <h1 class="text-2xl font-bold mb-4">
    üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  </h1>

  <!-- Search -->
  <div class="mb-4">
    <input
      id="searchInput"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
      class="border rounded px-3 py-2 w-full max-w-md"
      oninput="renderTable()" />
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full border text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
          <th class="border p-2">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
          <th class="border p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="border p-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="border p-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
          <th class="border p-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
)

let members = []
let myGroup = null

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: LIFF_ID })

  if (!liff.isLoggedIn()) {
    liff.login()
    return
  }

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  /* ---- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£ ---- */
  const { data: admin, error } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  document.getElementById('loading').remove()

  if (!admin || admin.approve_status !== 'approved') {
    document.getElementById('noAccess').classList.remove('hidden')
    return
  }

  /* ---- ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ---- */
  myGroup = admin.position.match(/\d+/)?.[0]

  if (!myGroup) {
    document.getElementById('noAccess').classList.remove('hidden')
    return
  }

  document.getElementById('content').classList.remove('hidden')
  await loadMembers()
}

/* ================= LOAD MEMBERS ================= */
async function loadMembers() {
  const { data, error } = await supabaseClient
    .from('members')
    .select(`
      member_id,
      group,
      first_name,
      last_name,
      house_no,
      moo,
      street,
      village,
      subdistrict,
      district,
      province,
      postal_code,
      phone,
      member_status
    `)
    .eq('group', myGroup)
    .in('member_status', ['‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö'])
    .order('member_id', { ascending: true })

  if (error) {
    alert(error.message)
    return
  }

  members = data
  renderTable()
}

/* ================= ADDRESS ================= */
function buildAddress(m) {
  return [
    m.house_no && `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${m.house_no}`,
    m.moo && `‡∏´‡∏°‡∏π‡πà ${m.moo}`,
    m.village,
    m.street,
    m.subdistrict,
    m.district,
    m.province,
    m.postal_code
  ].filter(Boolean).join(' ')
}

/* ================= RENDER ================= */
function renderTable() {
  const keyword = document.getElementById('searchInput').value.toLowerCase()
  const tbody = document.getElementById('tableBody')
  tbody.innerHTML = ''

  members
    .filter(m =>
      m.member_id.toString().includes(keyword) ||
      (m.first_name || '').toLowerCase().includes(keyword) ||
      (m.last_name || '').toLowerCase().includes(keyword)
    )
    .forEach(m => {
      tbody.innerHTML += `
        <tr class="hover:bg-gray-50">
          <td class="border p-2 text-center">${m.member_id}</td>
          <td class="border p-2 text-center">${m.group}</td>
          <td class="border p-2">${m.first_name ?? ''}</td>
          <td class="border p-2">${m.last_name ?? ''}</td>
          <td class="border p-2 text-left">${buildAddress(m)}</td>
          <td class="border p-2">${m.phone ?? ''}</td>
        </tr>
      `
    })
}

init()
</script>

</body>
</html>
