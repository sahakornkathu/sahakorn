<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸²à¸Šà¸´à¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- SEARCH -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-xl px-4 py-2 text-black"
    placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸²à¹€à¸¥à¸‚à¸ªà¸¡à¸²à¸Šà¸´à¸ / à¸Šà¸·à¹ˆà¸­ / à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥"
    oninput="resetAndRender()">
</div>

<!-- SUMMARY -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="totalCount" class="text-2xl font-bold">0</div>
    <div class="text-sm text-slate-400">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="memberCount" class="text-2xl font-bold text-green-400">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="associateCount" class="text-2xl font-bold text-blue-400">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š</div>
  </div>
</div>

<!-- MAP -->
<div class="px-4">
  <div id="map" class="h-72 rounded-xl"></div>
</div>

<!-- CARDS -->
<div id="cardList" class="p-4 space-y-3"></div>

<!-- MODAL MAP -->
<div id="mapModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-slate-800 rounded-xl w-[90%] h-[70%] p-3">
    <div class="flex justify-between mb-2">
      <div id="modalTitle" class="font-bold"></div>
      <button onclick="closeMap()" class="text-red-400">âœ•</button>
    </div>
    <div id="singleMap" class="h-full rounded"></div>
  </div>
</div>

<script>
/* CONFIG */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 10
let map, markers = []
let currentGroup = null   // â­ FIX: à¹€à¸à¹‡à¸š group à¹„à¸§à¹‰à¸Šà¸±à¸” à¹†
let isSuperAdmin = false  // â­ FIX

/* INIT */
async function init(){

  // â­ à¸à¸±à¸™à¹€à¸›à¸´à¸”à¸ˆà¸²à¸ browser
  if (!liff.isInClient()) {
    alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸›à¸´à¸”à¸œà¹ˆà¸²à¸™ LINE à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™')
    return
  }

  await liff.init({ liffId: LIFF_ID })
  if(!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', profile.userId)
    .maybeSingle()

  if(!admin || admin.approve_status !== 'approved'){
    alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡')
    return
  }

  // â­ Super Admin
  if (admin.position === 'superadmin') {
    isSuperAdmin = true
    currentGroup = null
  } else {
    currentGroup = admin.position.match(/\d+/)?.[0]
  }

  initMap()
  loadMembers()
}

/* MAP */
function initMap(){
  map = L.map('map').setView([13.7, 100.5], 11)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
}

function renderMarkers(){
  markers.forEach(m => map.removeLayer(m))
  markers = []

  allMembers.forEach(m => {
    if(m.lat && m.lng){
      const mk = L.marker([m.lat, m.lng])
        .addTo(map)
        .bindPopup(`${m.member_id}<br>${m.first_name} ${m.last_name}`)
      markers.push(mk)
    }
  })
}

/* LOAD */
async function loadMembers(){

  let query = supabaseClient
    .from('members')
    .select(`
      member_id,
      title,
      first_name,
      last_name,
      group,
      house_no,
      moo,
      subdistrict,
      district,
      province,
      phone,
      member_status,
      lat,
      lng
    `)
    .in('member_status', ['à¸ªà¸¡à¸²à¸Šà¸´à¸','à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š'])
    .order('member_id', { ascending: true }) // â­ FIX

  if (!isSuperAdmin && currentGroup) {
    query = query.eq('group', currentGroup)
  }

  const { data, error } = await query
  if(error) return alert(error.message)

  // â­ à¸à¸±à¸™à¸à¸£à¸“à¸µ Supabase à¹€à¸£à¸µà¸¢à¸‡à¹„à¸¡à¹ˆà¸•à¸£à¸‡
  allMembers = data.sort((a,b) => a.member_id - b.member_id)

  updateSummary()
  renderMarkers()
  resetAndRender()
}

/* SUMMARY */
function updateSummary(){
  totalCount.innerText = allMembers.length
  memberCount.innerText = allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸').length
  associateCount.innerText = allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š').length
}

/* RENDER */
function resetAndRender(){
  renderIndex = 0
  cardList.innerHTML = ''
  renderMore()
}

function renderMore(){
  const kw = searchInput.value.toLowerCase()

  const list = allMembers.filter(m =>
    m.member_id.toString().includes(kw) ||
    m.first_name.toLowerCase().includes(kw) ||
    m.last_name.toLowerCase().includes(kw)
  )

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    cardList.innerHTML += `
    <div class="bg-slate-800 rounded-xl p-4 space-y-2">
      <div class="flex justify-between">
        <div class="font-bold text-lg">
          ${m.member_id} Â· ${m.title}${m.first_name} ${m.last_name}
        </div>
        <span class="text-xs px-2 py-1 rounded bg-slate-700">
          ${m.member_status}
        </span>
      </div>

      <div class="text-sm text-slate-400">
        ğŸ“ à¸à¸¥à¸¸à¹ˆà¸¡ ${m.group} Â· ${m.house_no || '-'} à¸¡.${m.moo || '-'} ${m.subdistrict}
      </div>

      <div class="flex gap-2">
        <button onclick="pinGPS(${m.member_id})"
          class="flex-1 bg-blue-600 rounded py-1">
          ğŸ“ à¸›à¸±à¸à¸à¸´à¸à¸±à¸”
        </button>

        <button onclick="openMap(${m.lat},${m.lng},'${m.first_name} ${m.last_name}')"
          class="flex-1 bg-emerald-600 rounded py-1">
          ğŸ—ºï¸ à¸”à¸¹à¹à¸œà¸™à¸—à¸µà¹ˆ
        </button>
      </div>

      <div class="text-xs">
        ${m.lat && m.lng ? 'ğŸ“ à¸›à¸±à¸à¹à¸¥à¹‰à¸§' : 'âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸›à¸±à¸'}
      </div>

      <a href="tel:${m.phone}" class="block text-green-400 font-bold">
        ğŸ“ ${m.phone}
      </a>
    </div>
    `
  })

  renderIndex += PAGE_SIZE
}

/* GPS */
function pinGPS(memberId) {

  if (!navigator.geolocation) {
    alert('à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š GPS')
    return
  }

  // âœ… à¹€à¸£à¸µà¸¢à¸à¸•à¸£à¸‡à¸ˆà¸²à¸à¸›à¸¸à¹ˆà¸¡ (à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸¡à¸·à¸­à¸–à¸·à¸­)
  navigator.geolocation.getCurrentPosition(
    function (pos) {

      const lat = pos.coords.latitude
      const lng = pos.coords.longitude

      supabaseClient
        .from('members')
        .update({ lat, lng })
        .eq('member_id', memberId)
        .then(({ error }) => {

          if (error) {
            alert('à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸´à¸à¸±à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ')
            console.error(error)
            return
          }

          alert('ğŸ“ à¸›à¸±à¸à¸à¸´à¸à¸±à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢')
          loadMembers() // à¹ƒà¸Šà¹‰ group à¹€à¸”à¸´à¸¡
        })
    },

    function (err) {
      console.error(err)

      if (err.code === 1) {
        alert('âŒ à¸à¸£à¸¸à¸“à¸²à¸­à¸™à¸¸à¸à¸²à¸•à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡')
      } else if (err.code === 2) {
        alert('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹„à¸”à¹‰')
      } else {
        alert('âŒ GPS à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰')
      }
    },

    {
      timeout: 10000,
      maximumAge: 0
      // âŒ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ enableHighAccuracy
    }
  )
}

/* MODAL MAP */
let singleMap
function openMap(lat, lng, name){
  if(!lat || !lng) return alert('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸´à¸à¸±à¸”')
  mapModal.classList.remove('hidden')
  modalTitle.innerText = name

  setTimeout(() => {
    singleMap = L.map('singleMap').setView([lat, lng], 16)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(singleMap)
    L.marker([lat, lng]).addTo(singleMap)
  }, 100)
}

function closeMap(){
  mapModal.classList.add('hidden')
  singleMap.remove()
}

/* INFINITE */
window.addEventListener('scroll', () => {
  if(innerHeight + scrollY >= document.body.offsetHeight - 200){
    renderMore()
  }
})

init()
</script>
</body>
</html>
