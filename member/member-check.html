<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸²à¸Šà¸´à¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- Sticky Search -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-lg px-4 py-2 text-black"
    placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸² à¹€à¸¥à¸‚à¸ªà¸¡à¸²à¸Šà¸´à¸ / à¸Šà¸·à¹ˆà¸­ / à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥"
    oninput="resetAndRender()" />
</div>

<!-- Summary -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold" id="totalCount">0</div>
    <div class="text-sm text-slate-400">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-green-400" id="memberCount">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-blue-400" id="associateCount">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š</div>
  </div>
</div>

<!-- Export -->
<div class="px-4 mb-2">
  <button onclick="exportExcel()"
    class="w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-2 font-bold">
    ğŸ“¤ Export Excel
  </button>
</div>

<!-- Cards -->
<div id="cardList" class="p-4 space-y-3"></div>

<script>
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 20

/* INIT */
async function init() {
  await liff.init({ liffId: LIFF_ID })
  if (!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  if (!admin || admin.approve_status !== 'approved') {
    alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡')
    return
  }

  const myGroup = admin.position.match(/\d+/)?.[0]
  loadMembers(myGroup)
}

/* LOAD DATA */
async function loadMembers(group) {
  const { data, error } = await supabaseClient
    .from('members')
    .select(`
      member_id,
      title,
      first_name,
      last_name,
      group,
      house_no,
      moo,
      street,
      village,
      subdistrict,
      district,
      province,
      phone,
      member_status
    `)
    .eq('group', group)
    .in('member_status', ['à¸ªà¸¡à¸²à¸Šà¸´à¸', 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š'])
    .order('member_id', { ascending: true })

  if (error) return alert(error.message)

  allMembers = data
  updateSummary()
  resetAndRender()
}

/* SUMMARY */
function updateSummary() {
  document.getElementById('totalCount').innerText = allMembers.length
  document.getElementById('memberCount').innerText =
    allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸').length
  document.getElementById('associateCount').innerText =
    allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š').length
}

/* RENDER */
function resetAndRender() {
  renderIndex = 0
  document.getElementById('cardList').innerHTML = ''
  renderMore()
}

function renderMore() {
  const keyword = document.getElementById('searchInput').value.toLowerCase()
 const list = allMembers
  .filter(m =>
    m.member_id.toString().includes(keyword) ||
    m.first_name.toLowerCase().includes(keyword) ||
    m.last_name.toLowerCase().includes(keyword)
  )
  .sort((a, b) => a.member_id - b.member_id)


  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    document.getElementById('cardList').innerHTML += `
      <div class="bg-slate-800 rounded-xl p-4">
        <div class="flex justify-between">
          <div class="font-bold text-lg">
            ${m.member_id} Â· ${m.title}${m.first_name} ${m.last_name}
          </div>
          <span class="text-xs px-2 py-1 rounded bg-slate-700">
            ${m.member_status}
          </span>
        </div>

        <div class="text-sm text-slate-400 mt-1">
          ğŸ“ ${m.house_no} à¸¡.${m.moo} ${m.street || ''} ${m.village || ''}
          ${m.subdistrict} ${m.district} ${m.province}
        </div>

        <a href="tel:${m.phone}" class="block mt-2 text-emerald-400 font-bold">
          ğŸ“ ${m.phone}
        </a>
      </div>
    `
  })

  renderIndex += PAGE_SIZE
}

/* Infinite Scroll */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    renderMore()
  }
})

/* EXPORT */
function exportExcel() {
  const sorted = [...allMembers].sort((a, b) => a.member_id - b.member_id)

  const rows = sorted.map((m, i) => ({
    à¸¥à¸³à¸”à¸±à¸š: i + 1,
    à¸£à¸«à¸±à¸ªà¸ªà¸¡à¸²à¸Šà¸´à¸: m.member_id,
    à¸Šà¸·à¹ˆà¸­: `${m.title}${m.first_name} ${m.last_name}`,
    à¸ªà¸–à¸²à¸™à¸°: m.member_status,
    à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£: m.phone
  }))

  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Members')
  XLSX.writeFile(wb, 'members.xlsx')
}


init()
</script>

</body>
</html>
