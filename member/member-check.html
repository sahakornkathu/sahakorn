<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- LINE LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Print mode -->
  <style>
    @media print {
      input, button, .sticky { display: none !important; }
      body { background: white; }
      table { font-size: 12px; }
      tr { page-break-inside: avoid; }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<div id="loading" class="text-center text-lg font-bold">
  ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...
</div>

<div id="noAccess" class="hidden text-center text-red-600 text-xl font-bold">
  ‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
</div>

<div id="content" class="hidden max-w-7xl mx-auto space-y-4">

  <!-- Summary -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <div class="bg-white p-4 rounded shadow text-center">
      <div class="text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div id="totalCount" class="text-3xl font-bold">0</div>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <div class="text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
      <div id="memberCount" class="text-3xl font-bold text-green-600">0</div>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <div class="text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
      <div id="associateCount" class="text-3xl font-bold text-blue-600">0</div>
    </div>
  </div>

  <!-- Search -->
  <div class="sticky top-0 z-20 bg-white p-3 rounded shadow flex flex-col sm:flex-row gap-2">
    <input
      id="searchInput"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
      class="border rounded px-3 py-2 w-full sm:w-64"
      oninput="resetAndRender()" />

    <button
      onclick="exportExcel()"
      class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded">
      Export Excel
    </button>
  </div>

  <!-- Desktop Table -->
  <div class="bg-white p-4 rounded shadow hidden sm:block overflow-x-auto">
    <table class="w-full border text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="border p-2">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="border p-2">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
          <th class="border p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="border p-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="border p-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
          <th class="border p-2">‡πÇ‡∏ó‡∏£</th>
          <th class="border p-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Mobile Cards -->
  <div id="mobileList" class="sm:hidden space-y-3"></div>

</div>

<script>
/* CONFIG */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
)

let allMembers = []
let filteredMembers = []
let myGroup = null
let pageSize = 20
let currentPage = 1

/* INIT */
async function init() {
  await liff.init({ liffId: LIFF_ID })
  if (!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  document.getElementById('loading').remove()

  if (!admin || admin.approve_status !== 'approved') {
    document.getElementById('noAccess').classList.remove('hidden')
    return
  }

  myGroup = admin.position.match(/\d+/)?.[0]
  if (!myGroup) {
    document.getElementById('noAccess').classList.remove('hidden')
    return
  }

  document.getElementById('content').classList.remove('hidden')
  loadMembers()
}

/* LOAD MEMBERS */
async function loadMembers() {
  const { data, error } = await supabaseClient
    .from('members')
    .select(`
      member_id,
      group,
      first_name,
      last_name,
      house_no,
      moo,
      village,
      subdistrict,
      district,
      province,
      phone,
      member_status
    `)
    .eq('group', myGroup)
    .in('member_status', ['‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å','‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö'])
    .order('member_id', { ascending: true })

  if (error) return alert(error.message)

  allMembers = data
  resetAndRender()
}

/* RENDER */
function resetAndRender() {
  currentPage = 1
  renderTable()
}

function renderTable() {
  const keyword = document.getElementById('searchInput').value.toLowerCase()

  filteredMembers = allMembers.filter(m =>
    m.member_id.toString().includes(keyword) ||
    m.first_name.toLowerCase().includes(keyword) ||
    m.last_name.toLowerCase().includes(keyword)
  )

  updateSummary(filteredMembers)

  const show = filteredMembers.slice(0, currentPage * pageSize)
  document.getElementById('tableBody').innerHTML = ''
  document.getElementById('mobileList').innerHTML = ''

  show.forEach((m, i) => {
    const address = [
      m.house_no, m.moo, m.village,
      m.subdistrict, m.district, m.province
    ].filter(Boolean).join(' ')

    tableBody.innerHTML += `
      <tr class="text-center">
        <td class="border p-2">${i+1}</td>
        <td class="border p-2">${m.member_id}</td>
        <td class="border p-2">${m.group}</td>
        <td class="border p-2">${m.first_name}</td>
        <td class="border p-2">${m.last_name}</td>
        <td class="border p-2 text-left">${address}</td>
        <td class="border p-2">
          <a href="tel:${m.phone}" class="text-blue-600 underline">${m.phone}</a>
        </td>
        <td class="border p-2">${m.member_status}</td>
      </tr>
    `

    mobileList.innerHTML += `
      <div class="bg-white p-4 rounded shadow">
        <div class="font-bold">${m.first_name} ${m.last_name}</div>
        <div class="text-sm">‡∏£‡∏´‡∏±‡∏™ ${m.member_id} | ‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group}</div>
        <div class="text-sm mt-1">${address}</div>
        <a href="tel:${m.phone}" class="block mt-2 text-blue-600 font-bold">
          üìû ${m.phone}
        </a>
        <div class="mt-2 text-xs inline-block px-2 py-1 rounded
          ${m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'
            ? 'bg-green-100 text-green-700'
            : 'bg-blue-100 text-blue-700'}">
          ${m.member_status}
        </div>
      </div>
    `
  })
}

/* SUMMARY */
function updateSummary(list) {
  totalCount.textContent = list.length
  memberCount.textContent = list.filter(m=>m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length
  associateCount.textContent = list.filter(m=>m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö').length
}

/* INFINITE SCROLL */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    if (currentPage * pageSize < filteredMembers.length) {
      currentPage++
      renderTable()
    }
  }
})

/* EXPORT */
function exportExcel() {
  const sorted = [...filteredMembers].sort((a,b)=>a.member_id-b.member_id)
  const rows = sorted.map((m,i)=>({
    ‡∏•‡∏≥‡∏î‡∏±‡∏ö:i+1,
    ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:m.member_id,
    ‡∏Å‡∏•‡∏∏‡πà‡∏°:m.group,
    ‡∏ä‡∏∑‡πà‡∏≠:m.first_name,
    ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:m.last_name,
    ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:`${m.house_no||''} ${m.moo||''} ${m.village||''} ${m.subdistrict||''} ${m.district||''} ${m.province||''}`,
    ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:m.phone,
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:m.member_status
  }))
  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Members')
  XLSX.writeFile(wb, `members_group_${myGroup}.xlsx`)
}

init()
</script>
</body>
</html>
