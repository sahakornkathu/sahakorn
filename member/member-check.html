<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸²à¸Šà¸´à¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- LIFF -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- Sticky Search -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-lg px-4 py-2 text-black"
    placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸² à¹€à¸¥à¸‚à¸ªà¸¡à¸²à¸Šà¸´à¸ / à¸Šà¸·à¹ˆà¸­ / à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥"
    oninput="resetAndRender()" />
</div>

<!-- Summary -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold" id="totalCount">0</div>
    <div class="text-sm text-slate-400">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-green-400" id="memberCount">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-blue-400" id="associateCount">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š</div>
  </div>
</div>

<!-- Export -->
<div class="px-4 mb-3">
  <button onclick="exportExcel()"
    class="w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-2 font-bold">
    ğŸ“¤ Export Excel
  </button>
</div>

<!-- Group Map -->
<div class="p-4">
  <div id="groupMap" class="w-full h-[380px] rounded-xl overflow-hidden"></div>
</div>

<!-- Cards -->
<div id="cardList" class="p-4 space-y-3"></div>

<!-- Pin Modal -->
<div id="pinModal"
 class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-[90%] max-w-lg p-3">
    <div id="pinMap" class="w-full h-[300px] rounded-lg"></div>
    <button onclick="closePinMap()"
      class="mt-2 w-full bg-red-600 text-white py-2 rounded">
      à¸›à¸´à¸”
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
)

/* ================= STATE ================= */
let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 20

let map, markers = []
let pinMap, pinMarker, pinMemberId = null

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: LIFF_ID })
  if (!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  if (!admin || admin.approve_status !== 'approved') {
    alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡')
    return
  }

  const myGroup = admin.position.match(/\d+/)?.[0]
  loadMembers(myGroup)
}

/* ================= LOAD MEMBERS ================= */
async function loadMembers(group) {
  const { data, error } = await supabaseClient
    .from('members')
    .select(`
      member_id,
      title,
      first_name,
      last_name,
      group,
      house_no,
      moo,
      street,
      village,
      subdistrict,
      district,
      province,
      phone,
      member_status,
      lat,
      lng
    `)
    .eq('group', group)
    .in('member_status', ['à¸ªà¸¡à¸²à¸Šà¸´à¸', 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š'])
    .order('member_id', { ascending: true })

  if (error) return alert(error.message)

  allMembers = data
  updateSummary()
  initGroupMap()
  resetAndRender()
}

/* ================= SUMMARY ================= */
function updateSummary() {
  totalCount.innerText = allMembers.length
  memberCount.innerText = allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸').length
  associateCount.innerText = allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š').length
}

/* ================= MAP GROUP ================= */
function initGroupMap() {
  map = new google.maps.Map(document.getElementById("groupMap"), {
    zoom: 13,
    center: { lat: 13.736717, lng: 100.523186 },
    mapTypeControl: false,
    streetViewControl: false
  })

  markers.forEach(m => m.setMap(null))
  markers = []

  allMembers.filter(m => m.lat && m.lng).forEach(m => {
    const marker = new google.maps.Marker({
      position: { lat: m.lat, lng: m.lng },
      map
    })

    const info = new google.maps.InfoWindow({
      content: `<b>${m.member_id}</b><br>${m.title}${m.first_name} ${m.last_name}`
    })

    marker.addListener("click", () => info.open(map, marker))
    markers.push(marker)
  })
}

/* ================= RENDER ================= */
function resetAndRender() {
  renderIndex = 0
  cardList.innerHTML = ''
  renderMore()
}

function renderMore() {
  const keyword = searchInput.value.toLowerCase()

  const list = allMembers
    .filter(m =>
      m.member_id.toString().includes(keyword) ||
      m.first_name.toLowerCase().includes(keyword) ||
      m.last_name.toLowerCase().includes(keyword)
    )
    .sort((a, b) => a.member_id - b.member_id)

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    cardList.innerHTML += `
      <div class="bg-slate-800 rounded-xl p-4 space-y-2">
        <div class="flex justify-between">
          <div class="font-bold text-lg">
            ${m.member_id} Â· ${m.title}${m.first_name} ${m.last_name}
          </div>
          <span class="text-xs px-2 py-1 rounded ${m.lat ? 'bg-green-700' : 'bg-red-700'}">
            ${m.member_status}
          </span>
        </div>

        <div class="text-sm text-slate-400">
          ğŸ“ ${m.house_no} à¸¡.${m.moo} ${m.village || ''} ${m.subdistrict} ${m.district}
        </div>

        <a href="tel:${m.phone}" class="block text-emerald-400 font-bold">
          ğŸ“ ${m.phone}
        </a>

        <div class="grid grid-cols-2 gap-2">
          <button onclick="saveGPS(${m.member_id})"
            class="bg-blue-600 rounded-lg py-2 text-sm">ğŸ“¡ GPS</button>
          <button onclick="openPinMap(${m.member_id})"
            class="bg-purple-600 rounded-lg py-2 text-sm">ğŸ“ à¸›à¸±à¸à¸«à¸¡à¸¸à¸”</button>
        </div>
      </div>
    `
  })

  renderIndex += PAGE_SIZE
}

/* ================= GPS ================= */
function saveGPS(memberId) {
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords
    await supabaseClient.from('members')
      .update({ lat: latitude, lng: longitude })
      .eq('member_id', memberId)
    init()
  })
}

/* ================= PIN MAP ================= */
function openPinMap(memberId) {
  pinMemberId = memberId
  pinModal.classList.remove('hidden')

  pinMap = new google.maps.Map(document.getElementById("pinMap"), {
    zoom: 16,
    center: map.getCenter()
  })

  pinMap.addListener("click", e => {
    if (pinMarker) pinMarker.setMap(null)
    pinMarker = new google.maps.Marker({ position: e.latLng, map: pinMap })
    savePin(memberId, e.latLng.lat(), e.latLng.lng())
  })
}

function closePinMap() {
  pinModal.classList.add('hidden')
}

async function savePin(memberId, lat, lng) {
  await supabaseClient.from('members')
    .update({ lat, lng })
    .eq('member_id', memberId)
  closePinMap()
  init()
}

/* ================= SCROLL ================= */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    renderMore()
  }
})

/* ================= EXPORT ================= */
function exportExcel() {
  const rows = [...allMembers]
    .sort((a, b) => a.member_id - b.member_id)
    .map((m, i) => ({
      à¸¥à¸³à¸”à¸±à¸š: i + 1,
      à¸£à¸«à¸±à¸ªà¸ªà¸¡à¸²à¸Šà¸´à¸: m.member_id,
      à¸Šà¸·à¹ˆà¸­: `${m.title}${m.first_name} ${m.last_name}`,
      à¸ªà¸–à¸²à¸™à¸°: m.member_status,
      à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£: m.phone,
      à¹à¸œà¸™à¸—à¸µà¹ˆ: m.lat ? `https://maps.google.com/?q=${m.lat},${m.lng}` : ''
    }))

  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Members')
  XLSX.writeFile(wb, 'members.xlsx')
}

init()
</script>

</body>
</html>
