<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸²à¸Šà¸´à¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- LIFF -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Leaflet (FREE MAP) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- Sticky Search -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-lg px-4 py-2 text-black"
    placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸² à¹€à¸¥à¸‚à¸ªà¸¡à¸²à¸Šà¸´à¸ / à¸Šà¸·à¹ˆà¸­ / à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥"
    oninput="resetAndRender()" />
</div>

<!-- Summary -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold" id="totalCount">0</div>
    <div class="text-sm text-slate-400">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-green-400" id="memberCount">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-blue-400" id="associateCount">0</div>
    <div class="text-sm text-slate-400">à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š</div>
  </div>
</div>

<!-- MAP -->
<div class="px-4">
  <div id="map" class="h-72 rounded-xl overflow-hidden"></div>
</div>

<!-- Cards -->
<div id="cardList" class="p-4 space-y-3"></div>

<script>
/* CONFIG */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 15
let map
let markers = []

/* INIT */
async function init() {
  await liff.init({ liffId: LIFF_ID })
  if (!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  if (!admin || admin.approve_status !== 'approved') {
    alert('à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡')
    return
  }

  const myGroup = admin.position.match(/\d+/)?.[0]
  initMap()
  loadMembers(myGroup)
}

/* MAP */
function initMap() {
  map = L.map('map').setView([13.736717, 100.523186], 12)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map)
}

function renderMarkers() {
  markers.forEach(m => map.removeLayer(m))
  markers = []

  allMembers.forEach(m => {
    if (m.lat && m.lng) {
      const marker = L.marker([m.lat, m.lng])
        .addTo(map)
        .bindPopup(`
          <b>${m.member_id}</b><br>
          ${m.title}${m.first_name} ${m.last_name}<br>
          <a href="tel:${m.phone}" class="text-blue-500">ğŸ“ ${m.phone}</a>
        `)
      markers.push(marker)
    }
  })
}

/* LOAD MEMBERS */
async function loadMembers(group) {
  const { data, error } = await supabaseClient
    .from('members')
    .select('*')
    .eq('group', group)
    .in('member_status', ['à¸ªà¸¡à¸²à¸Šà¸´à¸', 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š'])
    .order('member_id', { ascending: true })

  if (error) return alert(error.message)

  allMembers = data
  updateSummary()
  renderMarkers()
  resetAndRender()
}

/* SUMMARY */
function updateSummary() {
  totalCount.innerText = allMembers.length
  memberCount.innerText = allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸').length
  associateCount.innerText = allMembers.filter(m => m.member_status === 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸¡à¸—à¸š').length
}

/* RENDER */
function resetAndRender() {
  renderIndex = 0
  cardList.innerHTML = ''
  renderMore()
}

function renderMore() {
  const keyword = searchInput.value.toLowerCase()

  const list = allMembers
    .filter(m =>
      m.member_id.toString().includes(keyword) ||
      m.first_name.toLowerCase().includes(keyword) ||
      m.last_name.toLowerCase().includes(keyword)
    )

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    cardList.innerHTML += `
      <div class="bg-slate-800 rounded-xl p-4">
        <div class="flex justify-between">
          <div class="font-bold">
            ${m.member_id} Â· ${m.title}${m.first_name} ${m.last_name}
          </div>
          <span class="text-xs bg-slate-700 px-2 py-1 rounded">
            ${m.member_status}
          </span>
        </div>

        <div class="text-sm text-slate-400 mt-1">
          ğŸ“ ${m.house_no || ''} à¸¡.${m.moo || ''} ${m.subdistrict || ''} ${m.district || ''}
        </div>

        <div class="flex justify-between mt-3">
          <a href="tel:${m.phone}" class="text-emerald-400 font-bold">
            ğŸ“ à¹‚à¸—à¸£
          </a>
          <button onclick="pinLocation(${m.member_id})"
            class="text-sm bg-blue-600 px-3 py-1 rounded">
            ğŸ“ à¸›à¸±à¸à¸à¸´à¸à¸±à¸”
          </button>
        </div>
      </div>
    `
  })

  renderIndex += PAGE_SIZE
}

/* GPS PIN */
function pinLocation(memberId) {
  if (!navigator.geolocation) {
    alert('à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š GPS')
    return
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude
    const lng = pos.coords.longitude

    const { error } = await supabaseClient
      .from('members')
      .update({ lat, lng })
      .eq('member_id', memberId)

    if (error) {
      alert(error.message)
      return
    }

    alert('ğŸ“ à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸´à¸à¸±à¸”à¹à¸¥à¹‰à¸§')
    loadMembers(allMembers[0].group)
  })
}

/* Infinite Scroll */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    renderMore()
  }
})

init()
</script>

</body>
</html>
