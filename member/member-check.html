<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- SEARCH -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-xl px-4 py-2 text-black"
    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
    oninput="resetAndRender()">
</div>

<!-- SUMMARY -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="totalCount" class="text-2xl font-bold">0</div>
    <div class="text-sm text-slate-400">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="memberCount" class="text-2xl font-bold text-green-400">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div id="associateCount" class="text-2xl font-bold text-blue-400">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
  </div>
</div>

<!-- MAP -->
<div class="px-4">
  <div id="map" class="h-72 rounded-xl"></div>
</div>

<!-- CARDS -->
<div id="cardList" class="p-4 space-y-3"></div>

<!-- MODAL MAP -->
<div id="mapModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-slate-800 rounded-xl w-[90%] h-[70%] p-3">
    <div class="flex justify-between mb-2">
      <div id="modalTitle" class="font-bold"></div>
      <button onclick="closeMap()" class="text-red-400">‚úï</button>
    </div>
    <div id="singleMap" class="h-full rounded"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 10
let map, markers = []
let userRole = 'admin'
let userGroup = null

/* ================= INIT ================= */
async function init(){

  // ‚ùå ‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å browser
  if (!liff.isInClient()) {
    document.body.innerHTML = `
      <div class="flex items-center justify-center h-screen text-center">
        <div>
          <h1 class="text-2xl font-bold text-red-500">‚õî ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô Browser</h1>
          <p class="text-slate-400 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        </div>
      </div>`
    return
  }

  await liff.init({ liffId: LIFF_ID })
  if(!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', profile.userId)
    .maybeSingle()

  if(!admin || admin.approve_status !== 'approved'){
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á')
    liff.closeWindow()
    return
  }

  if (admin.position === 'super') {
    userRole = 'super'
  } else {
    userGroup = admin.position.match(/\d+/)?.[0]
  }

  initMap()
  loadMembers(userRole, userGroup)
}

/* ================= MAP ================= */
function initMap(){
  map = L.map('map').setView([13.7, 100.5], 12)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
}

function renderMarkers(){
  markers.forEach(m => map.removeLayer(m))
  markers = []

  allMembers.forEach(m => {
    if(m.lat && m.lng){
      markers.push(
        L.marker([m.lat, m.lng])
          .addTo(map)
          .bindPopup(`${m.member_id}<br>${m.first_name} ${m.last_name}`)
      )
    }
  })
}

/* ================= LOAD ================= */
function renderMore(){
  const kw = searchInput.value.toLowerCase()

  const list = allMembers
    .filter(m =>
      m.member_id.toString().includes(kw) ||
      m.first_name.toLowerCase().includes(kw) ||
      m.last_name.toLowerCase().includes(kw)
    )
    // ‚≠ê ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å
    .sort((a, b) => a.member_id - b.member_id)

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    cardList.innerHTML += `
      <div class="bg-slate-800 rounded-xl p-4 space-y-2">
        <div class="flex justify-between items-center">
          <div class="font-bold text-lg">
            ${m.member_id} ¬∑ ${m.title}${m.first_name} ${m.last_name}
          </div>
          <span class="text-xs px-2 py-1 rounded bg-slate-700">
            ${m.lat && m.lng ? 'üìç ‡∏õ‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å'}
          </span>
        </div>

        <div class="text-sm text-slate-400">
          ‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group} ¬∑ ${m.member_status}
        </div>

        <a href="tel:${m.phone}" class="block text-green-400 font-bold">
          üìû ${m.phone}
        </a>
      </div>
    `
  })

  renderIndex += PAGE_SIZE
}


/* ================= SUMMARY ================= */
function updateSummary(){
  totalCount.innerText = allMembers.length
  memberCount.innerText = allMembers.filter(m => m.member_status === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length
  associateCount.innerText = allMembers.filter(m => m.member_status === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö').length
}

/* ================= RENDER ================= */
function resetAndRender(){
  renderIndex = 0
  cardList.innerHTML = ''
  renderMore()
}

function renderMore(){
  const kw = searchInput.value.toLowerCase()

  const list = allMembers.filter(m =>
    m.member_id.toString().includes(kw) ||
    m.first_name.toLowerCase().includes(kw) ||
    m.last_name.toLowerCase().includes(kw)
  )

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    cardList.innerHTML += `
    <div class="bg-slate-800 rounded-xl p-4 space-y-2">
      <div class="flex justify-between items-center">
        <div class="font-bold text-lg">
          ${m.member_id} ¬∑ ${m.title}${m.first_name} ${m.last_name}
        </div>
        <span class="text-xs px-2 py-1 rounded bg-slate-700">
          ${m.lat && m.lng ? 'üìç ‡∏õ‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å'}
        </span>
      </div>

      <div class="text-sm text-slate-400">
        ‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group} ¬∑ ${m.member_status}
      </div>

      <div class="flex gap-2">
        <button onclick="pinGPS(${m.member_id})"
          class="flex-1 bg-blue-600 rounded py-1">
          üìç ‡∏õ‡∏±‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î
        </button>

        <button onclick="openMap(${m.lat},${m.lng},'${m.first_name} ${m.last_name}')"
          class="flex-1 bg-emerald-600 rounded py-1">
          üó∫Ô∏è ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        </button>
      </div>

      ${m.lat && m.lng ? `
      <a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}"
        target="_blank"
        class="block text-center bg-slate-700 rounded py-1">
        üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
      </a>` : ''}

      <a href="tel:${m.phone}" class="block text-green-400 font-bold">
        üìû ${m.phone}
      </a>
    </div>`
  })

  renderIndex += PAGE_SIZE
}

/* ================= GPS ================= */
function pinGPS(memberId){
  navigator.geolocation.getCurrentPosition(async pos => {
    const { error } = await supabaseClient
      .from('members')
      .update({ lat: pos.coords.latitude, lng: pos.coords.longitude })
      .eq('member_id', memberId)

    if(!error){
      alert('üìç ‡∏õ‡∏±‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')
      loadMembers(userRole, userGroup)
    }
  })
}

/* ================= MODAL ================= */
let singleMap
function openMap(lat, lng, name){
  if(!lat || !lng) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î')
  mapModal.classList.remove('hidden')
  modalTitle.innerText = name

  setTimeout(() => {
    singleMap = L.map('singleMap').setView([lat, lng], 16)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(singleMap)
    L.marker([lat, lng]).addTo(singleMap)
  }, 100)
}

function closeMap(){
  mapModal.classList.add('hidden')
  singleMap.remove()
}

/* ================= INFINITE ================= */
window.addEventListener('scroll', () => {
  if(innerHeight + scrollY >= document.body.offsetHeight - 200){
    renderMore()
  }
})

init()
</script>
</body>
</html>
