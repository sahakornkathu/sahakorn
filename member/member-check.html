<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family: system-ui;
  background:#0f172a;
  color:#e5e7eb;
}
header{
  position:sticky;
  top:0;
  z-index:10;
  background:#020617;
  padding:10px;
}
input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  background:#020617;
  color:#fff;
}
.grid{
  padding:10px;
  display:grid;
  gap:10px;
}
.card{
  background:#020617;
  border-radius:14px;
  padding:12px;
}
.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
}
.yes{background:#065f46}
.no{background:#7c2d12}
.btn{
  padding:6px 10px;
  border-radius:10px;
  border:none;
  cursor:pointer;
}
.btn-gps{background:#2563eb;color:white}
.btn-nav{background:#16a34a;color:white}
.hidden{display:none}
.counts{
  display:flex;
  gap:10px;
  padding:10px;
}
.count{
  flex:1;
  background:#020617;
  border-radius:14px;
  padding:10px;
  text-align:center;
}
</style>
</head>

<body>

<header>
  <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / ‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">
</header>

<div class="counts">
  <div class="count" id="count-member">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: 0</div>
  <div class="count" id="count-assoc">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö: 0</div>
</div>

<div class="grid" id="list"></div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "1661506692-nVNGOHNm";
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";
/* ========================================= */

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let page = 0;
const PAGE_SIZE = 20;
let members = [];
let allowGroups = [];
let isSuper = false;

/* ============ BLOCK DIRECT BROWSER ============ */
if(!navigator.userAgent.includes("Line")){
  document.body.innerHTML = "<h3 style='padding:20px'>‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h3>";
  throw new Error("Not LINE");
}

/* ================= LIFF INIT ================= */
async function init(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();

  const profile = await liff.getProfile();
  await checkPermission(profile.userId);
  await loadMembers();
  render();
}

async function checkPermission(uid){
  const { data } = await supabase
    .from("committee")
    .select("group,role")
    .eq("line_uid", uid)
    .single();

  if(!data) throw alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á");

  if(data.role === "superadmin"){
    isSuper = true;
  }else{
    allowGroups = [data.group];
  }
}

/* ================= LOAD DATA ================= */
async function loadMembers(){
  let query = supabase
    .from("members")
    .select("member_id,first_name,last_name,phone,group,member_status,lat,lng")
    .in("member_status",["‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å","‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö"])
    .order("member_id",{ ascending:true })
    .range(page*PAGE_SIZE,(page+1)*PAGE_SIZE-1);

  if(!isSuper){
    query = query.in("group", allowGroups);
  }

  const { data } = await query;
  members.push(...data);
  page++;
}

/* ================= RENDER ================= */
function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  let countMember = 0, countAssoc = 0;

  members.forEach(m=>{
    if(m.member_status==="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å") countMember++;
    else countAssoc++;

    const hasGPS = m.lat && m.lng;

    list.innerHTML += `
      <div class="card">
        <b>${m.member_id}</b> ${m.first_name} ${m.last_name}<br>
        üìû <a href="tel:${m.phone}" style="color:#93c5fd">${m.phone}</a><br>
        <span class="badge ${hasGPS?'yes':'no'}">
          ${hasGPS?'üìç ‡∏õ‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß':'‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å'}
        </span><br><br>

        <button class="btn btn-gps" onclick="pinGPS('${m.member_id}')">üìç ‡∏õ‡∏±‡∏Å GPS</button>
        <button class="btn btn-nav ${hasGPS?'':'hidden'}"
          onclick="nav(${m.lat},${m.lng})">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
      </div>
    `;
  });

  document.getElementById("count-member").innerText =
    `‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${countMember}`;
  document.getElementById("count-assoc").innerText =
    `‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö: ${countAssoc}`;
}

/* ================= GPS ================= */
function pinGPS(id){
  navigator.geolocation.getCurrentPosition(async pos=>{
    await supabase.from("members")
      .update({
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      })
      .eq("member_id", id);

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    location.reload();
  });
}

function nav(lat,lng){
  window.open(`https://maps.google.com/?q=${lat},${lng}`);
}

/* ============ INFINITE SCROLL ============ */
window.addEventListener("scroll", async ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 200){
    await loadMembers();
    render();
  }
});

init();
</script>
</body>
</html>
