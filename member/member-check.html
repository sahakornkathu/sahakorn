<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- Sticky Search -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    class="w-full rounded-lg px-4 py-2 text-black"
    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
    oninput="resetAndRender()" />
</div>

<!-- Summary -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold" id="totalCount">0</div>
    <div class="text-sm text-slate-400">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-green-400" id="memberCount">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-3 text-center">
    <div class="text-2xl font-bold text-blue-400" id="associateCount">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
  </div>
</div>

<!-- Export -->
<div class="px-4 mb-2">
  <button onclick="exportExcel()"
    class="w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-2 font-bold">
    üì§ Export Excel
  </button>
</div>

<!-- Cards -->
<div id="cardList" class="p-4 space-y-3"></div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 20

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: LIFF_ID })
  if (!liff.isLoggedIn()) return liff.login()

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  if (!admin || admin.approve_status !== 'approved') {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á')
    return
  }

  const myGroup = admin.position.match(/\d+/)?.[0]
  loadMembers(myGroup)
}

/* ================= LOAD MEMBERS ================= */
async function loadMembers(group) {
  const { data, error } = await supabaseClient
    .from('members')
    .select(`
      member_id,
      title,
      first_name,
      last_name,
      group,
      house_no,
      moo,
      street,
      village,
      subdistrict,
      district,
      province,
      phone,
      member_status,
      lat,
      lng
    `)
    .eq('group', group)
    .in('member_status', ['‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö'])
    .order('member_id', { ascending: true })

  if (error) return alert(error.message)

  allMembers = data
  updateSummary()
  resetAndRender()
}

/* ================= SUMMARY ================= */
function updateSummary() {
  document.getElementById('totalCount').innerText = allMembers.length
  document.getElementById('memberCount').innerText =
    allMembers.filter(m => m.member_status === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length
  document.getElementById('associateCount').innerText =
    allMembers.filter(m => m.member_status === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö').length
}

/* ================= RENDER ================= */
function resetAndRender() {
  renderIndex = 0
  document.getElementById('cardList').innerHTML = ''
  renderMore()
}

function renderMore() {
  const keyword = document.getElementById('searchInput').value.toLowerCase()

  const list = allMembers
    .filter(m =>
      m.member_id.toString().includes(keyword) ||
      m.first_name.toLowerCase().includes(keyword) ||
      m.last_name.toLowerCase().includes(keyword)
    )
    .sort((a, b) => a.member_id - b.member_id)

  list.slice(renderIndex, renderIndex + PAGE_SIZE).forEach(m => {
    document.getElementById('cardList').innerHTML += `
      <div class="bg-slate-800 rounded-xl p-4 space-y-2">
        <div class="flex justify-between items-center">
          <div class="font-bold text-lg">
            ${m.member_id} ¬∑ ${m.title}${m.first_name} ${m.last_name}
          </div>
          <span class="text-xs px-2 py-1 rounded ${
            m.lat ? 'bg-green-700' : 'bg-red-700'
          }">
            ${m.lat ? 'üìç ‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î'}
          </span>
        </div>

        <div class="text-sm text-slate-400">
          üìç ${m.house_no} ‡∏°.${m.moo} ${m.street || ''} ${m.village || ''}
          ${m.subdistrict} ${m.district} ${m.province}
        </div>

        <a href="tel:${m.phone}" class="block text-emerald-400 font-bold">
          üìû ${m.phone}
        </a>

        <button onclick="saveLocation(${m.member_id})"
          class="w-full bg-blue-600 hover:bg-blue-700 rounded-lg py-2 text-sm">
          üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô
        </button>

        ${
          m.lat
            ? `<a target="_blank"
                href="https://www.google.com/maps?q=${m.lat},${m.lng}"
                class="block text-center bg-emerald-600 hover:bg-emerald-700 rounded-lg py-2 text-sm">
                üó∫ ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
              </a>`
            : ''
        }
      </div>
    `
  })

  renderIndex += PAGE_SIZE
}

/* ================= GPS SAVE ================= */
function saveLocation(memberId) {
  if (!navigator.geolocation) {
    alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS')
    return
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords

    const { error } = await supabaseClient
      .from('members')
      .update({ lat: latitude, lng: longitude })
      .eq('member_id', memberId)

    if (error) {
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    } else {
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')
      init()
    }
  })
}

/* ================= SCROLL ================= */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    renderMore()
  }
})

/* ================= EXPORT ================= */
function exportExcel() {
  const sorted = [...allMembers].sort((a, b) => a.member_id - b.member_id)

  const rows = sorted.map((m, i) => ({
    ‡∏•‡∏≥‡∏î‡∏±‡∏ö: i + 1,
    ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: m.member_id,
    ‡∏ä‡∏∑‡πà‡∏≠: `${m.title}${m.first_name} ${m.last_name}`,
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: m.member_status,
    ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: m.phone,
    ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: m.lat ? `https://maps.google.com/?q=${m.lat},${m.lng}` : ''
  }))

  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Members')
  XLSX.writeFile(wb, 'members.xlsx')
}

init()
</script>

</body>
</html>
