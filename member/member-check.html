<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- LINE LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

<div id="loading" class="text-center text-lg font-bold">
  ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...
</div>

<div id="noAccess" class="hidden text-center text-red-600 text-xl font-bold">
  ‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
</div>

<div id="content" class="hidden max-w-7xl mx-auto space-y-4">

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white p-4 rounded shadow text-center">
      <div class="text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div id="totalCount" class="text-3xl font-bold">0</div>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <div class="text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
      <div id="memberCount" class="text-3xl font-bold text-green-600">0</div>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <div class="text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
      <div id="associateCount" class="text-3xl font-bold text-blue-600">0</div>
    </div>
  </div>

  <!-- Table Card -->
  <div class="bg-white p-6 rounded-xl shadow">

    <h1 class="text-2xl font-bold mb-4">
      üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    </h1>

    <!-- Search + Export -->
    <div class="flex flex-wrap gap-2 mb-4">
      <input
        id="searchInput"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
        class="border rounded px-3 py-2 w-full md:w-64"
        oninput="renderTable()" />

      <button
        onclick="exportExcel()"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Export Excel
      </button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="w-full border text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th class="border p-2">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
            <th class="border p-2">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th class="border p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="border p-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
            <th class="border p-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
            <th class="border p-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
            <th class="border p-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const LIFF_ID = '1661506692-nVNGOHNm'

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
)

let allMembers = []
let filteredMembers = []
let myGroup = null

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: LIFF_ID })

  if (!liff.isLoggedIn()) {
    liff.login()
    return
  }

  const profile = await liff.getProfile()
  const lineUserId = profile.userId

  /* ---- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£ ---- */
  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', lineUserId)
    .maybeSingle()

  document.getElementById('loading').remove()

  if (!admin || admin.approve_status !== 'approved') {
    document.getElementById('noAccess').classList.remove('hidden')
    return
  }

  myGroup = admin.position.match(/\d+/)?.[0]

  if (!myGroup) {
    document.getElementById('noAccess').classList.remove('hidden')
    return
  }

  document.getElementById('content').classList.remove('hidden')
  await loadMembers()
}

/* ================= LOAD MEMBERS ================= */
async function loadMembers() {
  const { data, error } = await supabaseClient
    .from('members')
    .select(`
      member_id,
      group,
      first_name,
      last_name,
      house_no,
      moo,
      village,
      subdistrict,
      district,
      province,
      phone,
      member_status
    `)
    .eq('group', myGroup)
    .in('member_status', ['‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö'])
    .order('member_id', { ascending: true })

  if (error) {
    alert(error.message)
    return
  }

  allMembers = data
  renderTable()
}

/* ================= RENDER ================= */
function renderTable() {
  const keyword = document.getElementById('searchInput').value.toLowerCase()

  filteredMembers = allMembers.filter(m =>
    m.member_id.toString().includes(keyword) ||
    m.first_name.toLowerCase().includes(keyword) ||
    m.last_name.toLowerCase().includes(keyword)
  )

  updateSummary(filteredMembers)

  const tbody = document.getElementById('tableBody')
  tbody.innerHTML = ''

  filteredMembers.forEach((m, i) => {
    const address = [
      m.house_no ? `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${m.house_no}` : '',
      m.moo ? `‡∏´‡∏°‡∏π‡πà ${m.moo}` : '',
      m.village || '',
      m.subdistrict || '',
      m.district || '',
      m.province || ''
    ].filter(Boolean).join(' ')

    tbody.innerHTML += `
      <tr class="text-center hover:bg-gray-50">
        <td class="border p-2">${i + 1}</td>
        <td class="border p-2">${m.member_id}</td>
        <td class="border p-2">${m.group}</td>
        <td class="border p-2">${m.first_name}</td>
        <td class="border p-2">${m.last_name}</td>
        <td class="border p-2 text-left">${address}</td>
        <td class="border p-2">${m.phone ?? ''}</td>
        <td class="border p-2">${m.member_status}</td>
      </tr>
    `
  })
}

/* ================= SUMMARY ================= */
function updateSummary(list) {
  document.getElementById('totalCount').textContent = list.length
  document.getElementById('memberCount').textContent =
    list.filter(m => m.member_status === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length
  document.getElementById('associateCount').textContent =
    list.filter(m => m.member_status === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö').length
}

/* ================= EXPORT ================= */
function exportExcel() {
  // clone + sort ‡∏Å‡πà‡∏≠‡∏ô export
  const sorted = [...filteredMembers].sort(
    (a, b) => a.member_id - b.member_id
  )

  const rows = sorted.map((m, i) => ({
    '‡∏•‡∏≥‡∏î‡∏±‡∏ö': i + 1,
    '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å': m.member_id,
    '‡∏Å‡∏•‡∏∏‡πà‡∏°': m.group,
    '‡∏ä‡∏∑‡πà‡∏≠': m.first_name,
    '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': m.last_name,
    '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà': [
      m.house_no ? `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${m.house_no}` : '',
      m.moo ? `‡∏´‡∏°‡∏π‡πà ${m.moo}` : '',
      m.village || '',
      m.subdistrict || '',
      m.district || '',
      m.province || ''
    ].filter(Boolean).join(' '),
    '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': m.phone ?? '',
    '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': m.member_status
  }))

  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Members')

  XLSX.writeFile(wb, `members_group_${myGroup}.xlsx`)
}

init()
</script>

</body>
</html>
