<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family:"Prompt",sans-serif; background:#f0f4f8; margin:20px; color:#333; }
h2 { text-align:center; color:#1e40af; margin-bottom:15px; }
form { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.08); }
input, select { display:block; width:100%; margin:10px 0; padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:14px; background:#f9fafb; }
button { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; background:#4a90e2; color:#fff; font-size:14px; margin-top:10px; }
button:hover { background:#357abd; }
.info-box { background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px; }
table { border-collapse: collapse; width:100%; max-width:800px; margin:20px auto; font-size:13px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
th, td { border:1px solid #e2e8f0; padding:6px 8px; text-align:center; }
th { background:#4a90e2; color:#fff; }
tr:nth-child(even){ background:#f9fafb; }
tr:hover{ background:#edf2f7; }
button.edit { background:#4a90e2; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.edit:hover { background:#357abd; }
button.delete { background:#f56565; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.delete:hover { background:#c53030; }
</style>
</head>
<body>

<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>

<form id="exitForm">
  <select id="memberSelect" required>
    <option value="">--‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
  </select>

  <div class="info-box" id="memberInfo" style="display:none;">
    <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="fullname"></span></p>
    <p><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°:</strong> <span id="groupname"></span></p>
  </div>

  <input type="date" id="meeting_date" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°">
  <input type="number" step="0.01" id="share_amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏∏‡πâ‡∏ô">
  <input type="date" id="receive_date" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">

  <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</form>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
<table id="exitTable">
  <thead>
    <tr>
      <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏∏‡πâ‡∏ô</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // --- Supabase ---
  const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y';
  let supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  window.supabase = supabaseClient;

  const memberSelect = document.getElementById('memberSelect');
  const exitForm = document.getElementById('exitForm');
  const infoBox = document.getElementById('memberInfo');
  const fullNameEl = document.getElementById('fullname');
  const groupNameEl = document.getElementById('groupname');
  const exitTableBody = document.querySelector('#exitTable tbody');

  let memberData = [];
  let editId = null;

  // --- ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ---
  async function loadExitMembers() {
    memberSelect.innerHTML = '<option value="">üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...</option>';
    try {
      const { data, error } = await supabase.from('members')
        .select('member_id,first_name,last_name,"group",member_status')
        .or('member_status.eq.‡∏•‡∏≤‡∏≠‡∏≠‡∏Å,member_status.eq.‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'); // ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      if (error) throw error;

      memberData = data || [];
      memberSelect.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>';
      if(memberData.length===0){
        memberSelect.innerHTML = '<option value="">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>';
      }
      memberData.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.member_id;
        opt.textContent = `${m.member_id} - ${m.first_name} ${m.last_name} (‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group})`;
        memberSelect.appendChild(opt);
      });
      console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', memberData);
    } catch(err){
      alert('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  }

  // --- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ---
  memberSelect.addEventListener('change', () => {
    const selectedId = memberSelect.value;
    if (!selectedId) { infoBox.style.display='none'; return; }
    const member = memberData.find(m=>m.member_id===selectedId);
    if (member) {
      fullNameEl.textContent = `${member.first_name} ${member.last_name}`;
      groupNameEl.textContent = member.group;
      infoBox.style.display = 'block';
    }
  });

  // --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
  exitForm.addEventListener('submit', async e => {
    e.preventDefault();
    const member_id = memberSelect.value;
    if (!member_id) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
    const member = memberData.find(m=>m.member_id===member_id);
    if (!member) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');

    const payload = {
      member_id,
      first_name: member.first_name,
      last_name: member.last_name,
      group: member.group,
      meeting_date: document.getElementById('meeting_date').value || null,
      share_amount: document.getElementById('share_amount').value ? Number(document.getElementById('share_amount').value) : null,
      receive_date: document.getElementById('receive_date').value || null
    };

    try {
      const { error } = await supabase.from('member_exit')
        .upsert([payload], { onConflict: ['member_id'] });
      if(error) throw error;
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      exitForm.reset();
      infoBox.style.display='none';
      loadExitTable();
    } catch(err) {
      alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  });

  // --- ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á member_exit ---
  async function loadExitTable() {
    try {
      const { data, error } = await supabase.from('member_exit')
        .select('*')
        .order('member_id', { ascending:true });
      if(error) throw error;

      exitTableBody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.member_id}</td>
          <td>${row.first_name} ${row.last_name}</td>
          <td>${row.group}</td>
          <td>${row.meeting_date || ''}</td>
          <td>${row.share_amount ?? ''}</td>
          <td>${row.receive_date || ''}</td>
          <td><button class="edit" onclick="editExit('${row.member_id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
          <td><button class="delete" onclick="deleteExit('${row.member_id}')">‡∏•‡∏ö</button></td>
        `;
        exitTableBody.appendChild(tr);
      });
    } catch(err){
      alert('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  }

  // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö ---
  window.editExit = (id) => {
    const row = memberData.find(m=>m.member_id===id);
    if (!row) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
    memberSelect.value = id;
    memberSelect.dispatchEvent(new Event('change'));
    editId = id;
  };

  window.deleteExit = async (id) => {
    if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return;
    try {
      const { error } = await supabase.from('member_exit').delete().eq('member_id', id);
      if(error) throw error;
      alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      loadExitTable();
      loadExitMembers();
    } catch(err){
      alert('‚ùå ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  };

  // --- Init ---
  loadExitMembers();
  loadExitTable();

</script>
</body>
</html>
