<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>รายงานสมาชิกลาออก / เสียชีวิต</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 p-6">

<div class="max-w-7xl mx-auto space-y-6">

<h1 class="text-2xl font-bold text-center text-red-400">
จัดการสมาชิกลาออก / เสียชีวิต
</h1>

<!-- ================= FILTER ================= -->
<div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
<h2 class="text-lg font-bold text-sky-400 mb-4">ค้นหา / กรองข้อมูล</h2>

<div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-4">
<div>
  <label class="label">กลุ่ม</label>
  <input id="f_group" class="input">
</div>

<div>
  <label class="label">สถานะ</label>
  <select id="f_status" class="input">
    <option value="">ทั้งหมด</option>
    <option value="ลาออก">ลาออก</option>
    <option value="เสียชีวิต">เสียชีวิต</option>
  </select>
</div>

<div>
  <label class="label">วันที่เริ่ม (ใช้คำนวณปี)</label>
  <input id="f_date_from" type="date" class="input">
</div>
</div>

<div class="flex justify-end gap-3 mt-4">
<button class="btn blue" onclick="printReport()">พิมพ์รายงาน</button>
</div>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

/* ===== CONFIG ===== */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const COOP_LOGO_URL = 'https://ttottijljxoinptmhgtu.supabase.co/storage/v1/object/public/slips/logo.png'

const db = createClient(SUPABASE_URL, SUPABASE_KEY)

/* ===== FISCAL YEAR (ง่าย ๆ ตามที่บอก) ===== */
function getFiscalYearThai(dateFrom){
  if(!dateFrom) return null

  const [y, m] = dateFrom.split('-').map(Number)
  let fy = y + 543

  // ถ้าก่อนเมษายน → ยังเป็นปีงบเก่า
  if(m < 4){
    fy -= 1
  }

  return fy
}

function getFiscalRangeThai(fy){
  return `1 เมษายน ${fy} – 31 มีนาคม ${fy + 1}`
}

/* ===== PRINT REPORT ===== */
window.printReport = async ()=>{
  if(!f_date_from.value){
    alert('กรุณาเลือกวันที่เริ่ม (from)')
    return
  }

  let q = db.from('member_exit').select('*')

  if(f_group.value){
    q = q.eq('group', f_group.value)
  }

  if(f_status.value){
    q = q.eq('member_status', f_status.value)
  }

  const { data } = await q
  if(!data || !data.length){
    alert('ไม่มีข้อมูล')
    return
  }

  const fiscalYear = getFiscalYearThai(f_date_from.value)
  const fiscalRange = getFiscalRangeThai(fiscalYear)

  const rowsHtml = data.map((r,i)=>`
<tr>
<td>${i+1}</td>
<td>${r.member_id}</td>
<td>${r.title}${r.first_name} ${r.last_name}</td>
<td>${r.group || ''}</td>
<td>${r.member_status}</td>
<td>${r.meeting_date}</td>
</tr>
`).join('')

  const html = `
<html>
<head>
<style>
body{font-family:"TH Sarabun New",sans-serif;font-size:16px}
.header{display:flex;align-items:center}
.logo{width:80px}
.center{text-align:center;flex:1}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #000;padding:6px;text-align:center}
</style>
</head>
<body>

<div class="header">
  <img src="${COOP_LOGO_URL}" class="logo">
  <div class="center">
    <h2>รายงานสมาชิก ${f_status.value || 'ลาออก / เสียชีวิต'}</h2>
    ${f_group.value ? `<div>กลุ่ม ${f_group.value}</div>` : ''}
    <div><strong>ประจำปี ${fiscalYear}</strong></div>
    <div>${fiscalRange}</div>
  </div>
</div>

<table>
<tr>
  <th>ลำดับ</th>
  <th>รหัสสมาชิก</th>
  <th>ชื่อ-นามสกุล</th>
  <th>กลุ่ม</th>
  <th>สถานะ</th>
  <th>วันที่ประชุม</th>
</tr>
${rowsHtml}
</table>

</body>
</html>
`

  const w = window.open('')
  w.document.write(html)
  w.document.close()
  w.print()
}
</script>

<style>
.label{font-size:13px;color:#cbd5f5}
.input{background:#020617;border:1px solid #334155;padding:8px;border-radius:6px;width:100%}
.btn{padding:8px 20px;border-radius:8px}
.blue{background:#2563eb}
</style>

</body>
</html>
