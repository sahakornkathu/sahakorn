<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body { font-family:"Prompt",sans-serif; background:#f0f4f8; margin:20px; color:#333; }
h2 { text-align:center; color:#1e40af; margin-bottom:15px; }
form { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.08); }
input, select { display:block; width:100%; margin:10px 0; padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:14px; background:#f9fafb; }
button { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; background:#4a90e2; color:#fff; font-size:14px; margin-top:10px; }
button:hover { background:#357abd; }
.info-box { background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px; }
table { border-collapse: collapse; width:100%; max-width:800px; margin:20px auto; font-size:13px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
th, td { border:1px solid #e2e8f0; padding:6px 8px; text-align:center; }
th { background:#4a90e2; color:#fff; }
tr:nth-child(even){ background:#f9fafb; }
tr:hover{ background:#edf2f7; }
button.edit { background:#4a90e2; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.edit:hover { background:#357abd; }
button.delete { background:#f56565; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.delete:hover { background:#c53030; }
</style>
</head>
<body>

<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>

<form id="exitForm">
  <input type="text" id="member_id_input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" required>
  <select id="member_status" required>
    <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
    <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
    <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
  </select>

  <div class="info-box" id="memberInfo" style="display:none;">
    <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="fullname"></span></p>
    <p><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°:</strong> <span id="groupname"></span></p>
  </div>

  <input type="date" id="meeting_date" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°">
  <input type="number" step="0.01" id="share_amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏∏‡πâ‡∏ô">
  <input type="date" id="receive_date" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">

  <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</form>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
<table id="exitTable">
  <thead>
    <tr>
      <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏∏‡πâ‡∏ô</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const memberIdInput = document.getElementById('member_id_input');
const memberStatusSelect = document.getElementById('member_status');
const exitForm = document.getElementById('exitForm');
const memberInfo = document.getElementById('memberInfo');
const fullnameEl = document.getElementById('fullname');
const groupnameEl = document.getElementById('groupname');
const exitTableBody = document.querySelector('#exitTable tbody');

// --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡∏≤‡∏° member_id ---
async function fetchMember(member_id){
  if(!member_id) return null;
  const { data, error } = await supabase.from('members')
    .select('member_id,first_name,last_name,"group"')
    .eq('member_id', member_id)
    .single();
  if(error) return null;
  return data;
}

// --- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ---
memberIdInput.addEventListener('blur', async ()=>{
  const member_id = memberIdInput.value.trim();
  if(!member_id){ memberInfo.style.display='none'; return; }
  const member = await fetchMember(member_id);
  if(!member){ 
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ'); 
    memberInfo.style.display='none';
    return;
  }
  fullnameEl.textContent = member.first_name + ' ' + member.last_name;
  groupnameEl.textContent = member.group;
  memberInfo.style.display='block';
});

// --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
exitForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const member_id = memberIdInput.value.trim();
  const status = memberStatusSelect.value;
  if(!member_id || !status) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

  const member = await fetchMember(member_id);
  if(!member) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ');

  const payload = {
    member_id,
    first_name: member.first_name,
    last_name: member.last_name,
    group: member.group,
    member_status: status,
    meeting_date: document.getElementById('meeting_date').value || null,
    share_amount: document.getElementById('share_amount').value ? Number(document.getElementById('share_amount').value) : null,
    receive_date: document.getElementById('receive_date').value || null
  };

  try{
    const { error } = await supabase.from('member_exit').upsert([payload], { onConflict: ['member_id'] });
    if(error) throw error;
    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    exitForm.reset();
    memberInfo.style.display='none';
    loadExitTable();
  }catch(err){
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message);
  }
});

// --- ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
async function loadExitTable(){
  const { data, error } = await supabase.from('member_exit')
    .select('*')
    .order('member_id', { ascending:true });
  if(error){ alert('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message); return; }
  exitTableBody.innerHTML='';
  data.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${row.member_id}</td>
      <td>${row.first_name} ${row.last_name}</td>
      <td>${row.group}</td>
      <td>${row.member_status}</td>
      <td>${row.meeting_date || ''}</td>
      <td>${row.share_amount ?? ''}</td>
      <td>${row.receive_date || ''}</td>
      <td><button onclick="deleteExit('${row.member_id}')">‡∏•‡∏ö</button></td>
    `;
    exitTableBody.appendChild(tr);
  });
}

// --- ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
window.deleteExit = async (member_id)=>{
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return;
  const { error } = await supabase.from('member_exit').delete().eq('member_id', member_id);
  if(error) return alert('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message);
  loadExitTable();
};

// --- Init ---
loadExitTable();
</script>

</body>
</html>
