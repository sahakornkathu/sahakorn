<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ประวัติสมาชิกลาออก / เสียชีวิต</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-slate-100 p-6">
<div class="max-w-6xl mx-auto space-y-6">

<h1 class="text-xl font-bold text-center text-orange-400">
  ประวัติลาออก / เสียชีวิต (แก้ไขย้อนหลังได้)
</h1>

<!-- ===== TABLE ===== -->
<div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
<table class="w-full text-sm text-center">
<thead class="bg-slate-700">
<tr>
  <th>รหัส</th>
  <th>ชื่อ</th>
  <th>กลุ่ม</th>
  <th>สถานะ</th>
  <th>วันที่ประชุม</th>
  <th>หุ้น</th>
  <th>วันที่รับเงิน</th>
  <th>จัดการ</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<!-- ===== EDIT MODAL ===== -->
<div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
  <div class="bg-slate-800 p-6 rounded-xl w-full max-w-md space-y-4">
    <h2 class="text-lg font-bold text-yellow-400 text-center">แก้ไขรายการย้อนหลัง</h2>

    <input type="hidden" id="exit_id">

    <div>
      <label class="label">สถานะ</label>
      <select id="edit_status" class="input">
        <option value="ลาออก">ลาออก</option>
        <option value="เสียชีวิต">เสียชีวิต</option>
      </select>
    </div>

    <div>
      <label class="label">วันที่ประชุม</label>
      <input id="edit_meeting" type="date" class="input">
    </div>

    <div>
      <label class="label">จำนวนหุ้น</label>
      <input id="edit_share" type="number" class="input">
    </div>

    <div>
      <label class="label">วันที่รับเงิน</label>
      <input id="edit_receive" type="date" class="input">
    </div>

    <div class="flex justify-center gap-4 pt-2">
      <button class="btn yellow" onclick="saveEdit()">บันทึก</button>
      <button class="btn gray" onclick="closeModal()">ยกเลิก</button>
    </div>
  </div>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const db = createClient(SUPABASE_URL, SUPABASE_KEY)

let currentMemberId = null

async function loadHistory(){
  const { data } = await db
    .from('member_exit')
    .select('*')
    .order('meeting_date', { ascending: false })

  const rows = document.getElementById('rows')
  rows.innerHTML = ''

  data.forEach(r=>{
    rows.innerHTML += `
    <tr class="border-b border-slate-700 hover:bg-slate-700">
      <td>${r.member_id}</td>
      <td>${r.title || ''}${r.first_name} ${r.last_name}</td>
      <td>${r.group || ''}</td>
      <td class="${r.member_status==='เสียชีวิต'?'text-red-400':'text-orange-400'}">
        ${r.member_status}
      </td>
      <td>${r.meeting_date || '-'}</td>
      <td>${r.share_amount || '-'}</td>
      <td>${r.receive_date || '-'}</td>
      <td>
        <button class="text-blue-400" onclick='openEdit(${JSON.stringify(r)})'>
          แก้ไข
        </button>
      </td>
    </tr>`
  })
}

window.openEdit = r=>{
  exit_id.value = r.id
  edit_status.value = r.member_status
  edit_meeting.value = r.meeting_date || ''
  edit_share.value = r.share_amount || ''
  edit_receive.value = r.receive_date || ''
  currentMemberId = r.member_id
  modal.classList.remove('hidden')
  modal.classList.add('flex')
}

window.closeModal = ()=>{
  modal.classList.add('hidden')
}

/* ===== SAVE EDIT + SYNC STATUS ===== */
window.saveEdit = async ()=>{
  await db.from('member_exit').update({
    member_status: edit_status.value,
    meeting_date: edit_meeting.value || null,
    share_amount: edit_share.value || null,
    receive_date: edit_receive.value || null
  }).eq('id', exit_id.value)

  // ดึง record ล่าสุดของ member
  const { data: latest } = await db
    .from('member_exit')
    .select('member_status')
    .eq('member_id', currentMemberId)
    .order('meeting_date', { ascending: false })
    .limit(1)
    .single()

  if(latest){
    await db.from('members')
      .update({ member_status: latest.member_status })
      .eq('member_id', currentMemberId)
  }

  closeModal()
  loadHistory()
}

loadHistory()
</script>

<style>
.input{width:100%;padding:8px;border-radius:6px;background:#020617;border:1px solid #334155}
.label{font-size:14px;color:#cbd5f5}
.btn{padding:6px 16px;border-radius:8px}
.btn.yellow{background:#ca8a04}
.btn.gray{background:#475569}
</style>

</body>
</html>
