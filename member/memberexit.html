<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<style>
  body { font-family: "TH Sarabun New", sans-serif; margin: 20px; }
  h2 { margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  button { padding: 5px 10px; margin: 5px; }
  .dashboard {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
  }
  .card {
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    background: #f9fafb;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    width: 200px;
  }
  .filter {
    margin-bottom: 10px;
    text-align: center;
  }
</style>
</head>
<body>

<h2>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>

<!-- Dashboard -->
<div class="filter">
  <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <input type="date" id="startDate"></label>
  <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: <input type="date" id="endDate"></label>
  <button onclick="loadDashboard()">üìä ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button onclick="printReport()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
</div>

<div class="dashboard">
  <div class="card">
    <h3>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</h3>
    <h1 id="countResign">0</h1>
  </div>
  <div class="card">
    <h3>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h3>
    <h1 id="countDeceased">0</h1>
  </div>
</div>
<canvas id="statusChart" height="100"></canvas>

<hr>

<!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
<h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
<table id="memberTable">
  <thead>
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<hr>

<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï -->
<h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h3>
<table id="exitTable">
  <thead>
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// === CONFIG SUPABASE ===
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";  // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";              // üëà ‡πÉ‡∏™‡πà Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let chart;

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
document.addEventListener('DOMContentLoaded', () => {
  loadMembers();
  loadExitHistory();
  loadDashboard();
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
async function loadMembers(){
  const {data: members, error} = await client.from('members').select('*');
  if(error){ console.error(error); return; }

  // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô member_exit ‡πÅ‡∏•‡πâ‡∏ß
  const {data: exits} = await client.from('member_exit').select('member_id');
  const exitedIds = exits ? exits.map(e => e.member_id) : [];

  const tbody = document.querySelector("#memberTable tbody");
  tbody.innerHTML = "";

  members.forEach(m => {
    const tr = document.createElement("tr");
    const disabled = exitedIds.includes(m.member_id);
    tr.innerHTML = `
      <td>${m.member_id}</td>
      <td>${m.first_name}</td>
      <td>${m.last_name}</td>
      <td>${m.group}</td>
      <td>${m.member_status}</td>
      <td>
        <button ${disabled ? 'disabled' : ''} onclick="saveExit('${m.member_id}','‡∏•‡∏≤‡∏≠‡∏≠‡∏Å')">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</button>
        <button ${disabled ? 'disabled' : ''} onclick="saveExit('${m.member_id}','‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï')">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
async function saveExit(member_id, status){
  const today = new Date().toISOString().split('T')[0];
  const {data: member} = await client.from('members').select('*').eq('member_id', member_id).single();
  if(!member) return;

  const { error } = await client.from('member_exit').insert({
    member_id: member.member_id,
    first_name: member.first_name,
    last_name: member.last_name,
    group: member.group,
    meeting_date: today,
    share_amount: 0,
    receive_date: today,
    member_status: status
  });
  if(error){ alert("‚ùå " + error.message); return; }

  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  loadMembers();
  loadExitHistory();
  loadDashboard();
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
async function loadExitHistory(){
  const {data, error} = await client.from('member_exit').select('*').order('receive_date', {ascending:false});
  if(error){ console.error(error); return; }

  const tbody = document.querySelector("#exitTable tbody");
  tbody.innerHTML = "";
  data.forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.member_id}</td>
      <td>${d.first_name}</td>
      <td>${d.last_name}</td>
      <td>${d.group}</td>
      <td>${d.member_status}</td>
      <td>${d.receive_date}</td>
      <td><button onclick="deleteExit(${d.id})">‡∏•‡∏ö</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function deleteExit(id){
  if(!confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) return;
  await client.from('member_exit').delete().eq('id', id);
  loadExitHistory();
  loadMembers();
  loadDashboard();
}

// === Dashboard ===
async function loadDashboard(){
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;

  let query = client.from('member_exit').select('member_id, member_status, receive_date');
  if(startDate && endDate){
    query = query.gte('receive_date', startDate).lte('receive_date', endDate);
  } else if(startDate){
    query = query.gte('receive_date', startDate);
  } else if(endDate){
    query = query.lte('receive_date', endDate);
  }

  const {data, error} = await query;
  if(error){ console.error(error); return; }

  const countResign = data.filter(d=>d.member_status==='‡∏•‡∏≤‡∏≠‡∏≠‡∏Å').length;
  const countDeceased = data.filter(d=>d.member_status==='‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï').length;

  document.getElementById('countResign').innerText = countResign;
  document.getElementById('countDeceased').innerText = countDeceased;

  const ctx = document.getElementById('statusChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:['‡∏•‡∏≤‡∏≠‡∏≠‡∏Å','‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'],
      datasets:[{
        label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
        data:[countResign,countDeceased],
        backgroundColor:['#3B82F6','#EF4444']
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

// === ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ===
async function printReport(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // ‡πÉ‡∏™‡πà‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡πÄ‡∏•‡πá‡∏Å ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏´‡∏±‡∏ß‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤)
  const logoUrl = 'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2024.png'; // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÑ‡∏î‡πâ
  const logo = await loadImage(logoUrl);
  doc.addImage(logo, 'PNG', 10, 5, 20, 20); // ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏û‡∏≠‡∏î‡∏µ

  doc.setFontSize(16);
  doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï', 105, 20, { align: 'center' });

  const { data } = await client.from('member_exit').select('*').order('receive_date', {ascending:false});
  const rows = data.map((d, i) => [
    i+1,
    d.member_id,
    d.first_name + " " + d.last_name,
    d.group,
    d.member_status,
    d.receive_date
  ]);

  doc.autoTable({
    startY: 30,
    head: [['#','‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•','‡∏Å‡∏•‡∏∏‡πà‡∏°','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']],
    body: rows,
  });

  doc.save('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å_‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï.pdf');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function loadImage(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

</script>
</body>
</html>
