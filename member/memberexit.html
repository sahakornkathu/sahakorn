<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï + Dashboard + ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6">üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï + Dashboard + ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>

  <!-- Dashboard -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-4">üìä Dashboard</h2>
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
      <input type="date" id="startDate" class="border rounded p-2 flex-1">
      <input type="date" id="endDate" class="border rounded p-2 flex-1">
      <button onclick="loadDashboard()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 w-full sm:w-auto">üîÑ ‡πÇ‡∏´‡∏•‡∏î</button>
    </div>
    <div class="grid grid-cols-2 gap-4 sm:gap-6 mb-4">
      <div class="bg-gray-100 p-4 rounded shadow text-center">
        <h2 class="text-lg font-semibold">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</h2>
        <p id="countResign" class="text-2xl sm:text-3xl font-bold mt-2">0</p>
      </div>
      <div class="bg-gray-100 p-4 rounded shadow text-center">
        <h2 class="text-lg font-semibold">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
        <p id="countDeceased" class="text-2xl sm:text-3xl font-bold mt-2">0</p>
      </div>
    </div>
    <div class="bg-white p-2 sm:p-4 rounded shadow">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
  <div class="mb-4">
    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." 
      onkeyup="filterMembers()" 
      class="w-full p-2 border rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-400" />
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
  <div class="overflow-x-auto mb-2">
    <table class="min-w-full bg-white shadow rounded">
      <thead class="bg-indigo-600 text-white">
        <tr>
          <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-3">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
          <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-3">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="p-3">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
          <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
          <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
        </tr>
      </thead>
      <tbody id="memberBody" class="divide-y"></tbody>
    </table>
  </div>

  <!-- Pagination ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
  <div class="flex justify-between my-4">
    <button id="prevPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <span id="pageInfoMembers" class="font-semibold"></span>
    <button id="nextPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
  </div>

  <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
  <h2 class="text-xl font-semibold mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>

  <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
  <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-2">
    <input type="date" id="printStartDate" class="border rounded p-2 flex-1">
    <input type="date" id="printEndDate" class="border rounded p-2 flex-1">
    <select id="printStatus" class="border rounded p-2 flex-1">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>
    <button onclick="printReport()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded w-full sm:w-auto">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå HTML</button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white shadow rounded">
      <thead class="bg-gray-700 text-white">
        <tr>
          <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-3">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
          <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-3">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="p-3">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
          <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
          <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="historyBody" class="divide-y"></tbody>
    </table>
  </div>

</div>

<script>
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentPageMembers=1,pageSizeMembers=10,memberData=[];
let currentPageHistory=1,pageSizeHistory=10,historyData=[];

// ==================== MEMBERS ====================
async function loadMembers(page=1){
  const { data: exitedData } = await client.from('member_exit').select('member_id');
  const exitedIds = exitedData.map(e=>e.member_id);
  const from=(page-1)*pageSizeMembers,to=page*pageSizeMembers-1;

  const { data, error, count } = await client.from('members')
    .select('member_id, title, first_name, last_name, group, member_status',{count:'exact'})
    .in('member_status',['‡∏•‡∏≤‡∏≠‡∏≠‡∏Å','‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])
    .range(from,to);
  if(error){console.error(error);return;}
  memberData=data;
  renderMemberTable(data,exitedIds);

  const totalPages=Math.ceil(count/pageSizeMembers);
  document.getElementById('pageInfoMembers').innerText=`‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;
}

function renderMemberTable(data,exitedIds){
  const tbody=document.getElementById('memberBody');
  tbody.innerHTML='';
  data.forEach(m=>{
    const isExited=exitedIds.includes(m.member_id);
    const row=document.createElement('tr');
    row.className=isExited?"bg-gray-200":"hover:bg-gray-100";
    row.innerHTML=`
      <td class="p-2">${m.member_id}</td>
      <td class="p-2">${m.title||''}</td>
      <td class="p-2">${m.first_name}</td>
      <td class="p-2">${m.last_name}</td>
      <td class="p-2">${m.group}</td>
      <td class="p-2">${m.member_status}</td>
      <td class="p-2"><input type="date" id="meeting_date_${m.member_id}" class="border rounded p-1 w-full" ${isExited?'disabled':''}></td>
      <td class="p-2"><input type="number" id="share_amount_${m.member_id}" class="border rounded p-1 w-full" ${isExited?'disabled':''}></td>
      <td class="p-2"><input type="date" id="receive_date_${m.member_id}" class="border rounded p-1 w-full" ${isExited?'disabled':''}></td>
      <td class="p-2">
        <button onclick="saveMemberExit('${m.member_id}','${m.first_name}','${m.last_name}','${m.group}','${m.member_status}','${m.title||''}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" ${isExited?'disabled':''}>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </td>`;
    tbody.appendChild(row);
  });
}

async function saveMemberExit(member_id,first_name,last_name,group,member_status,title){
  const meeting_date=document.getElementById(`meeting_date_${member_id}`).value;
  const share_amount=document.getElementById(`share_amount_${member_id}`).value;
  const receive_date=document.getElementById(`receive_date_${member_id}`).value;
  if(!meeting_date||!share_amount||!receive_date){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');return;}

  const {error}=await client.from('member_exit').insert([{member_id,title,first_name,last_name,group,member_status,meeting_date,share_amount,receive_date}]);
  if(error){alert(error.message);return;}
  alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${title}${first_name} ${last_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadMembers(currentPageMembers);
  loadHistory(currentPageHistory);
}

// ==================== HISTORY / PRINT ====================
// (‡∏Ñ‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö title ‡πÅ‡∏•‡πâ‡∏ß)

loadMembers(currentPageMembers);
</script>
</body>
</html>
