<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï + Dashboard + ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="container mx-auto p-6">
<h1 class="text-2xl font-bold mb-6">üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï + Dashboard + ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>

<!-- Dashboard -->
<div class="bg-white p-4 rounded shadow mb-6">
  <h2 class="text-xl font-semibold mb-4">üìä Dashboard</h2>
  <div class="flex gap-4 mb-4">
    <input type="date" id="startDate" class="border rounded p-2">
    <input type="date" id="endDate" class="border rounded p-2">
    <button onclick="loadDashboard()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">üîÑ ‡πÇ‡∏´‡∏•‡∏î</button>
  </div>
  <div class="grid grid-cols-2 gap-6 mb-6">
    <div class="bg-gray-100 p-4 rounded shadow text-center">
      <h2 class="text-lg font-semibold">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</h2>
      <p id="countResign" class="text-3xl font-bold mt-2">0</p>
    </div>
    <div class="bg-gray-100 p-4 rounded shadow text-center">
      <h2 class="text-lg font-semibold">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
      <p id="countDeceased" class="text-3xl font-bold mt-2">0</p>
    </div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <canvas id="statusChart"></canvas>
  </div>
</div>

<!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
<div class="mb-4">
  <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." onkeyup="filterMembers()" class="w-full p-2 border rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-400" />
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
<div class="overflow-x-auto mb-2">
  <table class="min-w-full bg-white shadow rounded">
    <thead class="bg-indigo-600 text-white">
      <tr>
        <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
        <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-3">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th class="p-3">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
        <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th class="p-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
      </tr>
    </thead>
    <tbody id="memberBody" class="divide-y"></tbody>
  </table>
</div>

<div class="flex justify-between my-4">
  <button id="prevPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <span id="pageInfoMembers" class="font-semibold"></span>
  <button id="nextPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
</div>

<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
<h2 class="text-xl font-semibold mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
<div class="flex gap-4 mb-2">
  <input type="date" id="printStartDate" class="border rounded p-2">
  <input type="date" id="printEndDate" class="border rounded p-2">
  <button onclick="printReport()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå HTML</button>
  <button onclick="printPDFReport()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
</div>

<div class="overflow-x-auto">
  <table class="min-w-full bg-white shadow rounded">
    <thead class="bg-gray-700 text-white">
      <tr>
        <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
        <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-3">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th class="p-3">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
        <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th class="p-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="historyBody" class="divide-y"></tbody>
  </table>
</div>

<div class="flex justify-between my-4">
  <button id="prevPageHistory" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <span id="pageInfoHistory" class="font-semibold"></span>
  <button id="nextPageHistory" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
</div>

</div>

<script>
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y"; // ‡πÉ‡∏™‡πà key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let chart = null;
let currentPageMembers = 1, pageSizeMembers = 10, memberData=[];
let currentPageHistory = 1, pageSizeHistory = 10, historyData=[];

// ==================== Base64 ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢ =================
const THSarabunNormal = `PASTE_BASE64_TTF_HERE`;

// ==================== FUNCTIONS ====================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadMembers, renderMemberTable, filterMembers, saveMemberExit, loadHistory, renderHistoryTable, updateHistory, deleteHistory, loadDashboard, printReport ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

// ==================== PRINT PDF ====================
async function printPDFReport(){
  const startDate = document.getElementById('printStartDate').value;
  const endDate = document.getElementById('printEndDate').value;
  
  let query = client.from('member_exit').select('*').order('receive_date',{ascending:false});
  if(startDate) query = query.gte('receive_date',startDate);
  if(endDate) query = query.lte('receive_date',endDate);
  const {data,error} = await query;
  if(error){alert(error.message); return;}

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢
  doc.addFileToVFS("THSarabun.ttf", THSarabunNormal);
  doc.addFont("THSarabun.ttf", "THSarabun", "normal");
  doc.setFont("THSarabun");

  doc.setFontSize(18);
  doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï", 105, 15, {align:"center"});
  doc.setFontSize(12);
  doc.text(`‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${startDate||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'} ‡∏ñ‡∏∂‡∏á ${endDate||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}`, 105, 23, {align:"center"});

  const tableColumn = ["‡∏£‡∏´‡∏±‡∏™","‡∏ä‡∏∑‡πà‡∏≠","‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•","‡∏Å‡∏•‡∏∏‡πà‡∏°","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô"];
  const tableRows = [];

  data.forEach(item=>{
    const row = [
      item.member_id,
      item.first_name,
      item.last_name,
      item.group,
      item.member_status,
      item.meeting_date,
      item.share_amount,
      item.receive_date
    ];
    tableRows.push(row);
  });

  doc.autoTable({
    head: [tableColumn],
    body: tableRows,
    startY: 30,
    theme: 'grid',
    headStyles:{fillColor:[59,130,246]},
    styles:{font:'THSarabun', fontSize:10}
  });

  doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å_${new Date().toISOString().split('T')[0]}.pdf`);
}
</script>
</body>
</html>
