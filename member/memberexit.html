<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 p-6">

  <h1 class="text-2xl font-bold text-center mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h1>

  <!-- Dashboard -->
  <div class="grid grid-cols-3 gap-4 mb-6 text-center">
    <div class="bg-blue-200 p-4 rounded-xl shadow">
      <p class="font-bold text-lg">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
      <p id="totalMembers" class="text-3xl font-bold text-blue-800">0</p>
    </div>
    <div class="bg-yellow-200 p-4 rounded-xl shadow">
      <p class="font-bold text-lg">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</p>
      <p id="resignedMembers" class="text-3xl font-bold text-yellow-800">0</p>
    </div>
    <div class="bg-red-200 p-4 rounded-xl shadow">
      <p class="font-bold text-lg">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</p>
      <p id="deceasedMembers" class="text-3xl font-bold text-red-800">0</p>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -->
  <h2 class="text-xl font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
  <table class="w-full bg-white shadow rounded-lg" id="memberTable">
    <thead>
      <tr class="bg-gray-200 text-gray-700">
        <th class="p-2">‡∏£‡∏´‡∏±‡∏™</th>
        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th class="p-2">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th class="p-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th class="p-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
      </tr>
    </thead>
    <tbody id="memberList"></tbody>
  </table>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Print -->
  <div class="text-center mt-6">
    <button onclick="printReport()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-xl shadow">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <script>
    // üü¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
    const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard
    async function loadDashboard() {
      const currentYear = new Date().getFullYear();

      const { count: total } = await supabase.from('members').select('*', { count: 'exact' });
      const { count: resigned } = await supabase
        .from('member_exit')
        .select('*', { count: 'exact' })
        .gte('meeting_date', `${currentYear}-01-01`)
        .lte('meeting_date', `${currentYear}-12-31`)
        .eq('member_status', '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å');
      const { count: deceased } = await supabase
        .from('member_exit')
        .select('*', { count: 'exact' })
        .gte('meeting_date', `${currentYear}-01-01`)
        .lte('meeting_date', `${currentYear}-12-31`)
        .eq('member_status', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï');

      document.getElementById('totalMembers').textContent = total || 0;
      document.getElementById('resignedMembers').textContent = resigned || 0;
      document.getElementById('deceasedMembers').textContent = deceased || 0;
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    async function loadMembers() {
      const { data, error } = await supabase
        .from('members')
        .select('member_id, first_name, last_name, group, member_status')
        .in('member_status', ['‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï']);

      if (error) {
        console.error("‚ùå Error loading members:", error);
        return;
      }

      const table = document.getElementById('memberList');
      table.innerHTML = '';

      data.forEach(member => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 text-center">${member.member_id}</td>
          <td class="p-2">${member.first_name}</td>
          <td class="p-2">${member.last_name}</td>
          <td class="p-2 text-center">${member.group}</td>
          <td class="p-2 text-center">${member.member_status}</td>
          <td class="p-2 text-center">
            <button onclick="saveMemberExit('${member.member_id}', '${member.first_name}', '${member.last_name}', '${member.group}', '${member.member_status}')" 
              class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </td>
        `;
        table.appendChild(row);
      });
    }

    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
    async function saveMemberExit(id, first, last, group, status) {
      const meetingDate = new Date().toISOString().split('T')[0];

      const { error } = await supabase.from('member_exit').insert([{
        member_id: id,
        first_name: first,
        last_name: last,
        group: group,
        meeting_date: meetingDate,
        member_status: status
      }]);

      if (error) {
        alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        console.error(error);
      } else {
        alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        loadMembers();
        loadDashboard();
      }
    }

    // ‚úÖ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    async function printReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const logo = "https://upload.wikimedia.org/wikipedia/commons/4/4f/Logo_Brand_Example.png";

      doc.addImage(logo, "PNG", 15, 10, 20, 20);
      doc.setFontSize(16);
      doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï", 40, 22);

      const { data } = await supabase.from('member_exit').select('*').order('meeting_date', { ascending: false });

      const rows = data.map((m, i) => [
        i + 1,
        m.member_id,
        `${m.first_name} ${m.last_name}`,
        m.group,
        m.member_status,
        m.meeting_date
      ]);

      doc.autoTable({
        head: [['#', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏Å‡∏•‡∏∏‡πà‡∏°', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°']],
        body: rows,
        startY: 40,
        styles: { fontSize: 12 },
      });

      doc.save("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å.pdf");
    }

    loadDashboard();
    loadMembers();
  </script>

</body>
</html>
