<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h1>

  <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <div class="mb-4">
    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." 
      onkeyup="filterMembers()" 
      class="w-full p-2 border rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-400" />
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
  <div class="overflow-x-auto mb-2">
    <table class="min-w-full bg-white shadow rounded">
      <thead class="bg-indigo-600 text-white">
        <tr>
          <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-3">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="p-3">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
          <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
          <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
        </tr>
      </thead>
      <tbody id="memberBody" class="divide-y"></tbody>
    </table>
  </div>

  <!-- Pagination ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
  <div class="flex justify-between my-4">
    <button id="prevPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <span id="pageInfoMembers" class="font-semibold"></span>
    <button id="nextPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
  </div>

  <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
  <h2 class="text-xl font-semibold mb-3">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white shadow rounded">
      <thead class="bg-gray-700 text-white">
        <tr>
          <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-3">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="p-3">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
          <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
          <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th class="p-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="historyBody" class="divide-y"></tbody>
    </table>
  </div>

  <!-- Pagination ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
  <div class="flex justify-between my-4">
    <button id="prevPageHistory" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <span id="pageInfoHistory" class="font-semibold"></span>
    <button id="nextPageHistory" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
  </div>

</div>

<script>
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co"; // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";                           // ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å Pagination
let currentPageMembers = 1;
const pageSizeMembers = 10;
let memberData = [];

// ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Pagination
let currentPageHistory = 1;
const pageSizeHistory = 10;
let historyData = [];

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å disabled)
async function loadMembers(page = 1) {
  // ‡∏î‡∏∂‡∏á member_id ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô member_exit
  const { data: exitedData, error: exitedError } = await client
    .from('member_exit')
    .select('member_id');

  if (exitedError) { console.error(exitedError); return; }

  const exitedIds = exitedData.map(e => e.member_id);

  // Pagination
  const from = (page - 1) * pageSizeMembers;
  const to = page * pageSizeMembers - 1;

  // ‡∏î‡∏∂‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
  const { data, error, count } = await client
    .from('members')
    .select('member_id, first_name, last_name, group, member_status', { count: 'exact' })
    .in('member_status', ['‡∏•‡∏≤‡∏≠‡∏≠‡∏Å','‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])
    .range(from, to);

  if (error) { console.error(error); return; }

  memberData = data;
  renderMemberTable(data, exitedIds);

  const totalPages = Math.ceil(count / pageSizeMembers);
  document.getElementById('pageInfoMembers').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;
  document.getElementById('prevPageMembers').disabled = page === 1;
  document.getElementById('nextPageMembers').disabled = page === totalPages;
}

// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
function renderMemberTable(data, exitedIds) {
  const tbody = document.getElementById('memberBody');
  tbody.innerHTML = '';
  data.forEach(m => {
    const isExited = exitedIds.includes(m.member_id); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    const row = document.createElement('tr');
    row.className = "hover:bg-gray-100 transition";
    row.innerHTML = `
      <td class="p-2">${m.member_id}</td>
      <td class="p-2">${m.first_name}</td>
      <td class="p-2">${m.last_name}</td>
      <td class="p-2">${m.group}</td>
      <td class="p-2">${m.member_status}</td>
      <td class="p-2"><input type="date" id="meeting_date_${m.member_id}" class="border rounded p-1 w-full" ${isExited ? 'disabled' : ''}></td>
      <td class="p-2"><input type="number" id="share_amount_${m.member_id}" class="border rounded p-1 w-full" ${isExited ? 'disabled' : ''}></td>
      <td class="p-2"><input type="date" id="receive_date_${m.member_id}" class="border rounded p-1 w-full" ${isExited ? 'disabled' : ''}></td>
      <td class="p-2">
        <button onclick="saveMemberExit('${m.member_id}','${m.first_name}','${m.last_name}','${m.group}','${m.member_status}')"
          class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded"
          ${isExited ? 'disabled class="bg-gray-400 cursor-not-allowed"' : ''}>
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
function filterMembers() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  renderMemberTable(memberData.filter(m =>
    m.first_name.toLowerCase().includes(q) ||
    m.last_name.toLowerCase().includes(q) ||
    m.member_id.toLowerCase().includes(q)
  ));
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
async function saveMemberExit(member_id, first_name, last_name, group, member_status) {
  const meeting_date = document.getElementById(`meeting_date_${member_id}`).value;
  const share_amount = document.getElementById(`share_amount_${member_id}`).value;
  const receive_date = document.getElementById(`receive_date_${member_id}`).value;

  if (!meeting_date || !share_amount || !receive_date) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

  const { error } = await client.from('member_exit').insert([{
    member_id, first_name, last_name, group, member_status,
    meeting_date, share_amount, receive_date
  }]);
  if (error) { alert(error.message); return; }

  alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${first_name} ${last_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadMembers(currentPageMembers);
  loadHistory(currentPageHistory);
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏£‡πâ‡∏≠‡∏° Pagination
async function loadHistory(page = 1) {
  const from = (page - 1) * pageSizeHistory;
  const to = page * pageSizeHistory - 1;

  const { data, error, count } = await client
    .from('member_exit')
    .select('*', { count: 'exact' })
    .order('receive_date', {ascending:false})
    .range(from, to);

  if (error) { console.error(error); return; }

  historyData = data;
  renderHistoryTable(data);

  const totalPages = Math.ceil(count / pageSizeHistory);
  document.getElementById('pageInfoHistory').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;
  document.getElementById('prevPageHistory').disabled = page === 1;
  document.getElementById('nextPageHistory').disabled = page === totalPages;
}

// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
function renderHistoryTable(data) {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';
  data.forEach(item => {
    const row = document.createElement('tr');
    row.className = "hover:bg-gray-100 transition";
    row.innerHTML = `
      <td class="p-2">${item.member_id}</td>
      <td class="p-2"><input type="text" id="edit_fname_${item.member_id}" value="${item.first_name}" class="border rounded p-1 w-full"></td>
      <td class="p-2"><input type="text" id="edit_lname_${item.member_id}" value="${item.last_name}" class="border rounded p-1 w-full"></td>
      <td class="p-2"><input type="text" id="edit_group_${item.member_id}" value="${item.group}" class="border rounded p-1 w-full"></td>
      <td class="p-2">${item.member_status}</td>
      <td class="p-2"><input type="date" id="edit_meeting_${item.member_id}" value="${item.meeting_date}" class="border rounded p-1 w-full"></td>
      <td class="p-2"><input type="number" id="edit_share_${item.member_id}" value="${item.share_amount}" class="border rounded p-1 w-full"></td>
      <td class="p-2"><input type="date" id="edit_receive_${item.member_id}" value="${item.receive_date}" class="border rounded p-1 w-full"></td>
      <td class="p-2">
        <button onclick="updateHistory('${item.member_id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded mb-1">üíæ Save</button>
        <button onclick="deleteHistory('${item.member_id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">üóëÔ∏è Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
async function updateHistory(member_id) {
  const updated = {
    first_name: document.getElementById(`edit_fname_${member_id}`).value,
    last_name: document.getElementById(`edit_lname_${member_id}`).value,
    group: document.getElementById(`edit_group_${member_id}`).value,
    meeting_date: document.getElementById(`edit_meeting_${member_id}`).value,
    share_amount: document.getElementById(`edit_share_${member_id}`).value,
    receive_date: document.getElementById(`edit_receive_${member_id}`).value
  };

  const { error } = await client.from('member_exit').update(updated).eq('member_id', member_id);
  if (error) { alert(error.message); return; }
  alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  loadHistory(currentPageHistory);
}

// ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
async function deleteHistory(member_id) {
  if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  const { error } = await client.from('member_exit').delete().eq('member_id', member_id);
  if (error) { alert(error.message); return; }
  alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  loadMembers(currentPageMembers);
  loadHistory(currentPageHistory);
}

// ‡∏õ‡∏∏‡πà‡∏° pagination ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
document.getElementById('prevPageMembers').addEventListener('click', () => {
  if (currentPageMembers > 1) {
    currentPageMembers--;
    loadMembers(currentPageMembers);
  }
});
document.getElementById('nextPageMembers').addEventListener('click', () => {
  currentPageMembers++;
  loadMembers(currentPageMembers);
});

// ‡∏õ‡∏∏‡πà‡∏° pagination ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
document.getElementById('prevPageHistory').addEventListener('click', () => {
  if (currentPageHistory > 1) {
    currentPageHistory--;
    loadHistory(currentPageHistory);
  }
});
document.getElementById('nextPageHistory').addEventListener('click', () => {
  currentPageHistory++;
  loadHistory(currentPageHistory);
});

// ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
loadMembers(currentPageMembers);
loadHistory(currentPageHistory);
</script>
</body>
</html>
