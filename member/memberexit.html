<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>บันทึกสมาชิกลาออก / เสียชีวิต</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 p-6 text-slate-100">
<div class="max-w-4xl mx-auto">

<div class="bg-slate-800 border border-slate-700 rounded-xl p-6 space-y-6">
  <h1 class="text-xl font-bold text-center text-red-400">
    บันทึกสมาชิกลาออก / เสียชีวิต
  </h1>

  <!-- ===== FORM ===== -->
  <form id="exitForm" class="space-y-4">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <div>
        <label class="label">รหัสสมาชิก</label>
        <input id="member_id" type="text" required class="input">
      </div>

      <div>
        <label class="label">คำนำหน้า</label>
        <input id="title" class="input" readonly>
      </div>

      <div>
        <label class="label">ชื่อ</label>
        <input id="first_name" class="input" readonly>
      </div>

      <div>
        <label class="label">นามสกุล</label>
        <input id="last_name" class="input" readonly>
      </div>

      <div>
        <label class="label">กลุ่ม</label>
        <input id="group" class="input" readonly>
      </div>

      <div>
        <label class="label">สถานะ</label>
        <select id="member_status" class="input" required>
          <option value="">-- เลือก --</option>
          <option value="ลาออก">ลาออก</option>
          <option value="เสียชีวิต">เสียชีวิต</option>
        </select>
      </div>

      <div>
        <label class="label">วันที่ประชุม</label>
        <input id="meeting_date" type="date" class="input">
      </div>

      <div>
        <label class="label">จำนวนหุ้นคงเหลือ</label>
        <input id="share_amount" type="number" step="0.01" class="input">
      </div>

      <div>
        <label class="label">วันที่รับเงิน</label>
        <input id="receive_date" type="date" class="input">
      </div>

    </div>

    <div class="flex justify-center gap-4 pt-4">
      <button class="btn red" type="submit">บันทึกข้อมูล</button>
      <button class="btn gray" type="reset">ล้างฟอร์ม</button>
    </div>

  </form>

</div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const db = createClient(SUPABASE_URL, SUPABASE_KEY)

const memberIdInput = document.getElementById('member_id')

/* ===== โหลดข้อมูลสมาชิก ===== */
memberIdInput.addEventListener('blur', async ()=>{
  if(!memberIdInput.value) return

  const { data, error } = await db
    .from('members')
    .select('title, first_name, last_name, group')
    .eq('member_id', memberIdInput.value)
    .single()

  if(error || !data){
    alert('ไม่พบรหัสสมาชิก')
    document.getElementById('exitForm').reset()
    return
  }

  title.value = data.title
  first_name.value = data.first_name
  last_name.value = data.last_name
  group.value = data.group
})

/* ===== SUBMIT ===== */
document.getElementById('exitForm').addEventListener('submit', async e=>{
  e.preventDefault()

  const payload = {
    member_id: member_id.value,
    title: title.value,
    first_name: first_name.value,
    last_name: last_name.value,
    group: group.value,
    member_status: member_status.value,
    meeting_date: meeting_date.value || null,
    share_amount: share_amount.value || null,
    receive_date: receive_date.value || null
  }

  // 1) insert member_exit
  const { error: insertError } = await db
    .from('member_exit')
    .insert([payload])

  if(insertError){
    alert('บันทึก member_exit ไม่สำเร็จ')
    console.error(insertError)
    return
  }

  // 2) update members.status
  const { error: updateError } = await db
    .from('members')
    .update({ member_status: member_status.value })
    .eq('member_id', member_id.value)

  if(updateError){
    alert('อัปเดตสถานะสมาชิกไม่สำเร็จ')
    console.error(updateError)
    return
  }

  alert('บันทึกข้อมูลเรียบร้อย')
  e.target.reset()
})
</script>

<style>
.label{display:block;margin-bottom:4px;color:#cbd5f5}
.input{width:100%;padding:8px;border-radius:6px;background:#020617;border:1px solid #334155;color:white}
.btn{padding:8px 20px;border-radius:8px}
.btn.red{background:#dc2626}
.btn.gray{background:#475569}
</style>

</body>
</html>
