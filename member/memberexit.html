<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>р╕гр╕░р╕Ър╕Ър╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕ер╕▓р╕нр╕нр╕Б/р╣Ар╕кр╕╡р╕вр╕Кр╕╡р╕зр╕┤р╕Х + Dashboard + р╕гр╕▓р╕вр╕Зр╕▓р╕Щ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="container mx-auto p-6">
<h1 class="text-2xl font-bold mb-6">ЁЯУМ р╕гр╕░р╕Ър╕Ър╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕ер╕▓р╕нр╕нр╕Б/р╣Ар╕кр╕╡р╕вр╕Кр╕╡р╕зр╕┤р╕Х + Dashboard + р╕гр╕▓р╕вр╕Зр╕▓р╕Щ</h1>

<!-- Dashboard -->
<div class="bg-white p-4 rounded shadow mb-6">
  <h2 class="text-xl font-semibold mb-4">ЁЯУК Dashboard</h2>
  <div class="flex gap-4 mb-4">
    <input type="date" id="startDate" class="border rounded p-2">
    <input type="date" id="endDate" class="border rounded p-2">
    <button onclick="loadDashboard()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">ЁЯФД р╣Вр╕лр╕ер╕Ф</button>
  </div>
  <div class="grid grid-cols-2 gap-6 mb-6">
    <div class="bg-gray-100 p-4 rounded shadow text-center">
      <h2 class="text-lg font-semibold">р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕ер╕▓р╕нр╕нр╕Б</h2>
      <p id="countResign" class="text-3xl font-bold mt-2">0</p>
    </div>
    <div class="bg-gray-100 p-4 rounded shadow text-center">
      <h2 class="text-lg font-semibold">р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Ар╕кр╕╡р╕вр╕Кр╕╡р╕зр╕┤р╕Х</h2>
      <p id="countDeceased" class="text-3xl font-bold mt-2">0</p>
    </div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <canvas id="statusChart"></canvas>
  </div>
</div>

<!-- р╕Др╣Йр╕Щр╕лр╕▓ р╕кр╕бр╕▓р╕Кр╕┤р╕Б -->
<div class="mb-4">
  <input type="text" id="searchInput" placeholder="р╕Др╣Йр╕Щр╕лр╕▓р╕Кр╕╖р╣Ир╕нр╕лр╕гр╕╖р╕нр╕гр╕лр╕▒р╕кр╕кр╕бр╕▓р╕Кр╕┤р╕Б..." 
    onkeyup="filterMembers()" 
    class="w-full p-2 border rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-400" />
</div>

<!-- р╕Хр╕▓р╕гр╕▓р╕Зр╕кр╕бр╕▓р╕Кр╕┤р╕Б -->
<div class="overflow-x-auto mb-2">
  <table class="min-w-full bg-white shadow rounded">
    <thead class="bg-indigo-600 text-white">
      <tr>
        <th class="p-3">р╕гр╕лр╕▒р╕к</th>
        <th class="p-3">р╕Кр╕╖р╣Ир╕н</th>
        <th class="p-3">р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е</th>
        <th class="p-3">р╕Бр╕ер╕╕р╣Ир╕б</th>
        <th class="p-3">р╕кр╕Цр╕▓р╕Щр╕░</th>
        <th class="p-3">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Ыр╕гр╕░р╕Кр╕╕р╕б</th>
        <th class="p-3">р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ</th>
        <th class="p-3">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щ</th>
        <th class="p-3">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</th>
      </tr>
    </thead>
    <tbody id="memberBody" class="divide-y"></tbody>
  </table>
</div>

<!-- Pagination р╕кр╕бр╕▓р╕Кр╕┤р╕Б -->
<div class="flex justify-between my-4">
  <button id="prevPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">тЧА р╕Бр╣Ир╕нр╕Щр╕лр╕Щр╣Йр╕▓</button>
  <span id="pageInfoMembers" class="font-semibold"></span>
  <button id="nextPageMembers" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">р╕Цр╕▒р╕Фр╣Др╕Ы тЦ╢</button>
</div>

<!-- р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤ -->
<h2 class="text-xl font-semibold mb-2">ЁЯУЛ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</h2>

<!-- р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Бр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Юр╕┤р╕бр╕Юр╣М -->
<div class="flex gap-4 mb-2">
  <input type="date" id="printStartDate" class="border rounded p-2">
  <input type="date" id="printEndDate" class="border rounded p-2">
  <button onclick="printReport()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ЁЯЦия╕П р╕Юр╕┤р╕бр╕Юр╣М HTML</button>
  <button onclick="printPDFReport()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">ЁЯУД р╕Юр╕┤р╕бр╕Юр╣М PDF</button>
</div>

<div class="overflow-x-auto">
  <table class="min-w-full bg-white shadow rounded">
    <thead class="bg-gray-700 text-white">
      <tr>
        <th class="p-3">р╕гр╕лр╕▒р╕к</th>
        <th class="p-3">р╕Кр╕╖р╣Ир╕н</th>
        <th class="p-3">р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е</th>
        <th class="p-3">р╕Бр╕ер╕╕р╣Ир╕б</th>
        <th class="p-3">р╕кр╕Цр╕▓р╕Щр╕░</th>
        <th class="p-3">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Ыр╕гр╕░р╕Кр╕╕р╕б</th>
        <th class="p-3">р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ</th>
        <th class="p-3">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щ</th>
        <th class="p-3">р╕Ир╕▒р╕Фр╕Бр╕▓р╕г</th>
      </tr>
    </thead>
    <tbody id="historyBody" class="divide-y"></tbody>
  </table>
</div>

<!-- Pagination р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤ -->
<div class="flex justify-between my-4">
  <button id="prevPageHistory" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">тЧА р╕Бр╣Ир╕нр╕Щр╕лр╕Щр╣Йр╕▓</button>
  <span id="pageInfoHistory" class="font-semibold"></span>
  <button id="nextPageHistory" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">р╕Цр╕▒р╕Фр╣Др╕Ы тЦ╢</button>
</div>

</div>

<script>
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co"; // р╣Гр╕кр╣И URL р╕Вр╕нр╕Зр╕Др╕╕р╕У
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";                           // р╣Гр╕кр╣И KEY р╕Вр╕нр╕Зр╕Др╕╕р╕У
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let chart = null;
let currentPageMembers = 1, pageSizeMembers = 10, memberData=[];
let currentPageHistory = 1, pageSizeHistory = 10, historyData=[];

// ==================== Base64 р╕Яр╕нр╕Щр╕Хр╣Мр╣Др╕Чр╕в =================
const THSarabunNormal = `AAEAAAALAIAAAwAwT1MvMg8SAAACAAACABAAZEdQT1MwAAAB...`; // р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Фр╣Йр╕зр╕в Base64 р╣Ар╕Хр╣Зр╕б р╣Ж р╕Вр╕нр╕З THSarabun.ttf

// ==================== MEMBERS ====================
async function loadMembers(page = 1){
  const { data: exitedData } = await client.from('member_exit').select('member_id');
  const exitedIds = exitedData.map(e => e.member_id);
  const from = (page-1)*pageSizeMembers;
  const to = page*pageSizeMembers-1;

  const { data, error, count } = await client.from('members')
    .select('member_id, first_name, last_name, group, member_status', {count:'exact'})
    .in('member_status', ['р╕ер╕▓р╕нр╕нр╕Б','р╣Ар╕кр╕╡р╕вр╕Кр╕╡р╕зр╕┤р╕Х'])
    .range(from,to);
  if(error){console.error(error); return;}
  memberData = data;
  renderMemberTable(data, exitedIds);

  const totalPages = Math.ceil(count/pageSizeMembers);
  document.getElementById('pageInfoMembers').innerText = `р╕лр╕Щр╣Йр╕▓ ${page} / ${totalPages}`;
  document.getElementById('prevPageMembers').disabled = page===1;
  document.getElementById('nextPageMembers').disabled = page===totalPages;
}

function renderMemberTable(data, exitedIds){
  const tbody = document.getElementById('memberBody');
  tbody.innerHTML='';
  data.forEach(m=>{
    const isExited = exitedIds.includes(m.member_id);
    const row = document.createElement('tr');
    row.className = isExited ? "bg-gray-200" : "hover:bg-gray-100";
    row.innerHTML = `
      <td class="p-2">${m.member_id}</td>
      <td class="p-2">${m.first_name}</td>
      <td class="p-2">${m.last_name}</td>
      <td class="p-2">${m.group}</td>
      <td class="p-2">${m.member_status}</td>
      <td class="p-2"><input type="date" id="meeting_date_${m.member_id}" class="border rounded p-1 w-full" ${isExited?'disabled':''}></td>
      <td class="p-2"><input type="number" id="share_amount_${m.member_id}" class="border rounded p-1 w-full" ${isExited?'disabled':''}></td>
      <td class="p-2"><input type="date" id="receive_date_${m.member_id}" class="border rounded p-1 w-full" ${isExited?'disabled':''}></td>
      <td class="p-2">
        <button onclick="saveMemberExit('${m.member_id}','${m.first_name}','${m.last_name}','${m.group}','${m.member_status}')"
          class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" ${isExited?'disabled':''}>ЁЯТ╛ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
      </td>`;
    tbody.appendChild(row);
  });
}

// р╕кр╣Ир╕зр╕Щр╕нр╕╖р╣Ир╕Щ р╣Ж р╕Вр╕нр╕Зр╣Вр╕Др╣Йр╕Ф (filterMembers, saveMemberExit, loadHistory, updateHistory, deleteHistory, loadDashboard, printReport, printPDFReport, pagination) р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Ар╕лр╕бр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╕Ьр╕бр╕кр╣Ир╕Зр╕Бр╣Ир╕нр╕Щр╕лр╕Щр╣Йр╕▓

</script>
</body>
</html>
