<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: "Prompt", sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f4f4f4; }
    input[type="text"], input[type="date"], input[type="number"] { padding: 4px; width: 90%; }
    button { padding: 4px 8px; cursor: pointer; margin: 2px; }
    .saved { background-color: #e6f7ff; }
    .search-box { margin-bottom: 15px; }
  </style>
</head>
<body>

<h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>

<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." onkeyup="filterMembers()">
</div>

<table id="memberTable">
  <thead>
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
      <th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
    </tr>
  </thead>
  <tbody id="memberBody"></tbody>
</table>

<h3 style="margin-top:30px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
<table id="historyTable">
  <thead>
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
      <th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<script>
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co"; // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";                           // ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let memberData = [];

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
async function loadMembers() {
  const { data, error } = await client
    .from('members')
    .select('member_id, first_name, last_name, group, member_status')
    .in('member_status', ['‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï']);

  if (error) { console.error(error); return; }
  memberData = data;
  renderMemberTable(data);
  loadHistory();
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
function renderMemberTable(data) {
  const tbody = document.getElementById('memberBody');
  tbody.innerHTML = '';

  data.forEach(m => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${m.member_id}</td>
      <td>${m.first_name}</td>
      <td>${m.last_name}</td>
      <td>${m.group}</td>
      <td>${m.member_status}</td>
      <td><input type="date" id="meeting_date_${m.member_id}"></td>
      <td><input type="number" id="share_amount_${m.member_id}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"></td>
      <td><input type="date" id="receive_date_${m.member_id}"></td>
      <td><button onclick="saveMemberExit('${m.member_id}', '${m.first_name}', '${m.last_name}', '${m.group}', '${m.member_status}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>
    `;
    tbody.appendChild(row);
  });
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
function filterMembers() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = memberData.filter(m =>
    m.first_name.toLowerCase().includes(query) ||
    m.last_name.toLowerCase().includes(query) ||
    m.member_id.toLowerCase().includes(query)
  );
  renderMemberTable(filtered);
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
async function saveMemberExit(member_id, first_name, last_name, group, member_status) {
  const meeting_date = document.getElementById(`meeting_date_${member_id}`).value;
  const share_amount = document.getElementById(`share_amount_${member_id}`).value;
  const receive_date = document.getElementById(`receive_date_${member_id}`).value;

  if (!meeting_date || !share_amount || !receive_date) {
    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    return;
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥
  const { data: existing } = await client
    .from('member_exit')
    .select('member_id')
    .eq('member_id', member_id)
    .maybeSingle();

  if (existing) { alert('‚ö†Ô∏è ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß!'); return; }

  const { error } = await client.from('member_exit').insert([{
    member_id, first_name, last_name, group, member_status,
    meeting_date, share_amount, receive_date
  }]);

  if (error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); return; }
  alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${first_name} ${last_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadHistory();
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
async function loadHistory() {
  const { data, error } = await client
    .from('member_exit')
    .select('*')
    .order('receive_date', { ascending: false });

  if (error) { console.error(error); return; }

  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';

  data.forEach(item => {
    const row = document.createElement('tr');
    row.classList.add('saved');
    row.innerHTML = `
      <td>${item.member_id}</td>
      <td><input type="text" value="${item.first_name}" id="edit_fname_${item.member_id}"></td>
      <td><input type="text" value="${item.last_name}" id="edit_lname_${item.member_id}"></td>
      <td><input type="text" value="${item.group}" id="edit_group_${item.member_id}"></td>
      <td>${item.member_status}</td>
      <td><input type="date" value="${item.meeting_date}" id="edit_meeting_${item.member_id}"></td>
      <td><input type="number" value="${item.share_amount}" id="edit_share_${item.member_id}"></td>
      <td><input type="date" value="${item.receive_date}" id="edit_receive_${item.member_id}"></td>
      <td>
        <button onclick="updateHistory('${item.member_id}')">üíæ Save</button>
        <button onclick="deleteHistory('${item.member_id}')">üóëÔ∏è Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function updateHistory(member_id) {
  const updated = {
    first_name: document.getElementById(`edit_fname_${member_id}`).value,
    last_name: document.getElementById(`edit_lname_${member_id}`).value,
    group: document.getElementById(`edit_group_${member_id}`).value,
    meeting_date: document.getElementById(`edit_meeting_${member_id}`).value,
    share_amount: document.getElementById(`edit_share_${member_id}`).value,
    receive_date: document.getElementById(`edit_receive_${member_id}`).value
  };

  const { error } = await client
    .from('member_exit')
    .update(updated)
    .eq('member_id', member_id);

  if (error) { alert('‚ùå Error: ' + error.message); return; }
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  loadHistory();
}

// ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function deleteHistory(member_id) {
  if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  const { error } = await client.from('member_exit').delete().eq('member_id', member_id);
  if (error) { alert('‚ùå Error: ' + error.message); return; }
  alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  loadHistory();
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î
loadMembers();
</script>
</body>
</html>
