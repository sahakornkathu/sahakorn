<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: "Prompt", sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    input[type="text"], input[type="date"], input[type="number"] {
      padding: 4px; width: 95%;
    }
    button { padding: 6px 10px; cursor: pointer; }
    .saved { background-color: #c8e6c9; }
    .search-box { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>

  <div class="search-box">
    üîç <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." onkeyup="filterMembers()">
  </div>

  <table id="memberTable">
    <thead>
      <tr>
        <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
      </tr>
    </thead>
    <tbody id="memberBody"></tbody>
  </table>

  <h3 style="margin-top:30px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
  <table id="historyTable">
    <thead>
      <tr>
        <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>

  <script>
    // üü¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
    const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.coo"; // ‚Üê ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";                         // ‚Üê ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let memberData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    // üü¢ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
    async function loadMembers() {
      const { data, error } = await client
        .from('members')
        .select('member_id, title, first_name, last_name, group, member_status')
        .in('member_status', ['‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï']);

      if (error) {
        console.error('‚ùå Error loading members:', error);
        return;
      }

      memberData = data;
      renderMemberTable(data);
      loadHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    }

    // üü¢ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    function renderMemberTable(data) {
      const tbody = document.getElementById('memberBody');
      tbody.innerHTML = '';

      data.forEach(member => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${member.member_id}</td>
          <td>${member.first_name}</td>
          <td>${member.last_name}</td>
          <td>${member.group}</td>
          <td>${member.member_status}</td>
          <td><input type="date" id="meeting_date_${member.member_id}"></td>
          <td><input type="number" id="share_amount_${member.member_id}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"></td>
          <td><input type="date" id="receive_date_${member.member_id}"></td>
          <td><button onclick="saveMemberExit('${member.member_id}', '${member.first_name}', '${member.last_name}', '${member.group}', '${member.member_status}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    function filterMembers() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const filtered = memberData.filter(m =>
        m.first_name.toLowerCase().includes(query) ||
        m.last_name.toLowerCase().includes(query) ||
        m.member_id.toLowerCase().includes(query)
      );
      renderMemberTable(filtered);
    }

    // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function saveMemberExit(member_id, first_name, last_name, group, member_status) {
      const meeting_date = document.getElementById(`meeting_date_${member_id}`).value;
      const share_amount = document.getElementById(`share_amount_${member_id}`).value;
      const receive_date = document.getElementById(`receive_date_${member_id}`).value;

      if (!meeting_date || !share_amount || !receive_date) {
        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const { data: existing } = await client
        .from('member_exit')
        .select('member_id')
        .eq('member_id', member_id)
        .maybeSingle();

      if (existing) {
        alert('‚ö†Ô∏è ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß!');
        return;
      }

      const insertData = {
        member_id,
        first_name,
        last_name,
        group,
        member_status,
        meeting_date,
        share_amount,
        receive_date
      };

      const { error } = await client
        .from('member_exit')
        .insert([insertData]);

      if (error) {
        console.error('‚ùå Error saving member_exit:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      } else {
        alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${first_name} ${last_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        loadHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
      }
    }

    // üü¢ ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    async function loadHistory() {
      const { data, error } = await client
        .from('member_exit')
        .select('*')
        .order('receive_date', { ascending: false });

      if (error) {
        console.error('‚ùå Error loading history:', error);
        return;
      }

      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';

      data.forEach(item => {
        const row = document.createElement('tr');
        row.classList.add('saved');
        row.innerHTML = `
          <td>${item.member_id}</td>
          <td>${item.first_name}</td>
          <td>${item.last_name}</td>
          <td>${item.group}</td>
          <td>${item.member_status}</td>
          <td>${item.meeting_date}</td>
          <td>${item.share_amount}</td>
          <td>${item.receive_date}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    loadMembers();
  </script>
</body>
</html>
