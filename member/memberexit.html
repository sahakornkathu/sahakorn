<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
.input{
  width:100%;
  background:#020617;
  border:1px solid #334155;
  padding:8px;
  border-radius:8px;
  color:#fff;
}
.label{
  font-size:13px;
  color:#cbd5f5;
  margin-bottom:4px;
  display:block;
}
.btn{
  padding:8px 18px;
  border-radius:10px;
  font-weight:500;
}
.red{background:#dc2626}
.gray{background:#475569}
.green{background:#16a34a}
.blue{background:#2563eb}

.filter-box{
  background:linear-gradient(135deg,#0f172a,#1e293b);
  padding:22px;
  border-radius:16px;
}
.filter-title{
  color:#38bdf8;
  font-size:22px;
  margin-bottom:18px;
}
.filter-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
  margin-bottom:16px;
}
.filter-actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
}
</style>
</head>

<body class="bg-slate-900 text-slate-100 p-6">

<div class="max-w-7xl mx-auto space-y-8">

<h1 class="text-2xl font-bold text-center text-red-400">
‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
</h1>

<!-- ================= FORM ================= -->
<div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
<h2 class="font-bold text-yellow-400 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>

<form id="exitForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">

<div><label class="label">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label><input id="member_id" class="input" required></div>
<div><label class="label">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label><input id="title" class="input" readonly></div>
<div><label class="label">‡∏ä‡∏∑‡πà‡∏≠</label><input id="first_name" class="input" readonly></div>
<div><label class="label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="last_name" class="input" readonly></div>
<div><label class="label">‡∏Å‡∏•‡∏∏‡πà‡∏°</label><input id="group" class="input" readonly></div>

<div>
  <label class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
  <select id="member_status" class="input" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
    <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
    <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
  </select>
</div>

<div><label class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label><input id="meeting_date" type="date" class="input" required></div>
<div><label class="label">‡∏´‡∏∏‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input id="share_amount" type="number" class="input"></div>
<div><label class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label><input id="receive_date" type="date" class="input"></div>

<div class="col-span-full flex justify-center gap-4 mt-2">
  <button class="btn red">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button type="reset" class="btn gray" onclick="clearEdit()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
</div>
</form>
</div>

<!-- ================= FILTER ================= -->
<div class="filter-box">
<h2 class="filter-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>

<div class="filter-grid">
  <div><label class="label">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label><input id="f_member_id" class="input"></div>
  <div><label class="label">‡∏ä‡∏∑‡πà‡∏≠</label><input id="f_first_name" class="input"></div>
  <div><label class="label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="f_last_name" class="input"></div>
</div>

<div class="filter-grid">
  <div><label class="label">‡∏Å‡∏•‡∏∏‡πà‡∏°</label><input id="f_group" class="input"></div>
  <div>
    <label class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select id="f_status" class="input">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>
  </div>
</div>

<div class="filter-grid">
  <div><label class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏à‡∏≤‡∏Å)</label><input id="f_date_from" type="date" class="input"></div>
  <div><label class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡∏∂‡∏á)</label><input id="f_date_to" type="date" class="input"></div>
</div>

<div class="filter-actions">
  <button class="btn gray" onclick="clearFilter()">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
  <button class="btn green" onclick="exportExcel()">Export</button>
  <button class="btn blue" onclick="printReport()">Print</button>
</div>
</div>

<!-- ================= TABLE ================= -->
<div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
<h2 class="font-bold text-orange-400 mb-2">
‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (<span id="resultCount">0</span>)
</h2>

<table class="w-full text-center text-sm">
<thead class="bg-slate-700">
<tr>
<th>‡∏£‡∏´‡∏±‡∏™</th>
<th>‡∏ä‡∏∑‡πà‡∏≠</th>
<th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
<th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th>‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
<th>‡∏´‡∏∏‡πâ‡∏ô</th>
<th>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
<th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div class="flex justify-center gap-4 mt-4">
<button class="btn gray" onclick="prevPage()">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
<span id="pageInfo"></span>
<button class="btn gray" onclick="nextPage()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const COOP_LOGO_URL = 'https://ttottijljxoinptmhgtu.supabase.co/storage/v1/object/public/slips/logo.png'

const db = createClient(SUPABASE_URL, SUPABASE_KEY)

let allData = [], page = 1, pageSize = 10
let editing = false, editKey = null

member_id.addEventListener('blur', async ()=>{
  const { data } = await db.from('members')
    .select('title,first_name,last_name,group')
    .eq('member_id', member_id.value)
    .single()
  if(!data){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'); return }
  title.value = data.title
  first_name.value = data.first_name
  last_name.value = data.last_name
  group.value = data.group
})

async function load(){
  let q = db.from('member_exit').select('*')
  if(f_member_id.value) q = q.eq('member_id', f_member_id.value)
  if(f_first_name.value) q = q.ilike('first_name', '%' + f_first_name.value + '%')
  if(f_last_name.value) q = q.ilike('last_name', '%' + f_last_name.value + '%')
  if(f_group.value) q = q.ilike('group', '%' + f_group.value + '%')
  if(f_status.value) q = q.eq('member_status', f_status.value)
  if(f_date_from.value) q = q.gte('meeting_date', f_date_from.value)
  if(f_date_to.value) q = q.lte('meeting_date', f_date_to.value)

  const { data } = await q.order('meeting_date', { ascending:false })
  allData = data || []
  resultCount.innerText = allData.length
  render()
}

function render(){
  rows.innerHTML = ''
  allData.slice((page-1)*pageSize, page*pageSize).forEach((r, idx)=>{
    const realIndex = (page-1)*pageSize + idx
    rows.innerHTML += `
<tr class="${editKey===r.member_id+r.meeting_date?'bg-sky-900':''}">
<td>${r.member_id}</td>
<td>${r.first_name} ${r.last_name}</td>
<td>${r.group}</td>
<td>${r.member_status}</td>
<td>${r.meeting_date}</td>
<td>${r.share_amount||''}</td>
<td>${r.receive_date||''}</td>
<td>
<button class="text-blue-400" onclick="editRowByIndex(${realIndex})">‡πÅ‡∏Å‡πâ</button>
<button class="text-red-400" onclick="del('${r.member_id}','${r.meeting_date}')">‡∏•‡∏ö</button>
</td>
</tr>`
  })
  pageInfo.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${page}/${Math.max(1,Math.ceil(allData.length/pageSize))}`
}

window.nextPage = ()=>{ if(page*pageSize < allData.length){ page++; render() } }
window.prevPage = ()=>{ if(page > 1){ page--; render() } }

window.editRowByIndex = index=>{
  const r = allData[index]
  if(!r) return
  editing = true
  editKey = r.member_id + r.meeting_date
  member_id.value = r.member_id
  title.value = r.title
  first_name.value = r.first_name
  last_name.value = r.last_name
  group.value = r.group
  member_status.value = r.member_status
  meeting_date.value = r.meeting_date
  share_amount.value = r.share_amount || ''
  receive_date.value = r.receive_date || ''
}

exitForm.onsubmit = async e=>{
  e.preventDefault()

  const payload = {
    member_id: member_id.value,
    title: title.value,
    first_name: first_name.value,
    last_name: last_name.value,
    group: group.value,
    member_status: member_status.value,
    meeting_date: meeting_date.value,
    share_amount: share_amount.value || null,
    receive_date: receive_date.value || null
  }

  // üîí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
  if(!editing){
    const { data: exists } = await db
      .from('member_exit')
      .select('member_id')
      .eq('member_id', payload.member_id)
      .eq('meeting_date', payload.meeting_date)
      .maybeSingle()

    if(exists){
      alert('‚ö†Ô∏è ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß')
      return
    }
  }

  if(editing){
    await db.from('member_exit')
      .update(payload)
      .eq('member_id', payload.member_id)
      .eq('meeting_date', payload.meeting_date)
  }else{
    await db.from('member_exit').insert([payload])
  }

  await syncStatus(payload.member_id)
  clearEdit()
  load()
}

window.del = async(id,date)=>{
  if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ ?')) return
  await db.from('member_exit').delete().eq('member_id', id).eq('meeting_date', date)
  await syncStatus(id)
  load()
}

async function syncStatus(id){
  const { data } = await db.from('member_exit')
    .select('member_status')
    .eq('member_id', id)
    .order('meeting_date', { ascending:false })
    .limit(1)

  await db.from('members')
    .update({ member_status: data?.[0]?.member_status || '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' })
    .eq('member_id', id)
}

window.clearEdit = ()=>{
  editing = false
  editKey = null
  exitForm.reset()
}

;[f_member_id,f_first_name,f_last_name,f_group,f_status,f_date_from,f_date_to]
.forEach(el=>el.addEventListener('input', ()=>{ page = 1; load() }))

window.clearFilter = ()=>{
  f_member_id.value = f_first_name.value = f_last_name.value =
  f_group.value = f_status.value = f_date_from.value = f_date_to.value = ''
  load()
}

window.exportExcel = ()=>{
  if(!allData.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return }
  const ws = XLSX.utils.json_to_sheet(allData)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'data')
  XLSX.writeFile(wb, '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å.xlsx')
}

function getCurrentFiscalYearThai(){
  const d = new Date()
  const y = d.getFullYear()
  const m = d.getMonth() + 1
  return (m < 4 ? y - 1 : y) + 543
}

window.printReport = ()=>{
  if(!allData.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå'); return }
  const fy = getCurrentFiscalYearThai()
  const total = allData.length

  const rowsHtml = allData.map((r,i)=>`
<tr>
<td>${i+1}</td>
<td>${r.member_id}</td>
<td>${r.title}${r.first_name} ${r.last_name}</td>
<td>${r.group}</td>
<td>${r.member_status}</td>
<td>${r.meeting_date}</td>
</tr>`).join('')

  const html = `
<html><head><meta charset="UTF-8">
<style>
@page{margin:20mm;@bottom-center{content:"‡∏´‡∏ô‡πâ‡∏≤ " counter(page) " / " counter(pages);}}
body{font-family:"TH Sarabun New",sans-serif;font-size:16px}
.header-grid{display:grid;grid-template-columns:100px 1fr 100px;align-items:center}
.logo{width:80px}
.title-box{text-align:center}
table{width:100%;border-collapse:collapse;margin-top:14px}
th,td{border:1px solid #000;padding:6px;text-align:center}
</style>
</head>
<body>
<div class="header-grid">
  <div><img src="${COOP_LOGO_URL}" class="logo"></div>
  <div class="title-box">
    <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ${f_status.value||'‡∏•‡∏≤‡∏≠‡∏≠‡∏Å / ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'}</h2>
    ${f_group.value?`<div>‡∏Å‡∏•‡∏∏‡πà‡∏° ${f_group.value}</div>`:''}
    <div><b>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ ${fy}</b></div>
    <div>1 ‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô ${fy} ‚Äì 31 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° ${fy+1}</div>
    <div>‡∏£‡∏ß‡∏° ${total} ‡∏£‡∏≤‡∏¢</div>
  </div>
  <div></div>
</div>
<table>
<thead>
<tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th></tr>
</thead>
<tbody>${rowsHtml}</tbody>
</table>
</body></html>`
  const w = window.open('')
  w.document.write(html)
  w.document.close()
  w.print()
}

load()
</script>

</body>
</html>
