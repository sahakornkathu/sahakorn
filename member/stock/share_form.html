<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
body { font-family: "Prompt", sans-serif; background:#f0f4f8; margin:0; padding:20px; color:#333; }
.container { max-width:600px; margin:auto; background:#fff; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
h2 { text-align:center; color:#1e40af; }
label { display:block; margin-top:10px; font-weight:500; }
input { width:100%; padding:8px 10px; margin-top:4px; border:1px solid #ccc; border-radius:8px; }
button { margin-top:20px; width:100%; background:#4a90e2; color:#fff; padding:10px; font-size:16px; border:none; border-radius:8px; cursor:pointer; }
button:hover { background:#357abd; }
.summary-box { background:#f9fafb; padding:12px; border-radius:10px; margin-top:20px; border:1px solid #e2e8f0; }
.summary-box h3 { margin:0 0 8px 0; color:#2563eb; }
.summary-box div { margin:3px 0; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <h2>üìà ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</h2>

  <div id="memberInfo" class="summary-box" style="display:none;">
    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
    <div>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: <span id="m_id"></span></div>
    <div>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: <span id="m_name"></span></div>
    <div>‡∏Å‡∏•‡∏∏‡πà‡∏°: <span id="m_group"></span></div>
    <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="m_status"></span></div>
    <div>‡∏´‡∏∏‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="m_balance"></span> ‡∏´‡∏∏‡πâ‡∏ô</div>
    <div>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: <span id="m_total"></span> ‡∏ö‡∏≤‡∏ó</div>
  </div>

  <form id="shareForm">
    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</label>
    <input type="date" id="date" required>

    <label>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏∏‡πâ‡∏ô‡∏•‡∏∞ 10 ‡∏ö‡∏≤‡∏ó)</label>
    <input type="number" id="share_amount" min="1" required>

    <label>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
    <input type="text" id="total_price" readonly>

    <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</button>
  </form>
</div>

<script>
// ===============================
// ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
// ===============================
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===============================
// ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
// ===============================
async function initApp() {
  await liff.init({ liffId: "https://liff.line.me/1660910795-D247n9mr" });
  const profile = await liff.getProfile();
  const userId = profile.userId;
  loadMemberData(userId);
}

// ===============================
// ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å members ‡πÅ‡∏•‡∏∞ v_member_share_overview
// ===============================
async function loadMemberData(lineUserId) {
  const { data: memberData, error: memberErr } = await supabase
    .from('members')
    .select('member_id, title, first_name, last_name, "group", member_status, line_user_id')
    .eq('line_user_id', lineUserId)
    .single();

  if (memberErr || !memberData) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
  const { data: shareInfo } = await supabase
    .from('v_member_share_overview')
    .select('balance_shares, total_amount')
    .eq('line_user_id', lineUserId)
    .maybeSingle();

  document.getElementById("memberInfo").style.display = "block";
  document.getElementById("m_id").textContent = memberData.member_id;
  document.getElementById("m_name").textContent = `${memberData.title}${memberData.first_name} ${memberData.last_name}`;
  document.getElementById("m_group").textContent = memberData.group;
  document.getElementById("m_status").textContent = memberData.member_status;
  document.getElementById("m_balance").textContent = shareInfo?.balance_shares || 0;
  document.getElementById("m_total").textContent = shareInfo?.total_amount || 0;

  window.memberData = memberData;
}

// ===============================
// ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
// ===============================
document.getElementById("share_amount").addEventListener("input", () => {
  const amount = parseFloat(document.getElementById("share_amount").value || 0);
  document.getElementById("total_price").value = (amount * 10).toLocaleString();
});

// ===============================
// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô
// ===============================
document.getElementById("shareForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const member = window.memberData;
  const date = document.getElementById("date").value;
  const shareAmount = parseFloat(document.getElementById("share_amount").value);

  if (!member || !shareAmount) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  const { error } = await supabase.from("shares").insert({
    member_id: member.member_id,
    date: date,
    share_amount: shareAmount
  });

  if (error) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    return;
  }

  document.getElementById("shareForm").reset();
  document.getElementById("total_price").value = "";
  await sendFlexMessage(member, shareAmount);

  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  loadMemberData(member.line_user_id);
});

// ===============================
// ‚úÖ ‡∏™‡πà‡∏á Flex Message
// ===============================
async function sendFlexMessage(member, amount) {
  const total = (amount * 10).toLocaleString();
  const message = {
    type: "flex",
    altText: "‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
    contents: {
      type: "bubble",
      hero: {
        type: "image",
        url: "https://cdn-icons-png.flaticon.com/512/625/625952.png",
        size: "full",
        aspectMode: "cover",
      },
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "text", text: "‚úÖ ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", weight: "bold", size: "lg", color: "#16a34a" },
          { type: "text", text: `‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${member.title}${member.first_name} ${member.last_name}`, size: "sm", color: "#374151" },
          { type: "text", text: `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${amount} ‡∏´‡∏∏‡πâ‡∏ô`, size: "sm", color: "#374151" },
          { type: "text", text: `‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${total} ‡∏ö‡∏≤‡∏ó`, size: "sm", color: "#374151" },
          { type: "separator", margin: "sm" },
          { type: "text", text: "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏£‡∏±‡∏ö ‚ù§Ô∏è", size: "sm", color: "#6b7280", wrap: true }
        ]
      }
    }
  };
  await liff.sendMessages([message]);
}

initApp();
</script>

</body>
</html>
