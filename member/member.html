<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบจัดการข้อมูลสมาชิก</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-blue-50 p-6 text-slate-800">

<div class="max-w-7xl mx-auto space-y-6">

  <!-- ================= SUMMARY ================= -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="summary-card border-green-400">
      <div class="summary-title text-green-700">สมาชิก</div>
      <div id="count-active" class="summary-number text-green-700">0</div>
    </div>
    <div class="summary-card border-orange-400">
      <div class="summary-title text-orange-600">ลาออก</div>
      <div id="count-resign" class="summary-number text-orange-600">0</div>
    </div>
    <div class="summary-card border-red-400">
      <div class="summary-title text-red-600">เสียชีวิต</div>
      <div id="count-dead" class="summary-number text-red-600">0</div>
    </div>
  </div>

  <!-- ================= TABS ================= -->
  <div class="flex gap-2">
    <button class="tab active" onclick="setStatusFilter('')">ทั้งหมด</button>
    <button class="tab" onclick="setStatusFilter('สมาชิก')">สมาชิก</button>
    <button class="tab" onclick="setStatusFilter('ลาออก')">ลาออก</button>
    <button class="tab" onclick="setStatusFilter('เสียชีวิต')">เสียชีวิต</button>
  </div>

  <!-- ================= FORM ================= -->
  <form id="memberForm" class="space-y-6 bg-white border-2 border-blue-300 rounded-xl p-6">

    <h2 class="section-title">บันทึกข้อมูลสมาชิก</h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

      <div class="h-field">
        <label>รหัสสมาชิก</label>
        <input id="member_id" type="number" required>
      </div>

      <div class="h-field">
        <label>คำนำหน้า</label>
        <select id="title">
          <option value="">-- เลือก --</option>
          <option value="นาย">นาย</option>
          <option value="นาง">นาง</option>
          <option value="นางสาว">นางสาว</option>
        </select>
      </div>

      <div class="h-field">
        <label>ชื่อ</label>
        <input id="first_name" required>
      </div>

      <div class="h-field">
        <label>นามสกุล</label>
        <input id="last_name" required>
      </div>

      <div class="h-field">
        <label>โทรศัพท์</label>
        <input id="phone">
      </div>

      <div class="h-field">
        <label>สถานะสมาชิก</label>
        <select id="member_status">
          <option value="">-- เลือก --</option>
          <option value="สมาชิก">สมาชิก</option>
          <option value="ลาออก">ลาออก</option>
          <option value="เสียชีวิต">เสียชีวิต</option>
        </select>
      </div>

    </div>

    <div class="flex gap-4">
      <button type="submit" class="btn-primary">บันทึก</button>
      <button type="button" onclick="resetForm()" class="btn-secondary">ยกเลิก</button>
    </div>

  </form>

  <!-- ================= TABLE ================= -->
  <div class="bg-white border-2 border-blue-300 rounded-xl p-6">
    <h2 class="section-title mb-4">รายชื่อสมาชิก</h2>

    <table class="w-full text-sm">
      <thead class="bg-blue-100">
        <tr>
          <th class="th">รหัส</th>
          <th class="th">ชื่อ</th>
          <th class="th">โทร</th>
          <th class="th">สถานะ</th>
          <th class="th text-center">จัดการ</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="flex justify-between items-center mt-4">
      <button onclick="prevPage()" class="btn-page">◀ ก่อนหน้า</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()" class="btn-page">ถัดไป ▶</button>
    </div>
  </div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const db = createClient(
  'https://ttottijljxoinptmhgtu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

const PAGE_SIZE = 15
let currentPage = 1
let totalCount = 0
let statusFilter = ''

const rows = document.getElementById('rows')
const form = document.getElementById('memberForm')
const statusEl = document.getElementById('member_status')

/* ---------- FILTER TAB ---------- */
window.setStatusFilter = (status) => {
  statusFilter = status
  currentPage = 1
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'))
  event.target.classList.add('active')
  loadMembers()
}

/* ---------- SUMMARY ---------- */
async function loadSummary() {
  const { data } = await db.from('members').select('member_status')
  document.getElementById('count-active').innerText =
    data.filter(d => d.member_status === 'สมาชิก').length
  document.getElementById('count-resign').innerText =
    data.filter(d => d.member_status === 'ลาออก').length
  document.getElementById('count-dead').innerText =
    data.filter(d => d.member_status === 'เสียชีวิต').length
}

/* ---------- LOAD MEMBERS ---------- */
async function loadMembers() {
  let query = db.from('members')
    .select('member_id, first_name, last_name, phone, member_status')
    .order('member_id')

  if (statusFilter) query = query.eq('member_status', statusFilter)

  const { data, count } = await query.range(
    (currentPage - 1) * PAGE_SIZE,
    currentPage * PAGE_SIZE - 1
  )

  totalCount = count || 0
  rows.innerHTML = ''

  data.forEach(m => {
    const color =
      m.member_status === 'สมาชิก' ? 'text-green-600'
      : m.member_status === 'ลาออก' ? 'text-orange-500'
      : 'text-red-600'

    rows.innerHTML += `
      <tr>
        <td class="td">${m.member_id}</td>
        <td class="td">${m.first_name} ${m.last_name}</td>
        <td class="td">${m.phone ?? ''}</td>
        <td class="td font-semibold ${color}">${m.member_status}</td>
        <td class="td text-center">
          <button onclick="editMember(${m.member_id})" class="text-blue-600">แก้ไข</button>
        </td>
      </tr>`
  })

  document.getElementById('pageInfo').innerText =
    `หน้า ${currentPage}`
}

/* ---------- FORM ---------- */
form.addEventListener('submit', async e => {
  e.preventDefault()
  const data = Object.fromEntries(
    [...form.elements].filter(el => el.id).map(el => [el.id, el.value || null])
  )
  await db.from('members').upsert([data], { onConflict: 'member_id' })
  resetForm()
  loadMembers()
  loadSummary()
})

/* ---------- LOCK WHEN DEAD ---------- */
statusEl.addEventListener('change', () => {
  const lock = statusEl.value === 'เสียชีวิต'
  [...form.elements].forEach(el => {
    if (el.id && el.id !== 'member_status') el.disabled = lock
  })
})

window.resetForm = () => {
  form.reset()
  [...form.elements].forEach(el => el.disabled = false)
}

/* ---------- INIT ---------- */
loadMembers()
loadSummary()
</script>

<style>
.summary-card { @apply bg-white border-2 rounded-xl p-4 text-center }
.summary-title { @apply text-sm font-medium }
.summary-number { @apply text-3xl font-bold }

.tab { @apply px-4 py-2 border rounded-lg bg-white }
.tab.active { @apply bg-blue-600 text-white }

.section-title { @apply text-lg font-semibold mb-4 }

.h-field { @apply flex items-center gap-3 }
.h-field label { @apply w-24 text-sm font-medium }
.h-field input, .h-field select {
  @apply flex-1 border-2 border-slate-400 rounded-md px-3 py-2
}

.th { @apply px-3 py-2 text-left font-semibold }
.td { @apply px-3 py-2 }

.btn-primary { @apply bg-blue-600 text-white px-6 py-2 rounded-lg }
.btn-secondary { @apply bg-slate-300 px-6 py-2 rounded-lg }
.btn-page { @apply bg-slate-200 px-4 py-2 rounded-lg }
</style>

</body>
</html>
