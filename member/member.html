<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to right, #e0e7ff, #f5f3ff);
      font-family: 'Prompt', sans-serif;
    }
    th {
      cursor: pointer;
    }
  </style>
</head>
<body class="p-6">
  <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl p-8">
    <h1 class="text-3xl font-bold mb-6 text-center text-indigo-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
    <form id="memberForm" class="grid grid-cols-2 gap-4 mb-8">
      <input type="text" name="member_id" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="date" name="join_date" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <select name="title" required class="p-2 border rounded-lg">
        <option value="">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤*</option>
        <option>‡∏ô‡∏≤‡∏¢</option>
        <option>‡∏ô‡∏≤‡∏á</option>
        <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
      </select>
      <input type="text" name="first_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="last_name" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="id_card" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="date" name="birthday" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="group" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="house_no" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="moo" placeholder="‡∏´‡∏°‡∏π‡πà" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="street" placeholder="‡∏ñ‡∏ô‡∏ô*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="village" placeholder="‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="subdistrict" placeholder="‡∏ï‡∏≥‡∏ö‡∏•*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="district" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="province" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="zipcode" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå*" required class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="phone_alt" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <select name="member_status" required class="p-2 border rounded-lg">
        <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å*</option>
        <option>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
        <option>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
        <option>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
      </select>
      <select name="marital_status" required class="p-2 border rounded-lg">
        <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏£‡∏™*</option>
        <option>‡πÇ‡∏™‡∏î</option>
        <option>‡∏´‡∏°‡πâ‡∏≤‡∏¢</option>
        <option>‡∏´‡∏¢‡πà‡∏≤</option>
      </select>
      <input type="text" name="spouse_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 col-span-2" />
      <div class="col-span-2 flex items-center gap-3">
        <label class="flex items-center gap-2">
          <input type="checkbox" name="kyot_member" class="h-5 w-5 text-indigo-600" /> ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó.
        </label>
        <input type="text" name="kyot_member_id" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó." class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      </div>
      <input type="text" name="father_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏î‡∏≤" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />
      <input type="text" name="mother_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤" class="p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" />

      <button type="submit" class="col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-xl text-lg transition-all duration-300">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
    </form>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div class="mb-4 grid grid-cols-5 gap-2">
      <input id="searchMemberId" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" class="border p-2 rounded-lg" />
      <input id="searchName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border p-2 rounded-lg" />
      <input id="searchGroup" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°" class="border p-2 rounded-lg" />
      <input id="searchProvince" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" class="border p-2 rounded-lg" />
      <select id="searchStatus" class="border p-2 rounded-lg">
        <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
        <option>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
        <option>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
        <option>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
      </select>
    </div>

    <div id="resultCount" class="text-right text-gray-500 mb-2"></div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 rounded-xl text-sm text-center" id="memberTable">
        <thead class="bg-indigo-600 text-white">
          <tr>
            <th data-column="member_id">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
            <th data-column="first_name">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th data-column="last_name">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
            <th data-column="group">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th data-column="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
            <th data-column="member_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
            <th>‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody class="divide-y" id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members";
    const tableBody = document.getElementById('tableBody');
    const form = document.getElementById('memberForm');
    let allMembers = [];
    let sortColumn = null, sortAsc = true;

    async function loadMembers() {
      try {
        const res = await fetch(API_URL);
        const result = await res.json();
        if(result.error) { alert(result.error); return; }
        allMembers = result.data || [];
        renderTable(allMembers);
      } catch(err) { alert(err); }
    }

    function renderTable(members) {
      tableBody.innerHTML = '';
      members.forEach(m => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-indigo-50";
        tr.innerHTML = `
          <td>${m.member_id || ''}</td>
          <td>${m.first_name || ''}</td>
          <td>${m.last_name || ''}</td>
          <td>${m.group || ''}</td>
          <td>${m.province || ''}</td>
          <td>${m.member_status || ''}</td>
          <td><button onclick="editMember('${m.member_id}')" class="text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
          <td><button onclick="deleteMember('${m.member_id}')" class="text-red-600 hover:underline">‡∏•‡∏ö</button></td>`;
        tableBody.appendChild(tr);
      });
      document.getElementById('resultCount').textContent = `‡∏û‡∏ö ${members.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    }

    function filterMembers() {
      const id = searchMemberId.value.toLowerCase();
      const name = searchName.value.toLowerCase();
      const group = searchGroup.value.toLowerCase();
      const province = searchProvince.value.toLowerCase();
      const status = searchStatus.value;
      const filtered = allMembers.filter(m =>
        (!id || m.member_id?.toLowerCase().includes(id)) &&
        (!name || m.first_name?.toLowerCase().includes(name) || m.last_name?.toLowerCase().includes(name)) &&
        (!group || m.group?.toLowerCase().includes(group)) &&
        (!province || m.province?.toLowerCase().includes(province)) &&
        (!status || m.member_status === status)
      );
      renderTable(filtered);
    }

    function sortTable(column) {
      if(sortColumn === column) sortAsc = !sortAsc;
      else { sortColumn = column; sortAsc = true; }

      allMembers.sort((a,b)=>{
        let A=(a[column]||"").toString().toLowerCase();
        let B=(b[column]||"").toString().toLowerCase();
        if(A<B) return sortAsc?-1:1;
        if(A>B) return sortAsc?1:-1;
        return 0;
      });
      filterMembers();
    }

    document.querySelectorAll('#memberTable th[data-column]').forEach(th=>{
      th.addEventListener('click', ()=> sortTable(th.dataset.column));
    });

    document.querySelectorAll('#searchMemberId,#searchName,#searchGroup,#searchProvince,#searchStatus')
      .forEach(e=> e.addEventListener('input', filterMembers));

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      try {
        const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
        const result = await res.json();
        if(result.error){ alert(result.error); return; }
        form.reset(); loadMembers();
      } catch(err){ alert(err); }
    });

    async function deleteMember(id){
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) return;
      await fetch(`${API_URL}?id=${id}`,{method:'DELETE'});
      loadMembers();
    }

    function editMember(id){
      const m = allMembers.find(x=>x.member_id===id);
      if(!m) return;
      for(let key in m){
        if(form[key]) form[key].value = m[key];
      }
      window.scrollTo({top:0, behavior:'smooth'});
    }

    loadMembers();
  </script>
</body>
</html>
