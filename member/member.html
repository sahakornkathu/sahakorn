<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบบันทึกสมาชิก</title>
<style>
body {
  font-family: "Prompt", sans-serif;
  background: #f1f5f9;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1000px;
  margin: 40px auto;
  background: #fff;
  padding: 25px 40px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
h2 {
  text-align: center;
  color: #2563eb;
  margin-bottom: 20px;
}
.form-step {
  display: none;
}
.form-step.active {
  display: block;
}
input, select {
  width: 48%;
  padding: 8px 10px;
  margin: 5px 1%;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  background: #f8fafc;
  font-size: 14px;
}
button {
  padding: 8px 15px;
  margin: 10px 5px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  opacity: 0.9;
}
.btn-primary {
  background: #2563eb;
  color: #fff;
}
.btn-secondary {
  background: #94a3b8;
  color: #fff;
}
.btn-danger {
  background: #dc2626;
  color: #fff;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 30px;
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
th, td {
  border: 1px solid #e2e8f0;
  padding: 6px 8px;
  text-align: center;
}
th {
  background: #2563eb;
  color: #fff;
  font-weight: 500;
}
tr:nth-child(even){ background:#f9fafb; }
tr:hover{ background:#f1f5f9; }
button.edit { background:#2563eb; color:#fff; }
button.delete { background:#dc2626; color:#fff; }
</style>
</head>
<body>
<div class="container">
  <h2>ระบบบันทึกสมาชิก</h2>
  <form id="memberForm">
    <!-- Step 1 -->
    <div class="form-step active" id="step1">
      <h3>Step 1: ข้อมูลพื้นฐาน</h3>
      <input placeholder="เลขสมาชิก" name="member_id" required>
      <input type="date" name="join_date" required>
      <input placeholder="คำนำหน้า" name="title" required>
      <input placeholder="ชื่อ" name="first_name" required>
      <input placeholder="นามสกุล" name="last_name" required>
      <input placeholder="เลขบัตรประชาชน" name="id_card" required>
      <input type="date" name="birthday" required>
      
      <!-- ✅ เพิ่มฟิลด์เพศ -->
      <select name="gender" required>
        <option value="">--เลือกเพศ--</option>
        <option value="ชาย">ชาย</option>
        <option value="หญิง">หญิง</option>
      </select>

      <input placeholder="กลุ่มที่" name="group" required>
      <button type="button" class="btn-primary" onclick="nextStep(2)">ถัดไป</button>
    </div>

    <!-- Step 2 -->
    <div class="form-step" id="step2">
      <h3>Step 2: ที่อยู่</h3>
      <input placeholder="บ้านเลขที่" name="house_no" required>
      <input placeholder="หมู่" name="moo">
      <input placeholder="ถนน" name="road" required>
      <input placeholder="หมู่บ้าน" name="village">
      <input placeholder="ตำบล" name="sub_district" required>
      <input placeholder="อำเภอ" name="district" required>
      <input placeholder="จังหวัด" name="province" required>
      <input placeholder="รหัสไปรษณีย์" name="zipcode" required>
      <button type="button" class="btn-secondary" onclick="prevStep(1)">ย้อนกลับ</button>
      <button type="button" class="btn-primary" onclick="nextStep(3)">ถัดไป</button>
    </div>

    <!-- Step 3 -->
    <div class="form-step" id="step3">
      <h3>Step 3: ข้อมูลติดต่อและสถานะ</h3>
      <input placeholder="เบอร์โทรศัพท์" name="phone">
      <input placeholder="เบอร์โทรศัพท์สำรอง" name="phone_alt">
      <select name="member_status" required>
        <option value="">--สถานะสมาชิก--</option>
        <option value="สมาชิก">สมาชิก</option>
        <option value="ลาออก">ลาออก</option>
        <option value="เสียชีวิต">เสียชีวิต</option>
      </select>
      <select name="marital_status" required>
        <option value="">--สถานะสมรส--</option>
        <option value="โสด">โสด</option>
        <option value="หม้าย">หม้าย</option>
        <option value="หย่า">หย่า</option>
      </select>
      <input placeholder="ชื่อคู่สมรส (ถ้ามี)" name="spouse_name">
      <label><input type="checkbox" name="is_rubber_member"> เป็นสมาชิก กยท</label>
      <input placeholder="เลขสมาชิก กยท" name="rubber_member_id">
      <input placeholder="ชื่อบิดา" name="father_name">
      <input placeholder="ชื่อมารดา" name="mother_name">
      <div>
        <button type="button" class="btn-secondary" onclick="prevStep(2)">ย้อนกลับ</button>
        <button type="submit" class="btn-primary">บันทึกข้อมูล</button>
      </div>
    </div>
  </form>

  <h3>รายงานสมาชิก</h3>
  <table id="memberTable">
    <thead>
      <tr>
        <th>เลขสมาชิก</th>
        <th>ชื่อ</th>
        <th>นามสกุล</th>
        <th>เพศ</th>
        <th>กลุ่ม</th>
        <th>จังหวัด</th>
        <th>สถานะ</th>
        <th>แก้ไข</th>
        <th>ลบ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const API_URL = "https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members";
let currentStep = 1;

function nextStep(step) {
  document.getElementById(`step${currentStep}`).classList.remove('active');
  document.getElementById(`step${step}`).classList.add('active');
  currentStep = step;
}
function prevStep(step) {
  document.getElementById(`step${currentStep}`).classList.remove('active');
  document.getElementById(`step${step}`).classList.add('active');
  currentStep = step;
}

async function loadMembers() {
  const res = await fetch(API_URL);
  const data = await res.json();
  const tbody = document.querySelector("#memberTable tbody");
  tbody.innerHTML = "";
  data.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m.member_id}</td>
      <td>${m.first_name}</td>
      <td>${m.last_name}</td>
      <td>${m.gender || '-'}</td>
      <td>${m.group}</td>
      <td>${m.province}</td>
      <td>${m.member_status}</td>
      <td><button class="edit" onclick='editMember(${JSON.stringify(m)})'>แก้ไข</button></td>
      <td><button class="delete" onclick='deleteMember("${m.member_id}")'>ลบ</button></td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("memberForm").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const obj = {};
  formData.forEach((v, k) => obj[k] = v);
  obj.is_rubber_member = e.target.is_rubber_member.checked;

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(obj)
  });
  const result = await res.json();
  alert(result.message || "บันทึกสำเร็จ");
  e.target.reset();
  nextStep(1);
  loadMembers();
});

async function deleteMember(id) {
  if (!confirm("ต้องการลบสมาชิกนี้ใช่ไหม?")) return;
  const res = await fetch(`${API_URL}?id=${id}`, { method: "DELETE" });
  const result = await res.json();
  alert(result.message || "ลบข้อมูลสำเร็จ");
  loadMembers();
}

function editMember(data) {
  nextStep(1);
  Object.keys(data).forEach(key => {
    if (document.querySelector(`[name=${key}]`)) {
      if (document.querySelector(`[name=${key}]`).type === "checkbox") {
        document.querySelector(`[name=${key}]`).checked = data[key];
      } else {
        document.querySelector(`[name=${key}]`).value = data[key];
      }
    }
  });
}
loadMembers();
</script>
</body>
</html>
