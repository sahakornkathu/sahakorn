<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบจัดการข้อมูลสมาชิก</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-blue-50 p-6 text-slate-800">
<div class="max-w-7xl mx-auto space-y-6">

<!-- ===== SUMMARY ===== -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
  <div class="summary green"><div>สมาชิก</div><div id="count-member" class="num">0</div></div>
  <div class="summary orange"><div>ลาออก</div><div id="count-resign" class="num">0</div></div>
  <div class="summary red"><div>เสียชีวิต</div><div id="count-dead" class="num">0</div></div>
</div>

<!-- ===== FORM ===== -->
<form id="memberForm" class="box space-y-4">
<h2 class="title">บันทึกข้อมูลสมาชิก</h2>

<div class="grid grid-cols-1 md:grid-cols-4 gap-3">
  <div class="field"><label>รหัสสมาชิก</label><input id="member_id" type="number" required></div>
  <div class="field"><label>วันที่สมัคร</label><input id="join_date" type="date"></div>
  <div class="field"><label>คำนำหน้า</label>
    <select id="title"><option value="">--</option><option>นาย</option><option>นาง</option><option>นางสาว</option></select>
  </div>
  <div class="field"><label>กลุ่ม</label><input id="group"></div>

  <div class="field"><label>ชื่อ</label><input id="first_name"></div>
  <div class="field"><label>นามสกุล</label><input id="last_name"></div>
  <div class="field"><label>เลขบัตรประชาชน</label><input id="id_card"></div>
  <div class="field"><label>วันเกิด</label><input id="birthday" type="date"></div>

  <div class="field"><label>เพศ</label>
    <select id="gender"><option value="">--</option><option>ชาย</option><option>หญิง</option></select>
  </div>
  <div class="field"><label>อายุ</label><input id="age" type="number"></div>

  <div class="field"><label>บ้านเลขที่</label><input id="house_no"></div>
  <div class="field"><label>หมู่</label><input id="moo"></div>
  <div class="field"><label>ถนน</label><input id="street"></div>
  <div class="field"><label>หมู่บ้าน</label><input id="village"></div>

  <div class="field"><label>ตำบล</label><input id="subdistrict"></div>
  <div class="field"><label>อำเภอ</label><input id="district"></div>
  <div class="field"><label>จังหวัด</label><input id="province"></div>
  <div class="field"><label>รหัสไปรษณีย์</label><input id="postal_code"></div>

  <div class="field"><label>โทรศัพท์</label><input id="phone"></div>
  <div class="field"><label>โทรศัพท์สำรอง</label><input id="phone_alt"></div>

  <div class="field"><label>สถานะสมาชิก</label>
    <select id="member_status"><option value="">--</option><option>สมาชิก</option><option>ลาออก</option><option>เสียชีวิต</option></select>
  </div>

  <div class="field"><label>สถานภาพสมรส</label>
    <select id="marital_status"><option value="">--</option><option>โสด</option><option>สมรส</option></select>
  </div>

  <div class="field"><label>ชื่อคู่สมรส</label><input id="spouse_name"></div>
  <div class="field"><label>เป็นสมาชิก กยท.</label><input id="kyot_member"></div>
  <div class="field"><label>เลขสมาชิก กยท.</label><input id="kyot_member_id"></div>
  <div class="field"><label>ชื่อบิดา</label><input id="father_name"></div>
  <div class="field"><label>ชื่อมารดา</label><input id="mother_name"></div>
</div>

<div class="flex gap-4">
  <button class="btn blue" type="submit">บันทึก</button>
  <button class="btn gray" type="button" onclick="resetForm()">ยกเลิก</button>
</div>
</form>

<!-- ===== FILTER + EXPORT ===== -->
<div class="box space-y-3">
<h2 class="title text-center">ค้นหา / Export</h2>

<div class="grid grid-cols-1 md:grid-cols-9 gap-3">
  <input id="f_member_id" class="input" placeholder="รหัสสมาชิก">
  <input id="f_first_name" class="input" placeholder="ชื่อ">
  <input id="f_last_name" class="input" placeholder="นามสกุล">
  <input id="f_group" class="input" placeholder="กลุ่ม">
  <input id="f_phone" class="input" placeholder="เบอร์โทร">
  <select id="f_gender" class="input"><option value="">เพศ</option><option>ชาย</option><option>หญิง</option></select>
  <select id="f_status" class="input"><option value="">สถานะ</option><option>สมาชิก</option><option>ลาออก</option><option>เสียชีวิต</option></select>
  <button class="btn gray" onclick="clearFilters()">ล้างกรอง</button>
  <button class="btn green" onclick="exportExcel()">Export Excel</button>
  <button class="btn blue" onclick="printMemberReport()">Print</button>
</div>

<div class="text-center">พบ <b><span id="resultCount">0</span></b> รายการ</div>
</div>

<!-- ===== TABLE ===== -->
<div class="box">
<table class="w-full text-sm text-center">
<thead class="bg-blue-100">
<tr>
  <th>รหัส</th>
  <th>ชื่อ-นามสกุล</th>
  <th>กลุ่ม</th>
  <th>โทร</th>
  <th>เพศ</th>
  <th>สถานะ</th>
  <th>จัดการ</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const COOP_LOGO_URL = 'https://ttottijljxoinptmhgtu.supabase.co/storage/v1/object/public/slips/logo.png'
const db = createClient(SUPABASE_URL, SUPABASE_KEY)

/* ===========================================================
   ===== PRINT PATCH (LANDSCAPE + FLEXIBLE TABLE) =====
   =========================================================== */
window.printMemberReport = async ()=>{
  const pageSize = 1000
  let from = 0
  let allData = []

  while(true){
    const { data } = await db
      .from('members')
      .select('*')
      .order('member_id')
      .range(from, from + pageSize - 1)

    if(!data || !data.length) break
    allData = allData.concat(data)
    if(data.length < pageSize) break
    from += pageSize
  }

  if(!allData.length){
    alert('ไม่มีข้อมูลสำหรับพิมพ์')
    return
  }

  const today = new Date().toLocaleDateString('th-TH',{
    year:'numeric',month:'long',day:'numeric'
  })

  const rowsHtml = allData.map((r,i)=>`
<tr>
  <td class="center">${i+1}</td>
  <td class="center">${r.member_id}</td>
  <td>${r.title||''}${r.first_name||''} ${r.last_name||''}</td>
  <td class="address">
    ${r.house_no||''} หมู่ ${r.moo||''}
    ${r.village||''} ${r.subdistrict||''}
    ${r.district||''} ${r.province||''}
  </td>
  <td class="center">${r.phone||''}</td>
  <td class="signature"></td>
</tr>
`).join('')

  const html = `
<html>
<head>
<meta charset="UTF-8">
<style>
@page{
  size:A4 landscape;
  margin:15mm;
  @bottom-center{content:"หน้า " counter(page) " / " counter(pages);}
}
body{font-family:"TH Sarabun New",sans-serif;font-size:16px}
.header-grid{
  display:grid;
  grid-template-columns:100px 1fr 100px;
  align-items:center
}
.logo{width:80px}
.title-box{text-align:center}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  table-layout:fixed;
}
th,td{
  border:1px solid #000;
  padding:6px 8px;
  vertical-align:top;
}
th{background:#f0f0f0;text-align:center}

td.center{text-align:center}
td.address{text-align:left}
td.signature{height:55px}
</style>
</head>

<body>
<div class="header-grid">
  <div><img src="${COOP_LOGO_URL}" class="logo"></div>
  <div class="title-box">
    <h2>รายงานสมาชิก</h2>
    <div>ณ วันที่ ${today}</div>
    <div>รวม ${allData.length} ราย</div>
  </div>
  <div></div>
</div>

<table>
<colgroup>
  <col style="width:4%">
  <col style="width:8%">
  <col style="width:16%">
  <col style="width:42%">
  <col style="width:10%">
  <col style="width:20%">
</colgroup>
<thead>
<tr>
  <th>ลำดับ</th>
  <th>เลขสมาชิก</th>
  <th>ชื่อ-นามสกุล</th>
  <th>ที่อยู่</th>
  <th>เบอร์โทร</th>
  <th>ลายเซ็น</th>
</tr>
</thead>
<tbody>
${rowsHtml}
</tbody>
</table>
</body>
</html>`

  const w = window.open('')
  w.document.write(html)
  w.document.close()
  w.print()
}
</script>

<style>
.box{background:#fff;border:2px solid #93c5fd;border-radius:12px;padding:16px}
.field{display:flex;align-items:center;gap:6px}
.field label{width:120px}
.field input,.field select,.input{flex:1;border:2px solid #94a3b8;border-radius:6px;padding:6px}
.summary{background:#fff;border:2px solid;border-radius:12px;padding:12px;text-align:center}
.summary .num{font-size:28px;font-weight:700}
.btn{padding:6px 16px;border-radius:8px}
.btn.blue{background:#2563eb;color:#fff}
.btn.gray{background:#e5e7eb}
.btn.green{background:#16a34a;color:#fff}
.link{color:#2563eb;cursor:pointer}
</style>

</body>
</html>
