<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');

:root {
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --danger:#ef4444;
  --danger-dark:#b91c1c;
  --bg:#f1f5f9;
  --text:#1e293b;
  --radius:12px;
  --shadow:0 8px 24px rgba(0,0,0,0.08);
}

* { box-sizing:border-box; transition:all .2s ease; }
body {
  font-family:"Prompt",sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
  color:var(--text);
  line-height:1.6;
}

h2 {
  text-align:center;
  color:var(--primary-dark);
  margin:30px 0 20px;
  font-weight:600;
}

/* --- Form Step --- */
form {
  max-width:950px;
  margin:auto;
}
.form-step {
  display:none;
  background:#fff;
  padding:25px 30px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:20px;
  animation:fadeIn .3s ease;
}
.form-step.active { display:block; }

@keyframes fadeIn {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}

input, select {
  display:block;
  width:48%;
  margin:6px 1% 12px;
  padding:10px 12px;
  border:1px solid #d1d5db;
  border-radius:8px;
  font-size:14px;
  background:#f9fafb;
  transition:border .2s ease, box-shadow .2s ease;
}
input:focus, select:focus {
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,0.2);
  background:#fff;
}
label {
  font-size:14px;
  margin-right:8px;
  display:inline-block;
  color:#334155;
}

.form-navigation {
  text-align:center;
  margin-top:15px;
}
.form-navigation button {
  padding:8px 16px;
  margin:3px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:var(--primary);
  color:#fff;
  font-weight:500;
  letter-spacing:.3px;
}
.form-navigation button:hover {
  background:var(--primary-dark);
  transform:translateY(-1px);
}
#submitBtn {
  background:linear-gradient(135deg,#3b82f6,#1e40af);
}

/* --- Filter --- */
#filterDiv {
  background:#fff;
  padding:15px 18px;
  border-radius:var(--radius);
  max-width:950px;
  margin:25px auto 20px;
  box-shadow:var(--shadow);
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
}
#filterDiv input, #filterDiv select {
  padding:8px 10px;
  border:1px solid #d1d5db;
  border-radius:6px;
  font-size:13px;
  background:#f9fafb;
}
#filterDiv span {
  color:#475569;
  font-size:13px;
}

/* --- Table --- */
table {
  border-collapse: collapse;
  width:100%;
  max-width:1000px;
  margin:auto;
  font-size:13px;
  background:#fff;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}
th, td {
  border:1px solid #e2e8f0;
  padding:8px 10px;
  text-align:center;
}
th {
  background:var(--primary);
  color:#fff;
  cursor:pointer;
  position:relative;
  font-weight:500;
  user-select:none;
}
th span.sort-icon {
  position:absolute;
  right:8px;
  font-size:12px;
}
tr:nth-child(even){ background:#f9fafb; }
tr:hover{ background:#e0e7ff; }

/* --- Buttons in table --- */
button.edit, button.delete {
  padding:4px 8px;
  border:none;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
  font-weight:500;
}
button.edit { background:var(--primary); color:#fff; }
button.edit:hover { background:var(--primary-dark); transform:scale(1.05); }
button.delete { background:var(--danger); color:#fff; }
button.delete:hover { background:var(--danger-dark); transform:scale(1.05); }

/* --- Pagination --- */
.pagination {
  text-align:center;
  margin:18px auto;
}
.pagination button {
  padding:6px 12px;
  margin:3px;
  border:none;
  border-radius:6px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
  font-size:13px;
  font-weight:500;
}
.pagination button:hover {
  background:var(--primary-dark);
}
#pageInfo, #resultCount {
  font-weight:500;
  color:#1e293b;
  font-size:13px;
}

/* --- Responsive --- */
@media (max-width:768px) {
  input, select { width:100%; }
  #filterDiv { flex-direction:column; }
}
</style>
</head>
<body>

<h2>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<form id="memberForm">
  <!-- Step 1 -->
  <div class="form-step">
    <h3>Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" name="member_id" required>
    <input type="date" name="join_date" required>
    <input placeholder="‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" name="title" required>
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠" name="first_name" required>
    <input placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" name="last_name" required>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" name="id_card" required>
    <input type="date" name="birthday" required>
    <input placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà" name="group" required>
  </div>

  <!-- Step 2 -->
  <div class="form-step">
    <h3>Step 2: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h3>
    <input placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" name="house_no" required>
    <input placeholder="‡∏´‡∏°‡∏π‡πà" name="moo">
    <input placeholder="‡∏ñ‡∏ô‡∏ô" name="street" required>
    <input placeholder="‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" name="village">
    <input placeholder="‡∏ï‡∏≥‡∏ö‡∏•" name="subdistrict" required>
    <input placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" name="district" required>
    <input placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" name="province" required>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" name="postal_code" required>
    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" name="phone">
    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á" name="phone_alt">
  </div>

  <!-- Step 3 -->
  <div class="form-step">
    <h3>Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
    <select name="member_status" required>
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
      <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>
    <select name="marital_status" required>
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏£‡∏™--</option>
      <option value="‡πÇ‡∏™‡∏î">‡πÇ‡∏™‡∏î</option>
      <option value="‡∏´‡∏°‡πâ‡∏≤‡∏¢">‡∏´‡∏°‡πâ‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏¢‡πà‡∏≤">‡∏´‡∏¢‡πà‡∏≤</option>
    </select>
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" name="spouse_name">
    <label><input type="checkbox" name="kyot_member" style="accent-color:var(--primary)"> ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó</label>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó" name="kyot_member_id">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏î‡∏≤" name="father_name">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤" name="mother_name">
  </div>

  <div class="form-navigation">
    <button type="button" id="prevBtn">‚¨Ö ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <button type="button" id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°</button>
    <button type="submit" id="submitBtn" style="display:none;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>
</form>

<h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<div id="filterDiv">
  <input id="searchMemberId" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">
  <input id="searchName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <input id="searchGroup" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°">
  <input id="searchProvince" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
  <select id="searchStatus">
    <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
    <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
    <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
    <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
  </select>
  <span id="resultCount"></span>
</div>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<table id="memberTable">
  <thead>
    <tr>
      <th data-column="member_id">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="sort-icon"></span></th>
      <th data-column="first_name">‡∏ä‡∏∑‡πà‡∏≠ <span class="sort-icon"></span></th>
      <th data-column="last_name">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="sort-icon"></span></th>
      <th data-column="group">‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="sort-icon"></span></th>
      <th data-column="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="sort-icon"></span></th>
      <th data-column="member_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span class="sort-icon"></span></th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination">
  <button id="prevPage">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <span id="pageInfo"></span>
  <button id="nextPage">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>

<script>
// (JavaScript ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏î‡πÜ)
const API_URL='https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members';
const form=document.getElementById('memberForm');
const tableBody=document.querySelector('#memberTable tbody');
let editId=null;
let allMembers=[];
let sortColumn=null, sortAsc=true;
let currentPage=1, rowsPerPage=10;

// --- Multi-Step Form ---
const formSteps=document.querySelectorAll('.form-step');
let formStepIndex=0;
showStep(formStepIndex);

document.getElementById('nextBtn').addEventListener('click',()=>{
  if(!validateStep(formStepIndex)) return;
  formStepIndex++;
  showStep(formStepIndex);
});
document.getElementById('prevBtn').addEventListener('click',()=>{
  formStepIndex--;
  showStep(formStepIndex);
});

function showStep(n){
  formSteps.forEach((step,i)=>step.classList.remove('active'));
  formSteps[n].classList.add('active');
  document.getElementById('prevBtn').style.display=n===0?'none':'inline-block';
  document.getElementById('nextBtn').style.display=n===formSteps.length-1?'none':'inline-block';
  document.getElementById('submitBtn').style.display=n===formSteps.length-1?'inline-block':'none';
}

function validateStep(n){
  const inputs=formSteps[n].querySelectorAll('input,select');
  for(let inp of inputs){
    if(inp.hasAttribute('required') && !inp.value){
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: '+(inp.placeholder||inp.name));
      inp.focus();
      return false;
    }
  }
  return true;
}

// --- Load Members ---
async function loadMembers(){
  try{
    const res=await fetch(API_URL);
    const result=await res.json();
    if(result.error){ alert(result.error); return; }
    if(!Array.isArray(result.data)){ alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
    allMembers=result.data; filterMembers();
  }catch(err){ alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+err); }
}

// --- Render Table ---
function renderTable(members){
  tableBody.innerHTML='';
  const start=(currentPage-1)*rowsPerPage;
  const end=start+rowsPerPage;
  const paginated=members.slice(start,end);
  paginated.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${m.member_id}</td>
      <td>${m.first_name}</td>
      <td>${m.last_name}</td>
      <td>${m.group}</td>
      <td>${m.province}</td>
      <td>${m.member_status}</td>
      <td><button class="edit" onclick="editMember('${m.member_id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      <td><button class="delete" onclick="deleteMember('${m.member_id}')">‡∏•‡∏ö</button></td>
    `;
    tableBody.appendChild(tr);
  });
  const totalPages=Math.ceil(members.length/rowsPerPage);
  document.getElementById('pageInfo').textContent=`‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}`;
  document.getElementById('resultCount').textContent=`‡∏û‡∏ö ${members.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

// --- Filter ---
function filterMembers(){
  const idFilter=document.getElementById('searchMemberId').value.toLowerCase();
  const nameFilter=document.getElementById('searchName').value.toLowerCase();
  const groupFilter=document.getElementById('searchGroup').value.toLowerCase();
  const provinceFilter=document.getElementById('searchProvince').value.toLowerCase();
  const statusFilter=document.getElementById('searchStatus').value;
  let filtered=allMembers.filter(m=>{
    return (!idFilter||m.member_id.toLowerCase().includes(idFilter)) &&
           (!nameFilter||(m.first_name.toLowerCase().includes(nameFilter)||m.last_name.toLowerCase().includes(nameFilter))) &&
           (!groupFilter||(m.group&&m.group.toLowerCase().includes(groupFilter))) &&
           (!provinceFilter||(m.province&&m.province.toLowerCase().includes(provinceFilter))) &&
           (!statusFilter||m.member_status===statusFilter);
  });
  if(sortColumn){
    filtered.sort((a,b)=>{
      let valA=a[sortColumn]||'', valB=b[sortColumn]||'';
      valA=valA.toString().toLowerCase(); valB=valB.toString().toLowerCase();
      if(valA<valB) return sortAsc?-1:1;
      if(valA>valB) return sortAsc?1:-1;
      return 0;
    });
  }
  renderTable(filtered);
}

// --- Pagination ---
document.getElementById('prevPage').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; filterMembers(); } });
document.getElementById('nextPage').addEventListener('click',()=>{ const totalPages=Math.ceil(allMembers.length/rowsPerPage); if(currentPage<totalPages){ currentPage++; filterMembers(); } });
['searchMemberId','searchName','searchGroup','searchProvince','searchStatus'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{ currentPage=1; filterMembers(); }));

// --- Sorting ---
function sortTable(column){
  if(sortColumn===column) sortAsc=!sortAsc; else { sortColumn=column; sortAsc=true; }
  document.querySelectorAll('.sort-icon').forEach(el=>el.textContent='');
  const icon=document.querySelector(`th[data-column="${column}"] .sort-icon`);
  icon.textContent=sortAsc?'‚ñ≤':'‚ñº';
  filterMembers();
}
document.querySelectorAll('#memberTable th[data-column]').forEach(th=>{ th.addEventListener('click',()=>sortTable(th.dataset.column)); });

// --- Edit / Delete ---
async function editMember(id){
  const res=await fetch(`${API_URL}?member_id=${id}`);
  const result=await res.json();
  if(result.error) return alert(result.error);
  editId=id;
  Object.keys(result.data[0]).forEach(key=>{
    if(form[key]){
      if(form[key].type==='checkbox') form[key].checked=result.data[0][key];
      else form[key].value=result.data[0][key];
    }
  });
  formStepIndex=0; showStep(formStepIndex);
}
async function deleteMember(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return;
  const res=await fetch(`${API_URL}?member_id=${id}`,{method:'DELETE'});
  const result=await res.json();
  if(result.error) return alert(result.error);
  loadMembers();
}

// --- Submit ---
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const formDataObj={};
  new FormData(form).forEach((v,k)=>formDataObj[k]=v);
  formDataObj.kyot_member=form.kyot_member.checked;
  const method=editId?'PUT':'POST';
  const url=editId?`${API_URL}?member_id=${editId}`:API_URL;
  const res=await fetch(url,{
    method,
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(formDataObj)
  });
  const result=await res.json();
  if(result.error) return alert(result.error);
  editId=null;
  form.reset();
  formStepIndex=0; showStep(formStepIndex);
  loadMembers();
});

loadMembers();
</script>
</body>
</html>
