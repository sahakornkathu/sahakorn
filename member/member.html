<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบสมาชิก</title>
<style>
  input, select { display:block; margin:5px 0; padding:5px; width:300px; }
  table { border-collapse: collapse; margin-top:20px; width:100%; }
  th, td { border:1px solid #333; padding:5px; text-align:center; }
  button { margin:2px; }
</style>
</head>
<body>

<h2>ฟอร์มบันทึกสมาชิก</h2>
<form id="memberForm">
  <input placeholder="เลขสมาชิก" name="member_id" required>
  <input type="date" name="join_date" required>
  <input placeholder="คำนำหน้า" name="title" required>
  <input placeholder="ชื่อ" name="first_name" required>
  <input placeholder="นามสกุล" name="last_name" required>
  <input placeholder="เลขบัตรประชาชน" name="id_card" required>
  <input type="date" name="birthday" required>
  <input placeholder="กลุ่มที่" name="group" required>
  <input placeholder="บ้านเลขที่" name="house_no" required>
  <input placeholder="หมู่" name="moo">
  <input placeholder="ถนน" name="street" required>
  <input placeholder="หมู่บ้าน" name="village">
  <input placeholder="ตำบล" name="subdistrict" required>
  <input placeholder="อำเภอ" name="district" required>
  <input placeholder="จังหวัด" name="province" required>
  <input placeholder="เลขไปรษณีย์" name="postal_code" required>
  <input placeholder="เบอร์โทรศัพท์" name="phone">
  <input placeholder="เบอร์โทรศัพท์สำรอง" name="phone_alt">
  <select name="member_status" required>
    <option value="">--สถานะสมาชิก--</option>
    <option value="สมาชิก">สมาชิก</option>
    <option value="ลาออก">ลาออก</option>
    <option value="เสียชีวิต">เสียชีวิต</option>
  </select>
  <select name="marital_status" required>
    <option value="">--สถานะสมรส--</option>
    <option value="โสด">โสด</option>
    <option value="หม้าย">หม้าย</option>
    <option value="หย่า">หย่า</option>
  </select>
  <input placeholder="ชื่อคู่สมรส" name="spouse_name">
  <label>สมาชิก กยท <input type="checkbox" name="kyot_member"></label>
  <input placeholder="เลขสมาชิก กยท" name="kyot_member_id">
  <input placeholder="ชื่อบิดา" name="father_name">
  <input placeholder="ชื่อมารดา" name="mother_name">
  <button type="submit">บันทึก</button>
</form>

<h2>รายการสมาชิก</h2>
<table id="memberTable">
  <thead>
    <tr>
      <th>เลขสมาชิก</th><th>ชื่อ</th><th>นามสกุล</th><th>สถานะ</th><th>แก้ไข</th><th>ลบ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_URL = 'https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members';

const form = document.getElementById('memberForm');
const tableBody = document.querySelector('#memberTable tbody');
let editId = null;

async function loadMembers() {
  try {
    const res = await fetch(API_URL);
    const result = await res.json();

    if(result.error) { alert(result.error); return; }
    if(!Array.isArray(result.data)) { alert("ข้อมูลสมาชิกไม่ถูกต้อง"); return; }

    tableBody.innerHTML = '';
    result.data.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.member_id}</td>
        <td>${m.first_name}</td>
        <td>${m.last_name}</td>
        <td>${m.member_status}</td>
        <td><button onclick="editMember('${m.member_id}')">แก้ไข</button></td>
        <td><button onclick="deleteMember('${m.member_id}')">ลบ</button></td>
      `;
      tableBody.appendChild(tr);
    });

  } catch(err) {
    alert("เกิดข้อผิดพลาด: " + err);
  }
}

async function editMember(id) {
  try {
    const res = await fetch(`${API_URL}?member_id=${id}`);
    const result = await res.json();
    if(result.error) { alert(result.error); return; }
    editId = id;
    Object.keys(result.data[0]).forEach(key => {
      if(form[key]) {
        if(form[key].type === 'checkbox') form[key].checked = result.data[0][key];
        else form[key].value = result.data[0][key];
      }
    });
  } catch(err){
    alert(err);
  }
}

async function deleteMember(id){
  if(!confirm('ต้องการลบสมาชิกนี้?')) return;
  try{
    const res = await fetch(`${API_URL}?member_id=${id}`, { method:'DELETE' });
    const result = await res.json();
    if(result.error) { alert(result.error); return; }
    loadMembers();
  } catch(err){
    alert(err);
  }
}

form.addEventListener('submit', async e=>{
  e.preventDefault();
  const formData = {};
  new FormData(form).forEach((v,k)=> formData[k]=v);
  formData.kyot_member = form.kyot_member.checked;

  try{
    if(editId){
      const res = await fetch(`${API_URL}?member_id=${editId}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(formData)
      });
      const result = await res.json();
      if(result.error) { alert(result.error); return; }
      editId = null;
    } else {
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(formData)
      });
      const result = await res.json();
      if(result.error) { alert(result.error); return; }
    }
    form.reset();
    loadMembers();
  } catch(err){
    alert(err);
  }
});

loadMembers();
</script>

</body>
</html>
