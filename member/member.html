<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
/* ‡∏¢‡πà‡∏≠‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ */
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
body { font-family:"Prompt",sans-serif; background:#f0f4f8; margin:20px; color:#333; }
h2 { text-align:center; color:#1e40af; margin-bottom:15px; }
form { max-width:950px; margin:auto; }
.form-step { display:none; background:#fff; padding:20px 25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.08); margin-bottom:20px; }
.form-step.active { display:block; }
input, select { display:block; width:48%; margin:5px 1% 10px 1%; padding:6px 10px; border:1px solid #ccc; border-radius:6px; font-size:14px; background:#f9fafb; }
input:focus, select:focus { outline:none; border-color:#4a90e2; box-shadow:0 0 5px rgba(74,144,226,0.3); background:#fff; }
label{ font-size:13px; margin-right:8px; display:inline-block; }
small{ font-size:12px; color:#555; }
.form-navigation { text-align:center; margin-top:15px; }
.form-navigation button { padding:6px 12px; margin:3px; border:none; border-radius:6px; cursor:pointer; background:#4a90e2; color:#fff; }
.form-navigation button:hover { background:#357abd; }
#filterDiv { background:#fff; padding:12px 15px; border-radius:10px; max-width:950px; margin:25px auto 15px; box-shadow:0 4px 12px rgba(0,0,0,0.08); display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
#filterDiv input, #filterDiv select { padding:5px 8px; border:1px solid #ccc; border-radius:6px; font-size:13px; flex:1 1 150px; }
#filterDiv label { font-size:13px; color:#1e40af; margin:0 3px; }
table { border-collapse: collapse; width:100%; max-width:1000px; margin:auto; font-size:13px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
th, td { border:1px solid #e2e8f0; padding:6px 8px; text-align:center; }
th { background:#4a90e2; color:#fff; cursor:pointer; position:relative; font-weight:500; }
th span.sort-icon { position:absolute; right:6px; font-size:12px; }
tr:nth-child(even){ background:#f9fafb; }
tr:hover{ background:#edf2f7; }
button.edit { background:#4a90e2; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.edit:hover { background:#357abd; }
button.delete { background:#f56565; color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }
button.delete:hover { background:#c53030; }
.pagination { text-align:center; margin:12px auto; display:flex; flex-wrap:wrap; justify-content:center; gap:6px; }
.pagination button { padding:5px 10px; margin:3px; border:none; border-radius:5px; background:#4a90e2; color:#fff; cursor:pointer; font-size:13px; }
.pagination button:hover{ background:#357abd; }
#pageInfo, #resultCount{ font-weight:500; color:#2d3748; font-size:13px; }

.progress-container { display:flex; justify-content:space-between; align-items:center; max-width:950px; margin:0 auto 20px auto; position:relative; counter-reset: step; }
.progress-container::before { content:""; position:absolute; top:50%; left:0; width:100%; height:3px; background-color:#e2e8f0; transform:translateY(-50%); z-index:0; }
.progress-step { position:relative; z-index:1; background:#f9fafb; color:#4a5568; border:2px solid #cbd5e0; border-radius:50px; padding:8px 15px; font-size:13px; font-weight:500; flex:1; text-align:center; margin:0 4px; transition:all 0.3s; white-space:nowrap; }
.progress-step.active { background:#4a90e2; color:#fff; border-color:#4a90e2; box-shadow:0 0 8px rgba(74,144,226,0.5); }

#dashboard { display:flex; justify-content:center; flex-wrap:wrap; gap:15px; max-width:950px; margin:25px auto; }
#dashboard .card { flex:1 1 200px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:20px; text-align:center; font-size:15px; font-weight:500; color:#1e3a8a; }
#dashboard .card span { display:block; font-size:26px; font-weight:700; color:#111827; margin-top:5px; }
#dashboard .total { border-top:4px solid #4a90e2; }
#dashboard .active { border-top:4px solid #10b981; }
#dashboard .exit { border-top:4px solid #f59e0b; }
#dashboard .dead { border-top:4px solid #ef4444; }

/* responsive tweaks */
@media (max-width:768px){
  input, select{ width:100% !important; margin:6px 0 12px 0; }
  table{ display:block; overflow-x:auto; }
}
</style>
</head>
<body>

<!-- Dashboard -->
<div id="dashboard">
  <div class="card total">üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br><span id="totalMembers">0</span></div>
  <div class="card active">‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å<br><span id="activeMembers">0</span></div>
  <div class="card exit">üìÑ ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å<br><span id="exitMembers">0</span></div>
  <div class="card dead">‚ö∞Ô∏è ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï<br><span id="deadMembers">0</span></div>
</div>

<h2>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<div class="progress-container">
  <div class="progress-step active" data-step="1">‚ë† ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
  <div class="progress-step" data-step="2">‚ë° ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
  <div class="progress-step" data-step="3">‚ë¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
</div>

<form id="memberForm">
  <div class="form-step active">
    <h3>Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" name="member_id" required>
    <small>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</small>
    <input type="date" name="join_date" required>
    <input placeholder="‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" name="title" required>
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠" name="first_name" required>
    <input placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" name="last_name" required>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (x-xxxx-xxxxx-xx-x)" name="id_card" maxlength="17">
    <small>üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</small>
    <input type="date" name="birthday" id="birthday">
    <input placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" name="age" id="age" readonly>
    <select name="gender">
      <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®--</option>
      <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
    </select>
    <select name="group">
      <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°--</option>
      <option value="1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1</option>
      <option value="2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2</option>
      <option value="3">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3</option>
      <option value="4">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 4</option>
      <option value="5">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 5</option>
      <option value="6">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 6</option>
      <option value="7">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 7</option>
      <option value="8">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 8</option>
      <option value="9">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 9</option>
    </select>
  </div>

  <div class="form-step">
    <h3>Step 2: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h3>
    <input placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" name="house_no">
    <input placeholder="‡∏´‡∏°‡∏π‡πà" name="moo">
    <input placeholder="‡∏ñ‡∏ô‡∏ô" name="street">
    <input placeholder="‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" name="village">
    <input placeholder="‡∏ï‡∏≥‡∏ö‡∏•" name="subdistrict">
    <input placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" name="district">
    <input placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" name="province">
    <input placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" name="postal_code">
    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" name="phone">
    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á" name="phone_alt">
  </div>

  <div class="form-step">
    <h3>Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
    <select name="member_status">
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
      <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>
    <select name="marital_status">
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏£‡∏™--</option>
      <option value="‡πÇ‡∏™‡∏î">‡πÇ‡∏™‡∏î</option>
      <option value="‡∏™‡∏°‡∏£‡∏™">‡∏™‡∏°‡∏£‡∏™</option>
      <option value="‡∏´‡∏°‡πâ‡∏≤‡∏¢">‡∏´‡∏°‡πâ‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏¢‡πà‡∏≤">‡∏´‡∏¢‡πà‡∏≤</option>
    </select>
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" name="spouse_name">
    <label style="display:block;margin:8px 0;"><input type="checkbox" name="kyot_member"> ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó</label>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó" name="kyot_member_id">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏î‡∏≤" name="father_name">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤" name="mother_name">
  </div>

  <div class="form-navigation">
    <button type="button" id="prevBtn" style="display:none;">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <button type="button" id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    <button type="submit" id="submitBtn" style="display:none;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>
</form>

<h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<div id="filterDiv">
  <input id="searchMemberId" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">
  <input id="searchName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <input id="searchGroup" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°">
  <input id="searchProvince" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
  <div class="date-filter" style="display:flex;gap:6px;align-items:center;">
    <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="searchJoinDateStart">
    <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="searchJoinDateEnd">
  </div>
  <div class="bottom-filters" style="display:flex;gap:10px;align-items:center;">
    <select id="searchStatus">
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
      <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>
    <select id="searchGender">
      <option value="">--‡πÄ‡∏û‡∏®--</option>
      <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
    </select>
    <div class="buttons-group" style="display:flex;gap:8px;">
      <button id="printReport">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      <button id="clearFilter">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </div>
  <span id="resultCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
</div>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<table id="memberTable">
  <thead>
    <tr>
      <th data-column="member_id">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="sort-icon"></span></th>
      <th data-column="first_name">‡∏ä‡∏∑‡πà‡∏≠ <span class="sort-icon"></span></th>
      <th data-column="last_name">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="sort-icon"></span></th>
      <th data-column="group">‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="sort-icon"></span></th>
      <th data-column="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="sort-icon"></span></th>
      <th data-column="member_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span class="sort-icon"></span></th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination">
  <button id="prevPage">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <span id="pageInfo">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
  <button id="nextPage">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>

<!-- Modal ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
<div id="passwordModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:white; padding:25px 30px; border-radius:12px; text-align:center; max-width:320px;">
    <h3 style="margin-top:0; color:#1e3a8a;">üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
    <input type="password" id="adminPasswordInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" style="padding:8px 10px; width:90%; margin:10px auto; border:1px solid #ccc; border-radius:6px;">
    <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
      <button id="confirmPasswordBtn" style="background:#4a90e2; color:white; border:none; padding:6px 14px; border-radius:6px; cursor:pointer;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button id="cancelPasswordBtn" style="background:#ccc; color:#333; border:none; padding:6px 14px; border-radius:6px; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å -->
<div style="position:fixed; top:15px; right:20px; z-index:10000;">
  <button id="logoutBtn" style="background:#ef4444; color:#fff; border:none; border-radius:8px; padding:6px 12px; cursor:pointer;">üîì ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
</div>

<script>
/* ====== CONFIG ====== */
const API_URL = 'https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members'; // ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const CHUNK_SIZE = 1000; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö (backend ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ?range_start=)
const rowsPerPage = 10;

/* ====== STATE & ELEMENTS ====== */
const form = document.getElementById('memberForm');
const tableBody = document.querySelector('#memberTable tbody');
let allMembers = [];
let editId = null;
let sortColumn = null, sortAsc = true;
let currentPage = 1;

/* Multi-step */
const formSteps = document.querySelectorAll('.form-step');
const progressSteps = document.querySelectorAll('.progress-step');
let formStepIndex = 0;
showStep(formStepIndex);
document.getElementById('nextBtn').addEventListener('click', ()=>{ if(!validateStep(formStepIndex)) return; formStepIndex++; showStep(formStepIndex); });
document.getElementById('prevBtn').addEventListener('click', ()=>{ formStepIndex--; showStep(formStepIndex); });

function showStep(n){
  formSteps.forEach((s,i)=>s.classList.toggle('active', i===n));
  progressSteps.forEach((p,i)=>p.classList.toggle('active', i<=n));
  document.getElementById('prevBtn').style.display = n===0 ? 'none' : 'inline-block';
  document.getElementById('nextBtn').style.display = n===formSteps.length-1 ? 'none' : 'inline-block';
  document.getElementById('submitBtn').style.display = n===formSteps.length-1 ? 'inline-block' : 'none';
}
function validateStep(n){
  const inputs = formSteps[n].querySelectorAll('input,select');
  for(let i of inputs){
    if(i.hasAttribute('required') && !i.value){
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + (i.placeholder || i.name));
      i.focus();
      return false;
    }
  }
  return true;
}

/* ====== Utility: animate count ====== */
function animateCount(elem, start, end, duration = 700) {
  start = Number(start) || 0;
  end = Number(end) || 0;
  const diff = end - start;
  if (diff === 0) { elem.textContent = String(end); return; }
  const t0 = performance.now();
  function frame(t) {
    const p = Math.min(1, (t - t0) / duration);
    const eased = p < 0.5 ? 2*p*p : -1 + (4 - 2*p)*p;
    const cur = Math.round(start + diff * eased);
    elem.textContent = cur.toLocaleString();
    if (p < 1) requestAnimationFrame(frame);
    else elem.textContent = end.toLocaleString();
  }
  requestAnimationFrame(frame);
}

/* ====== Dashboard update ====== */
function updateDashboard() {
  const total = allMembers.length;
  const active = allMembers.filter(m => (m.member_status||'') === '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length;
  const exit = allMembers.filter(m => (m.member_status||'') === '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å').length;
  const dead = allMembers.filter(m => (m.member_status||'') === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï').length;

  animateCount(document.getElementById('totalMembers'), parseInt(document.getElementById('totalMembers').textContent.replace(/,/g,'')) || 0, total);
  animateCount(document.getElementById('activeMembers'), parseInt(document.getElementById('activeMembers').textContent.replace(/,/g,'')) || 0, active);
  animateCount(document.getElementById('exitMembers'), parseInt(document.getElementById('exitMembers').textContent.replace(/,/g,'')) || 0, exit);
  animateCount(document.getElementById('deadMembers'), parseInt(document.getElementById('deadMembers').textContent.replace(/,/g,'')) || 0, dead);
}

/* ====== Helper date normalization ====== */
// Accept DB date like "2005/02/18" or ISO "2005-02-18T..." etc -> return YYYY-MM-DD
function normalizeDateForInput(raw) {
  if (!raw) return '';
  if (typeof raw !== 'string') raw = String(raw);
  // case: YYYY/MM/DD
  if (/^\d{4}\/\d{2}\/\d{2}$/.test(raw)) return raw.replace(/\//g, '-');
  // case: YYYY-MM-DD or ISO
  if (/^\d{4}-\d{2}-\d{2}/.test(raw)) return raw.split('T')[0];
  // try Date parse fallback
  const d = new Date(raw);
  if (!isNaN(d)) {
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  }
  return '';
}

/* compute age from YYYY-MM-DD string */
function computeAgeFromDate(yyyyMMdd) {
  if (!yyyyMMdd) return null;
  const d = new Date(yyyyMMdd);
  if (isNaN(d)) return null;
  const today = new Date();
  let a = today.getFullYear() - d.getFullYear();
  const md = today.getMonth() - d.getMonth();
  if (md < 0 || (md === 0 && today.getDate() < d.getDate())) a--;
  return a >= 0 ? a : null;
}

/* ====== Load members chunked ====== */
async function loadMembers() {
  try {
    allMembers = [];
    let from = 0;
    while (true) {
      const res = await fetch(`${API_URL}?range_start=${from}`);
      if (!res.ok) throw new Error('HTTP error ' + res.status);
      const result = await res.json();
      // result might be array or { success, data }
      const data = Array.isArray(result) ? result : (result.data || []);
      if (!Array.isArray(data)) break;
      if (data.length === 0) break;
      allMembers = allMembers.concat(data);
      if (data.length < CHUNK_SIZE) break;
      from += CHUNK_SIZE;
    }

    // Normalize some fields (dates) and compute age if empty or stale
    const updates = [];
    for (let m of allMembers) {
      // normalize join_date and birthday for JS usage
      if (m.join_date) m.join_date_norm = normalizeDateForInput(m.join_date);
      if (m.birthday) m.birthday_norm = normalizeDateForInput(m.birthday);
      // compute age and if differs from stored, prepare update
      const computedAge = computeAgeFromDate(m.birthday_norm);
      const storedAge = (m.age === null || m.age === undefined) ? null : Number(m.age);
      if (computedAge !== null && computedAge !== storedAge) {
        // update DB for this member (deferred: batch updates or individual one-by-one)
        updates.push({ member_id: m.member_id, age: computedAge });
        // update local copy to reflect new age immediately
        m.age = computedAge;
      }
    }

    // if there are updates, send them to backend in sequence (one by one to keep simple)
    if (updates.length > 0) {
      console.log(`Updating ages for ${updates.length} members...`);
      for (let u of updates) {
        try {
          await fetch(`${API_URL}?member_id=${encodeURIComponent(u.member_id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ age: u.age })
          });
        } catch (e) {
          console.warn('Failed updating age for', u.member_id, e);
        }
      }
      // optionally reload to reflect server data consistency - but we'll keep local changes
    }

    updateDashboard();
    renderTable();
    console.log('Loaded members:', allMembers.length);
  } catch (err) {
    console.error('loadMembers error', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err);
  }
}

/* ====== Render table (filter/sort/pagination) ====== */
function renderTable() {
  let rows = allMembers.slice();

  // filters
  const startDate = document.getElementById('searchJoinDateStart').value ? new Date(document.getElementById('searchJoinDateStart').value) : null;
  const endDate = document.getElementById('searchJoinDateEnd').value ? new Date(document.getElementById('searchJoinDateEnd').value) : null;
  const memberId = document.getElementById('searchMemberId').value.trim();
  const name = document.getElementById('searchName').value.trim().toLowerCase();
  const group = document.getElementById('searchGroup').value.trim();
  const province = document.getElementById('searchProvince').value.trim().toLowerCase();
  const status = document.getElementById('searchStatus').value;
  const gender = document.getElementById('searchGender').value;

  rows = rows.filter(m => {
    if (memberId && !((m.member_id||'')+'').includes(memberId)) return false;
    if (name && !((((m.first_name||'')+' '+(m.last_name||''))).toLowerCase().includes(name))) return false;
    if (group && ((m.group||'')+'') !== group) return false;
    if (province && !((m.province||'').toLowerCase().includes(province))) return false;
    if (status && (m.member_status||'') !== status) return false;
    if (gender && (m.gender||'') !== gender) return false;
    if (startDate && m.join_date && new Date(normalizeDateForInput(m.join_date)) < startDate) return false;
    if (endDate && m.join_date && new Date(normalizeDateForInput(m.join_date)) > endDate) return false;
    return true;
  });

  // sorting (by column) - if column is member_id, sort numerically
  if (sortColumn) {
    rows.sort((a,b) => {
      const va = a[sortColumn] ?? '';
      const vb = b[sortColumn] ?? '';
      if (sortColumn === 'member_id') {
        const na = parseInt(va) || 0;
        const nb = parseInt(vb) || 0;
        return sortAsc ? na - nb : nb - na;
      } else {
        const aa = (va+'').toString().toLowerCase();
        const bb = (vb+'').toString().toLowerCase();
        if (aa === bb) return 0;
        return sortAsc ? (aa > bb ? 1 : -1) : (aa < bb ? 1 : -1);
      }
    });
  }

  // pagination
  const start = (currentPage - 1) * rowsPerPage;
  const pageRows = rows.slice(start, start + rowsPerPage);

  // render
  tableBody.innerHTML = '';
  for (let m of pageRows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m.member_id ?? ''}</td>
      <td>${m.first_name ?? ''}</td>
      <td>${m.last_name ?? ''}</td>
      <td>${m.group ?? ''}</td>
      <td>${m.province ?? ''}</td>
      <td>${m.member_status ?? ''}</td>
      <td><button class="edit" onclick="editMember('${m.member_id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      <td><button class="delete" onclick="deleteMember('${m.member_id}')">‡∏•‡∏ö</button></td>
    `;
    tableBody.appendChild(tr);
  }

  document.getElementById('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}`;
  document.getElementById('resultCount').textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

/* ====== Sorting / Pagination wiring ====== */
document.querySelectorAll('#memberTable th[data-column]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.getAttribute('data-column');
    if (sortColumn === col) sortAsc = !sortAsc;
    else { sortColumn = col; sortAsc = true; }
    renderTable();
  });
});
document.getElementById('prevPage').addEventListener('click', ()=>{ if (currentPage>1) { currentPage--; renderTable(); }});
document.getElementById('nextPage').addEventListener('click', ()=>{ currentPage++; renderTable(); });

['searchMemberId','searchName','searchGroup','searchProvince','searchStatus','searchGender','searchJoinDateStart','searchJoinDateEnd']
.forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', ()=>{ currentPage = 1; renderTable(); });
});

/* ====== Edit/Delete handlers ====== */
/* Password-protect edit: modal logic below */
let pendingEditId = null;
let verified = false;

const passwordModal = document.getElementById("passwordModal");
const passwordInput = document.getElementById("adminPasswordInput");
const confirmBtn = document.getElementById("confirmPasswordBtn");
const cancelBtn = document.getElementById("cancelPasswordBtn");
const logoutBtn = document.getElementById("logoutBtn");

// confirmBtn/cancelBtn should exist
confirmBtn.addEventListener('click', () => {
  const ADMIN_PASSWORD = "1234"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const pw = passwordInput.value.trim();
  if (!pw) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }
  if (pw !== ADMIN_PASSWORD) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); passwordInput.value=''; passwordInput.focus(); return; }
  verified = true;
  closePasswordModal();
  if (pendingEditId) doEditMember(pendingEditId);
});
cancelBtn.addEventListener('click', closePasswordModal);
passwordModal.addEventListener('click', e => { if (e.target === passwordModal) closePasswordModal(); });

logoutBtn.addEventListener('click', () => {
  if (!verified) { alert('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'); return; }
  if (confirm('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { verified = false; alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡πâ‡∏ß'); }
});

function openPasswordModal(memberId) {
  pendingEditId = memberId;
  passwordInput.value = '';
  passwordModal.style.display = 'flex';
  passwordInput.focus();
}
function closePasswordModal() {
  passwordModal.style.display = 'none';
  pendingEditId = null;
}

// export editMember to global scope for buttons
window.editMember = (id) => {
  if (!verified) { openPasswordModal(id); return; }
  doEditMember(id);
};

function doEditMember(id) {
  const m = allMembers.find(x => (x.member_id+'') === (id+''));
  if (!m) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
  editId = id;
  // fill form fields
  for (let k in m) {
    if (!form.elements[k]) continue;
    let val = m[k];
    if (typeof val === 'string' && /^\d{4}\/\d{2}\/\d{2}$/.test(val)) val = val.replace(/\//g,'-');
    if (typeof val === 'string' && val.includes('T')) val = val.split('T')[0];
    form.elements[k].value = val ?? '';
  }
  // compute age and fill
  const bdInput = form.elements['birthday'];
  const ageInput = form.elements['age'];
  if (bdInput && bdInput.value) {
    ageInput.value = computeAgeFromDate(bdInput.value) ?? '';
  } else if (ageInput) ageInput.value = '';
  formStepIndex = 0; showStep(0);
}

window.deleteMember = async (id) => {
  if (!confirm('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return;
  try {
    const res = await fetch(`${API_URL}?member_id=${encodeURIComponent(id)}`, { method:'DELETE' });
    const json = await res.json();
    if (json.error) { alert(json.error); return; }
    allMembers = allMembers.filter(m => (m.member_id+'') !== (id+''));
    updateDashboard();
    renderTable();
  } catch (e) {
    console.error('delete error', e);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏•‡∏ö: '+e);
  }
};

/* ====== Form submit (create/update) ====== */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form));

  // normalize dates
  if (data.join_date) data.join_date = data.join_date.replace(/\//g,'-');
  if (data.birthday) data.birthday = data.birthday.replace(/\//g,'-');
  // compute age
  if (data.birthday) data.age = computeAgeFromDate(data.birthday);
  else data.age = null;
  // sanitize id_card
  if (data.id_card) data.id_card = data.id_card.replace(/\D/g,'');

  try {
    const method = editId ? 'PUT' : 'POST';
    const url = editId ? `${API_URL}?member_id=${encodeURIComponent(editId)}` : API_URL;
    const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    const result = await res.json();
    if (result.error) { alert(result.error); return; }
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    form.reset();
    editId = null;
    await loadMembers();
  } catch (err) {
    console.error('save error', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: '+err);
  }
});

/* ====== Print Report (sorted by numeric member_id) ====== */
document.getElementById('printReport').addEventListener('click', () => {
  // gather current filters
  const groupFilter = document.getElementById('searchGroup').value.toLowerCase();
  const statusFilter = document.getElementById('searchStatus').value;
  const genderFilter = document.getElementById('searchGender').value;
  const joinDateStart = document.getElementById('searchJoinDateStart').value;
  const joinDateEnd = document.getElementById('searchJoinDateEnd').value;

  let filtered = allMembers.filter(m => {
    const joinDate = m.join_date ? (normalizeDateForInput(m.join_date)) : '';
    return (!groupFilter || (m.group && (''+m.group).toLowerCase() === groupFilter))
      && (!statusFilter || m.member_status === statusFilter)
      && (!genderFilter || m.gender === genderFilter)
      && (!joinDateStart || joinDate >= joinDateStart)
      && (!joinDateEnd || joinDate <= joinDateEnd);
  });

  // sort numerically by member_id
  filtered.sort((a,b) => {
    const idA = parseInt(a.member_id) || 0;
    const idB = parseInt(b.member_id) || 0;
    return idA - idB;
  });

  // build printable HTML
  let printContent = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div style="flex:0 0 auto;"></div>
      <div style="text-align:center;">
        <h2 style="margin:0">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
        <div style="font-size:13px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusFilter||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'} | ‡πÄ‡∏û‡∏®: ${genderFilter||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</div>
      </div>
      <div style="flex:0 0 100px;"></div>
    </div>
    <table style="width:100%;border-collapse:collapse;font-family:inherit;">
      <thead>
        <tr style="background:#4a90e2;color:#fff;">
          <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
        </tr>
      </thead>
      <tbody>
  `;
  filtered.forEach(m => {
    const fullName = `${m.title||''} ${m.first_name||''} ${m.last_name||''}`.trim();
    const addr = `${m.house_no||''} ${m.moo||''} ${m.street||''} ${m.village||''} ${m.subdistrict||''} ${m.district||''} ${m.province||''} ${m.postal_code||''}`.replace(/\s+/g,' ').trim();
    printContent += `
      <tr>
        <td>${m.member_id||''}</td>
        <td>${fullName}</td>
        <td>${addr}</td>
        <td>${m.phone||''}</td>
      </tr>
    `;
  });
  printContent += '</tbody></table>';
  const w = window.open('','', 'width=900,height=600');
  w.document.write(`<html><head><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title></head><body style="font-family:Prompt, sans-serif;padding:20px;">${printContent}</body></html>`);
  w.document.close();
  w.print();
});

/* ====== Clear filters ====== */
document.getElementById('clearFilter').addEventListener('click', () => {
  ['searchMemberId','searchName','searchGroup','searchProvince','searchStatus','searchGender','searchJoinDateStart','searchJoinDateEnd']
  .forEach(id => document.getElementById(id).value = '');
  currentPage = 1; renderTable();
});

/* ====== Birthday change => update age field in form ====== */
const birthdayInput = document.getElementById('birthday');
if (birthdayInput) {
  birthdayInput.addEventListener('change', () => {
    const val = birthdayInput.value;
    const ai = document.getElementById('age');
    const age = computeAgeFromDate(val);
    ai.value = age === null ? '' : age;
  });
}

/* ====== Initial load ====== */
loadMembers();
</script>

</body>
</html>
