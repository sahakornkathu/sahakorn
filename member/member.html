<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-blue-50 p-6 text-slate-800">
<div class="max-w-7xl mx-auto space-y-6">

<!-- ===== SUMMARY ===== -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
  <div class="summary green">
    <div>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
    <div id="count-member" class="num">0</div>
  </div>

  <div class="summary purple">
    <div>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
    <div id="count-associate" class="num">0</div>
  </div>

  <div class="summary orange">
    <div>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</div>
    <div id="count-resign" class="num">0</div>
  </div>

  <div class="summary red">
    <div>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</div>
    <div id="count-dead" class="num">0</div>
  </div>
</div>



<!-- ===== FORM ===== -->
<form id="memberForm" class="box space-y-4">
<h2 class="title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

<div class="grid grid-cols-1 md:grid-cols-4 gap-3">
  <div class="field"><label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label> <input id="member_id" type="number" required oninput="if(this.value.length > 8) this.value = this.value.slice(0,8)"></div>
  <div class="field"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label><input id="join_date" type="date"></div>
  <div class="field"><label>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
    <select id="title"><option value="">--</option><option>‡∏ô‡∏≤‡∏¢</option><option>‡∏ô‡∏≤‡∏á</option><option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option></select>
  </div>
  <div class="field"><label>‡∏Å‡∏•‡∏∏‡πà‡∏°</label><input id="group"></div>

  <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="first_name"></div>
  <div class="field"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="last_name"></div>
  <div class="field"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input id="id_card" type="number" inputmode="numeric" oninput="if(this.value.length > 13) this.value = this.value.slice(0,13)"></div>
  <div class="field"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input id="birthday" type="date"></div>
  <div class="field"><label>‡πÄ‡∏û‡∏®</label>
    <select id="gender"><option value="">--</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option></select>
  </div>
  <div class="field"><label>‡∏≠‡∏≤‡∏¢‡∏∏</label><input id="age" type="number"></div>

  <div class="field"><label>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input id="house_no"></div>
  <div class="field"><label>‡∏´‡∏°‡∏π‡πà</label><input id="moo"></div>
  <div class="field"><label>‡∏ñ‡∏ô‡∏ô</label><input id="street"></div>
  <div class="field"><label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label><input id="village"></div>

  <div class="field"><label>‡∏ï‡∏≥‡∏ö‡∏•</label><input id="subdistrict"></div>
  <div class="field"><label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label><input id="district"></div>
  <div class="field"><label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input id="province"></div>
  <div class="field"><label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label><input id="postal_code"></div>

  <div class="field"><label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input id="phone"></div>
  <div class="field"><label>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á</label><input id="phone_alt"></div>

  <div class="field"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
    <select id="member_status"><option value="">--</option><option>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option><option>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</option><option>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option><option>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option></select>
  </div>

  <div class="field"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™</label>
    <select id="marital_status"><option value="">--</option><option>‡πÇ‡∏™‡∏î</option><option>‡∏™‡∏°‡∏£‡∏™</option></select>
  </div>

  <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</label><input id="spouse_name"></div>
  <div class="field"><label>‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó.</label><input id="kyot_member"></div>
  <div class="field"><label>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó.</label><input id="kyot_member_id"></div>
  <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏î‡∏≤</label><input id="father_name"></div>
  <div class="field"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤</label><input id="mother_name"></div>
</div>

<div class="flex gap-4">
  <button class="btn blue" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="btn gray" type="button" onclick="resetForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</form>

<!-- ===== FILTER + EXPORT ===== -->
<div class="box space-y-3">
<h2 class="title text-center">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / Export</h2>

<div class="grid grid-cols-1 md:grid-cols-9 gap-3">
  <input id="f_member_id" class="input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">
  <input id="f_first_name" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
  <input id="f_last_name" class="input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <input id="f_group" class="input" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°">
  <input id="f_phone" class="input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
  <select id="f_gender" class="input"><option value="">‡πÄ‡∏û‡∏®</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option></select>
  <select id="f_status" class="input"><option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option><option>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option><option>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option></select>
  <input id="f_join_from" type="date" class="input" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡∏à‡∏≤‡∏Å)">
  <input id="f_join_to" type="date" class="input" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡∏ñ‡∏∂‡∏á)">
  <button class="btn gray" onclick="clearFilters()">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏á</button>
  <button class="btn green" onclick="exportExcel()">Export Excel</button>
  <button class="btn blue" onclick="printMemberReport()">Print</button>
  <button class="btn purple" onclick="printMemberLetter()">Print ‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>

</div>

<div class="text-center">‡∏û‡∏ö <b><span id="resultCount">0</span></b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
</div>

<!-- ===== TABLE ===== -->
<div class="box">
<table class="w-full text-sm text-center">
<thead class="bg-blue-100">
<tr>
  <th>‡∏£‡∏´‡∏±‡∏™</th>
  <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
  <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
  <th>‡πÇ‡∏ó‡∏£</th>
  <th>‡πÄ‡∏û‡∏®</th>
  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div class="flex justify-between mt-4">
  <button onclick="prevPage()" class="btn gray">‚óÄ</button>
  <span id="pageInfo"></span>
  <button onclick="nextPage()" class="btn gray">‚ñ∂</button>
</div>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const COOP_LOGO_URL = 'https://ttottijljxoinptmhgtu.supabase.co/storage/v1/object/public/slips/logo.png'
const db = createClient(SUPABASE_URL, SUPABASE_KEY)

const PAGE_SIZE = 15
let page = 1
let totalCount = 0
let debounceTimer = null
let editingMemberId = null

const form = document.getElementById('memberForm')
const rows = document.getElementById('rows')

const fMemberId = document.getElementById('f_member_id')
const fFirst = document.getElementById('f_first_name')
const fLast  = document.getElementById('f_last_name')
const fGroup = document.getElementById('f_group')
const fPhone = document.getElementById('f_phone')
const fGender= document.getElementById('f_gender')
const fStatus= document.getElementById('f_status')
const fJoinFrom = document.getElementById('f_join_from')
const fJoinTo   = document.getElementById('f_join_to')


function getCurrentFiscalYearThai(){
  const d=new Date()
  const y=d.getFullYear()
  const m=d.getMonth()+1
  return (m<4?y-1:y)+543
}

/* ===== SUBMIT (‡πÄ‡∏û‡∏¥‡πà‡∏° error handling ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ===== */
form.addEventListener('submit',async e=>{
  e.preventDefault()
  const data={}
  Array.from(form.elements).forEach(el=>{ if(el.id) data[el.id]=el.value||null })

  const { error } = await db.from('members').upsert([data],{onConflict:'member_id'})
  if(error){ alert(error.message); return }

  resetForm()
  loadMembers()
  loadSummary()
})

/* ===== AUTO FILTER ===== */
;[
  fMemberId,
  fFirst,
  fLast,
  fGroup,
  fPhone,
  fGender,
  fStatus,
  fJoinFrom,
  fJoinTo
].forEach(el=>{
  el.addEventListener('input',()=>{
    clearTimeout(debounceTimer)
    debounceTimer=setTimeout(()=>{ page=1; loadMembers() },300)
  })
})

window.resetForm = ()=>{
  form.reset()
  editingMemberId = null
  loadMembers()
}

window.clearFilters = ()=>{
  fMemberId.value=''
  fFirst.value=''
  fLast.value=''
  fGroup.value=''
  fPhone.value=''
  fGender.value=''
  fStatus.value=''
  fJoinFrom.value=''
  fJoinTo.value=''
  page=1
  loadMembers()
}



/* ===== SUMMARY ===== */
async function loadSummary(){
  document.getElementById('count-member').innerText =
    (await db.from('members')
      .select('member_id',{count:'exact',head:true})
      .eq('member_status','‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å')
    ).count || 0

  document.getElementById('count-associate').innerText =
    (await db.from('members')
      .select('member_id',{count:'exact',head:true})
      .eq('member_status','‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö')
    ).count || 0

  document.getElementById('count-resign').innerText =
    (await db.from('members')
      .select('member_id',{count:'exact',head:true})
      .eq('member_status','‡∏•‡∏≤‡∏≠‡∏≠‡∏Å')
    ).count || 0

  document.getElementById('count-dead').innerText =
    (await db.from('members')
      .select('member_id',{count:'exact',head:true})
      .eq('member_status','‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï')
    ).count || 0
}




/* ===== LOAD MEMBERS ===== */
async function loadMembers(){
  let q=db.from('members')
    .select('member_id,first_name,last_name,group,phone,gender,member_status',{count:'exact'})
    .order('member_id')

  if(fMemberId.value) q=q.eq('member_id',fMemberId.value)
  if(fFirst.value) q=q.ilike('first_name','%'+fFirst.value+'%')
  if(fLast.value) q=q.ilike('last_name','%'+fLast.value+'%')
  if(fGroup.value) q=q.ilike('group','%'+fGroup.value+'%')
  if(fPhone.value) q=q.ilike('phone','%'+fPhone.value+'%')
  if(fGender.value) q=q.eq('gender',fGender.value)
  if(fStatus.value) q=q.eq('member_status',fStatus.value)
  if(fJoinFrom.value) q = q.gte('join_date', fJoinFrom.value)
  if(fJoinTo.value)   q = q.lte('join_date', fJoinTo.value)


  const from=(page-1)*PAGE_SIZE
  const to=from+PAGE_SIZE-1
  const {data,count}=await q.range(from,to)

  totalCount=count||0
  document.getElementById('resultCount').innerText=totalCount
  document.getElementById('pageInfo').innerText=
    `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${Math.max(1,Math.ceil(totalCount/PAGE_SIZE))}`

  rows.innerHTML=''
  data.forEach(m=>{
    rows.innerHTML+=`
<tr class="border-b hover:bg-blue-50">
<td>${m.member_id}</td>
<td>${m.first_name||''} ${m.last_name||''}</td>
<td>${m.group||''}</td>
<td>${m.phone||''}</td>
<td>${m.gender||''}</td>
<td>${m.member_status||''}</td>
<td>
<button class="link" onclick="editMember(${m.member_id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
<button class="link text-red-600" onclick="deleteMember(${m.member_id})">‡∏•‡∏ö</button>
</td>
</tr>`
  })
}

/* ===== EDIT / DELETE ===== */
window.editMember = async id=>{
  if(!(await window.checkPassword())) return

  editingMemberId = id
  const {data}=await db.from('members')
    .select('*')
    .eq('member_id',id)
    .single()

  Array.from(form.elements).forEach(el=>{
    if(el.id) el.value = data[el.id] || ''
  })
}


window.deleteMember = async id=>{
  if(!(await window.checkPassword())) return

  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏£‡∏´‡∏±‡∏™ '+id)) return

  await db.from('members').delete().eq('member_id',id)
  editingMemberId = null
  loadMembers()
  loadSummary()
}


/* ===== PAGINATION ===== */
window.nextPage=()=>{ if(page*PAGE_SIZE<totalCount){page++;loadMembers()} }
window.prevPage=()=>{ if(page>1){page--;loadMembers()} }

/* ===== EXPORT EXCEL ===== */
window.exportExcel = async ()=>{
  let q=db.from('members').select('*').order('member_id')
  if(fMemberId.value) q=q.eq('member_id',fMemberId.value)
  if(fFirst.value) q=q.ilike('first_name','%'+fFirst.value+'%')
  if(fLast.value) q=q.ilike('last_name','%'+fLast.value+'%')
  if(fGroup.value) q=q.ilike('group','%'+fGroup.value+'%')
  if(fPhone.value) q=q.ilike('phone','%'+fPhone.value+'%')
  if(fGender.value) q=q.eq('gender',fGender.value)
  if(fStatus.value) q=q.eq('member_status',fStatus.value)

  const {data}=await q
  if(!data||!data.length){alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export');return}

  const ws=XLSX.utils.json_to_sheet(data)
  const wb=XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb,ws,'‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å')
  XLSX.writeFile(wb,'‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å.xlsx')
}

/* ===== PRINT ===== */
window.printMemberReport = async ()=>{
  const pageSize = 1000
  let from = 0
  let allData = []

  while (true) {
    let q = db
      .from('members')
      .select('*')
      .order('member_id')
      .range(from, from + pageSize - 1)

    if(fMemberId.value) q = q.eq('member_id', fMemberId.value)
    if(fFirst.value) q = q.ilike('first_name','%'+fFirst.value+'%')
    if(fLast.value) q = q.ilike('last_name','%'+fLast.value+'%')
    if(fGroup.value) q = q.ilike('group','%'+fGroup.value+'%')
    if(fPhone.value) q = q.ilike('phone','%'+fPhone.value+'%')
    if(fGender.value) q = q.eq('gender', fGender.value)
    if(fStatus.value) q = q.eq('member_status', fStatus.value)

    const { data, error } = await q
    if(error){ alert(error.message); return }

    if(!data || data.length === 0) break

    allData = allData.concat(data)

    if(data.length < pageSize) break
    from += pageSize
  }

  if(!allData.length){
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå')
    return
  }

  const today = new Date().toLocaleDateString('th-TH',{
    year:'numeric',month:'long',day:'numeric'
  })

  const rowsHtml = allData.map((r,i)=>`
<tr>
  <td>${i+1}</td>
  <td>${r.member_id}</td>
  <td>${r.title||''}${r.first_name||''} ${r.last_name||''}</td>
  <td style="text-align:left">
    ${r.house_no||''} ‡∏´‡∏°‡∏π‡πà ${r.moo||''}
    ${r.village||''} ${r.subdistrict||''}
    ${r.district||''} ${r.province||''}
  </td>
  <td>${r.phone||''}</td>
  <td></td>
</tr>
`).join('')

  const html = `
<html>
<head>
<meta charset="UTF-8">
<style>
@page{
  margin:20mm;
  @bottom-center{content:"‡∏´‡∏ô‡πâ‡∏≤ " counter(page) " / " counter(pages);}
}
body{font-family:"TH Sarabun New",sans-serif;font-size:16px}
.header-grid{
  display:grid;
  grid-template-columns:100px 1fr 100px;
  align-items:center
}
.logo{width:80px}
.title-box{text-align:center}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:13px
}
th,td{
  border:1px solid #000;
  padding:6px;
  text-align:center
}
th{background:#f0f0f0}
td:nth-child(4){text-align:left}
td:last-child{height:40px}
</style>
</head>

<body>
<div class="header-grid">
  <div><img src="${COOP_LOGO_URL}" class="logo"></div>
  <div class="title-box">
    <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
    ${fGroup.value ? `<div>‡∏Å‡∏•‡∏∏‡πà‡∏° ${fGroup.value}</div>` : ''}
    <div>‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today}</div>
    <div>‡∏£‡∏ß‡∏° ${allData.length} ‡∏£‡∏≤‡∏¢</div>
  </div>
  <div></div>
</div>

<table>
<thead>
<tr>
  <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
  <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
  <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
  <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
  <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
  <th>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</th>
</tr>
</thead>
<tbody>
${rowsHtml}
</tbody>
</table>
</body>
</html>
`

  const w = window.open('')
  w.document.write(html)
  w.document.close()
  w.print()
}

/* ===== PRINT LETTER (FILTER + >1000 + 1 ‡∏Ñ‡∏ô 1 ‡∏´‡∏ô‡πâ‡∏≤) ===== */
window.printMemberLetter = async ()=>{
  const pageSize = 1000
  let from = 0
  let allData = []

  while (true) {
    let q = db.from('members')
      .select('member_id,title,first_name,last_name,group,house_no,moo,village,subdistrict,district,province,phone')

    // ‚úÖ FILTER ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    if(fMemberId.value) q=q.eq('member_id',fMemberId.value)
    if(fFirst.value)    q=q.ilike('first_name','%'+fFirst.value+'%')
    if(fLast.value)     q=q.ilike('last_name','%'+fLast.value+'%')
    if(fGroup.value)    q=q.ilike('group','%'+fGroup.value+'%')
    if(fPhone.value)    q=q.ilike('phone','%'+fPhone.value+'%')
    if(fGender.value)   q=q.eq('gender',fGender.value)
    if(fStatus.value)   q=q.eq('member_status',fStatus.value)

    // ‚úÖ order + range ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡πâ‡∏≤‡∏¢
    q = q.order('member_id')
         .range(from, from + pageSize - 1)

    const { data, error } = await q
    if(error){ alert(error.message); return }

    if(!data || data.length === 0) break

    allData = allData.concat(data)
    if(data.length < pageSize) break

    from += pageSize
  }

  if(!allData.length){
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå')
    return
  }

  const html = `
<html>
<head>
<meta charset="UTF-8">
<style>
@page{ size:A4; margin:20mm; }
body{
  font-family:"TH Sarabun New",sans-serif;
  font-size:20px;
  line-height:1.6;
}
.letter{ page-break-after:always; }
.header{
  font-size:26px;
  font-weight:bold;
  text-align:center;
  margin-bottom:28px;
}
.row{ margin-bottom:18px; }
.label{ font-weight:bold; }
</style>
</head>

<body>
${allData.map(r=>`
  <div class="letter">
    <div class="header">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</div>

    <div class="row"><span class="label">‡∏Å‡∏•‡∏∏‡πà‡∏° :</span> ${r.group||''}</div>
    <div class="row"><span class="label">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å :</span> ${r.member_id}</div>
    <div class="row"><span class="label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• :</span>
      ${r.title||''}${r.first_name||''} ${r.last_name||''}
    </div>
    <div class="row"><span class="label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà :</span>
      ${r.house_no||''} ‡∏´‡∏°‡∏π‡πà ${r.moo||''} ${r.village||''}
      ${r.subdistrict||''} ${r.district||''} ${r.province||''}
    </div>
    <div class="row"><span class="label">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå :</span> ${r.phone||''}</div>
  </div>
`).join('')}
</body>
</html>
`

  const w = window.open('')
  w.document.write(html)
  w.document.close()
  w.print()
}
 
  

loadMembers()
loadSummary()


  // üîê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö
window.checkPassword = async function () {
  const { value, isConfirmed } = await Swal.fire({
    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
    input: 'password',
    inputPlaceholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
    showCancelButton: true,
    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
  })

  if (!isConfirmed) return false

  if (value !== '159357') {
    await Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '', 'error')
    return false
  }

  return true
}

</script>

<style>
.box{background:#fff;border:2px solid #93c5fd;border-radius:12px;padding:16px}
.field{display:flex;align-items:center;gap:6px}
.field label{width:120px}
.field input,.field select,.input{flex:1;border:2px solid #94a3b8;border-radius:6px;padding:6px}
.summary{background:#fff;border:2px solid;border-radius:12px;padding:12px;text-align:center}
.summary .num{font-size:28px;font-weight:700}
.green{border-color:#22c55e;color:#15803d}
.orange{border-color:#f97316;color:#c2410c}
.red{border-color:#ef4444;color:#b91c1c}
.purple{border-color:#8b5cf6;color:#6d28d9}
.btn{padding:6px 16px;border-radius:8px}
.btn.blue{background:#2563eb;color:#fff}
.btn.gray{background:#e5e7eb}
.btn.green{background:#16a34a;color:#fff}
.btn.purple{background:#7c3aed;color:#fff;}

.link{color:#2563eb;cursor:pointer}
</style>

</body>
</html>
