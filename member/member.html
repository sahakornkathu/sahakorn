<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<style>
/* ------------------------------
   Global / Responsive tweaks
   (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CSS ‚Äî ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ JS)
   ------------------------------*/
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
* { box-sizing: border-box; }
body { font-family:"Prompt",sans-serif; background:#f0f4f8; margin:20px; color:#333; line-height:1.45; }
h2 { text-align:center; color:#1e40af; margin-bottom:12px; }

/* Form & steps */
form { max-width:950px; margin:auto; }
.form-step { display:none; background:#fff; padding:20px 25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.06); margin-bottom:20px; }
.form-step.active { display:block; }
input, select, textarea { display:block; width:48%; margin:6px 1% 12px 1%; padding:9px 10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; background:#fbfdff; transition:all .14s ease-in-out; }
input:focus, select:focus, textarea:focus { outline:none; border-color:#4a90e2; box-shadow:0 4px 14px rgba(74,144,226,0.12); background:#fff; }
label{ font-size:13px; color:#334155; display:inline-block; margin-bottom:6px; }
small{ font-size:12px; color:#64748b; display:block; margin-top:-6px; margin-bottom:8px; }

/* Buttons */
.form-navigation { text-align:center; margin-top:8px; }
button { cursor:pointer; }
.form-navigation button, .pagination button, #filterDiv button { padding:8px 14px; border:none; border-radius:8px; background:#2563eb; color:#fff; font-weight:600; transition:all .12s ease; }
.form-navigation button:hover, .pagination button:hover, #filterDiv button:hover { transform:translateY(-2px); background:#1e40af; }
button.secondary { background:#f1f5f9; color:#1e3a8a; border:1px solid #d1d5db; }
button.danger { background:#ef4444; color:#fff; }

/* Table */
table { border-collapse:collapse; width:100%; max-width:1000px; margin:20px auto; font-size:13px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
th, td { border:1px solid #e6eef6; padding:8px 10px; text-align:center; white-space:nowrap; }
th { background:linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; font-weight:600; position:relative; }
tr:nth-child(even){ background:#fbfdff; }
tr:hover{ background:#f1f5f9; }

/* Progress */
.progress-container { display:flex; gap:8px; justify-content:space-between; align-items:center; max-width:950px; margin:0 auto 18px auto; position:relative; }
.progress-container::before { content:""; position:absolute; top:50%; left:0; right:0; height:4px; background:#e6eef6; transform:translateY(-50%); z-index:0; border-radius:6px; }
.progress-step { position:relative; z-index:1; background:#fff; color:#334155; border:2px solid #dbeafe; border-radius:999px; padding:8px 14px; font-weight:600; text-align:center; flex:1; }
.progress-step.active { background:#2563eb; color:#fff; border-color:#2563eb; box-shadow:0 6px 18px rgba(37,99,235,0.16); }

/* ---------------------------
   Filter / Search area (‡πÉ‡∏´‡∏°‡πà)
   ---------------------------*/
#filterDiv {
  background: #ffffff;
  border-radius: 12px;
  padding: 16px 18px;
  max-width: 950px;
  margin: 20px auto 8px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.06);
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
}

/* Grid inside filter area */
#filterDiv .filters-left {
  display:flex;
  gap:10px;
  align-items:center;
  flex:1 1 auto;
  flex-wrap:wrap;
}
#filterDiv input, #filterDiv select { flex: 1 1 180px; min-width:140px; }

/* Buttons group */
#filterDiv .buttons-group { display:flex; gap:8px; align-items:center; }
#filterDiv .buttons-group button { padding:10px 14px; border-radius:8px; font-size:14px; }

/* result count */
#resultCount { font-size:14px; font-weight:600; color:#1f2937; margin-left:8px; }

/* Summary cards */
.summary-container { max-width:950px; margin: 14px auto; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
.summary-card { background:#fff; padding:12px 14px; border-radius:10px; min-width:140px; box-shadow:0 6px 14px rgba(2,6,23,0.04); text-align:center; }
.summary-card h4 { margin:0; font-size:13px; color:#475569; }
.summary-card p { margin:6px 0 0 0; font-size:20px; font-weight:700; color:#0f172a; }

/* Pagination */
.pagination { display:flex; gap:8px; justify-content:center; align-items:center; margin:12px auto; }

/* Small screens */
@media (max-width: 900px){
  input, select { width:100% !important; margin:6px 0 12px 0; }
  .progress-container{ flex-direction:column; align-items:flex-start; gap:8px; }
  .progress-container::before{ display:none; }
  .progress-step{ width:100%; text-align:left; border-radius:10px; }
  #filterDiv{ padding:12px; gap:8px; align-items:stretch; }
  #filterDiv .filters-left{ flex-direction:column; }
  #filterDiv .buttons-group{ width:100%; flex-direction:column; }
  .summary-container{ flex-direction:column; align-items:stretch; }
  table { font-size:13px; }
}
</style>
</head>
<body>

<h2>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

<div class="progress-container">
  <div class="progress-step active" data-step="1">‚ë† ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
  <div class="progress-step" data-step="2">‚ë° ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
  <div class="progress-step" data-step="3">‚ë¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
</div>

<form id="memberForm">
  <div class="form-step active">
    <h3>Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" name="member_id" required="">
    <small>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</small>
    <input type="date" name="join_date" required="">
    <input placeholder="‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" name="title" required="">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠" name="first_name" required="">
    <input placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" name="last_name" required="">
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (x-xxxx-xxxxx-xx-x)" name="id_card" required="" maxlength="17">
    <small>üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</small>
    <input type="date" name="birthday" id="birthday" required="">
    <input placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" name="age" id="age" readonly="">
    <select name="gender" required="">
      <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®--</option>
      <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
    </select>
    <select name="group" required="">
      <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°--</option>
      <option value="1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1</option>
      <option value="2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2</option>
      <option value="3">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3</option>
      <option value="4">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 4</option>
      <option value="5">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 5</option>
      <option value="6">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 6</option>
      <option value="7">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 7</option>
      <option value="8">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 8</option>
      <option value="9">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 9</option>
    </select>
  </div>

  <div class="form-step">
    <h3>Step 2: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h3>
    <input placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" name="house_no" required="">
    <input placeholder="‡∏´‡∏°‡∏π‡πà" name="moo">
    <input placeholder="‡∏ñ‡∏ô‡∏ô" name="street" required="">
    <input placeholder="‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" name="village">
    <input placeholder="‡∏ï‡∏≥‡∏ö‡∏•" name="subdistrict" required="">
    <input placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" name="district" required="">
    <input placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" name="province" required="">
    <input placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" name="postal_code" required="">
    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" name="phone">
    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á" name="phone_alt">
  </div>

  <div class="form-step">
    <h3>Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
    <select name="member_status" required="">
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
      <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>
    <select name="marital_status" required="">
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏£‡∏™--</option>
      <option value="‡πÇ‡∏™‡∏î">‡πÇ‡∏™‡∏î</option>
      <option value="‡∏™‡∏°‡∏£‡∏™">‡∏™‡∏°‡∏£‡∏™</option>
      <option value="‡∏´‡∏°‡πâ‡∏≤‡∏¢">‡∏´‡∏°‡πâ‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏¢‡πà‡∏≤">‡∏´‡∏¢‡πà‡∏≤</option>
    </select>
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" name="spouse_name">
    <label style="display:block;margin:8px 0;"><input type="checkbox" name="kyot_member"> ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó</label>
    <input placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Å‡∏¢‡∏ó" name="kyot_member_id">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏î‡∏≤" name="father_name">
    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤" name="mother_name">
  </div>

  <div class="form-navigation">
    <button type="button" id="prevBtn" style="display: none;">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <button type="button" id="nextBtn" style="display: inline-block;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    <button type="submit" id="submitBtn" style="display:none;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>
</form>

<!-- Summary cards ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• allMembers) -->
<div class="summary-container" aria-hidden="false">
  <div class="summary-card"><h4>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4><p id="sumTotal">0</p></div>
  <div class="summary-card"><h4>‡∏ä‡∏≤‡∏¢</h4><p id="sumMale">0</p></div>
  <div class="summary-card"><h4>‡∏´‡∏ç‡∏¥‡∏á</h4><p id="sumFemale">0</p></div>
  <div class="summary-card"><h4>‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</h4><p id="sumExit">0</p></div>
  <div class="summary-card"><h4>‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h4><p id="sumDeath">0</p></div>
</div>

<h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<div id="filterDiv">
  <div class="filters-left">
    <input id="searchMemberId" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">
    <input id="searchName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
    <input id="searchGroup" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°">
    <input id="searchProvince" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
  </div>

  <div class="buttons-group" role="group" aria-label="filter-buttons">
    <div class="date-filter" style="display:flex; gap:8px; align-items:center;">
      <label style="font-size:13px;color:#334155;margin-right:6px;">‡∏à‡∏≤‡∏Å</label>
      <input type="date" id="searchJoinDateStart">
      <label style="font-size:13px;color:#334155;margin-left:6px;">‡∏ñ‡∏∂‡∏á</label>
      <input type="date" id="searchJoinDateEnd">
    </div>

    <select id="searchStatus" style="min-width:150px;">
      <option value="">--‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å--</option>
      <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
      <option value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    </select>

    <select id="searchGender" style="min-width:150px;">
      <option value="">--‡πÄ‡∏û‡∏®--</option>
      <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
    </select>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="printReport">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      <button id="clearFilter" class="secondary">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </div>

  <div id="resultCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
</div>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
<table id="memberTable">
  <thead>
    <tr>
      <th data-column="member_id">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="sort-icon"></span></th>
      <th data-column="first_name">‡∏ä‡∏∑‡πà‡∏≠ <span class="sort-icon"></span></th>
      <th data-column="last_name">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="sort-icon"></span></th>
      <th data-column="group">‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="sort-icon"></span></th>
      <th data-column="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="sort-icon"></span></th>
      <th data-column="member_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span class="sort-icon"></span></th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody>
    <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
  </tbody>
</table>

<div class="pagination">
  <button id="prevPage">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <span id="pageInfo">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
  <button id="nextPage">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>

<script>
/* -------------------------
   JavaScript - ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
   (‡∏Ñ‡∏∑‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
   -------------------------*/

/* ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å (‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) */
const API_URL='https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members';
const form=document.getElementById('memberForm');
const tableBody=document.querySelector('#memberTable tbody');
let editId=null;
let allMembers=[];
let sortColumn=null, sortAsc=true;
let currentPage=1, rowsPerPage=10;

/* Multi-step */
const formSteps=document.querySelectorAll('.form-step');
const progressSteps=document.querySelectorAll('.progress-step');
let formStepIndex=0;
showStep(formStepIndex);
document.getElementById('nextBtn').addEventListener('click',()=>{ if(!validateStep(formStepIndex)) return; formStepIndex++; showStep(formStepIndex); });
document.getElementById('prevBtn').addEventListener('click',()=>{ formStepIndex--; showStep(formStepIndex); });

function showStep(n){
  formSteps.forEach((step,i)=>step.classList.remove('active'));
  formSteps[n].classList.add('active');
  progressSteps.forEach((p,i)=>p.classList.toggle('active',i<=n));
  document.getElementById('prevBtn').style.display=n===0?'none':'inline-block';
  document.getElementById('nextBtn').style.display=n===formSteps.length-1?'none':'inline-block';
  document.getElementById('submitBtn').style.display=n===formSteps.length-1?'inline-block':'none';
}

function validateStep(n){
  const inputs=formSteps[n].querySelectorAll('input,select');
  for(let inp of inputs){
    if(inp.hasAttribute('required') && !inp.value){
      const label = inp.placeholder || inp.name || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô';
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + label);
      inp.focus();
      return false;
    }
  }
  return true;
}

/* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏ */
document.getElementById('birthday').addEventListener('change', function(){
  if(!this.value){ document.getElementById('age').value=''; return; }
  const birthDate = new Date(this.value);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
  document.getElementById('age').value = age >= 0 ? age : '';
});

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô --- */
const idCardInput = document.querySelector('input[name="id_card"]');
if(idCardInput){
  idCardInput.addEventListener('input', function (e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 13) value = value.slice(0, 13);
    let formatted = '';
    if (value.length > 0) formatted += value.substring(0, 1);
    if (value.length > 1) formatted += '-' + value.substring(1, 5);
    if (value.length > 5) formatted += '-' + value.substring(5, 10);
    if (value.length > 10) formatted += '-' + value.substring(10, 12);
    if (value.length > 12) formatted += '-' + value.substring(12, 13);
    e.target.value = formatted;
  });
}

/* --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô --- */
function isValidThaiID(id) {
  const num = id.replace(/\D/g, '');
  if (num.length !== 13) return false;
  let sum = 0;
  for (let i = 0; i < 12; i++) sum += parseInt(num.charAt(i)) * (13 - i);
  const check = (11 - (sum % 11)) % 10;
  return check === parseInt(num.charAt(12));
}

/* --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å --- */
async function loadMembers(){
  try{
    const res=await fetch(API_URL);
    const result=await res.json();
    if(result.error){ alert(result.error); return; }
    allMembers = Array.isArray(result) ? result : (result.data || []);
    renderTable();
    updateSummary(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ñ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
  }catch(err){ alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+err); }
}

/* --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Dashboard --- */
function updateSummary(){
  document.getElementById('sumTotal').textContent = allMembers.length;
  document.getElementById('sumMale').textContent = allMembers.filter(m => m.gender === '‡∏ä‡∏≤‡∏¢').length;
  document.getElementById('sumFemale').textContent = allMembers.filter(m => m.gender === '‡∏´‡∏ç‡∏¥‡∏á').length;
  document.getElementById('sumExit').textContent = allMembers.filter(m => m.member_status === '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å').length;
  document.getElementById('sumDeath').textContent = allMembers.filter(m => m.member_status === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï').length;
}

/* --- ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå + Pagination --- */
function renderTable(){
  let rows = allMembers.slice();

  const startDate = document.getElementById('searchJoinDateStart').value ? new Date(document.getElementById('searchJoinDateStart').value) : null;
  const endDate = document.getElementById('searchJoinDateEnd').value ? new Date(document.getElementById('searchJoinDateEnd').value) : null;
  const memberId=document.getElementById('searchMemberId').value.trim();
  const name=document.getElementById('searchName').value.trim().toLowerCase();
  const group=document.getElementById('searchGroup').value.trim();
  const province=document.getElementById('searchProvince').value.trim().toLowerCase();
  const status=document.getElementById('searchStatus').value;
  const gender=document.getElementById('searchGender').value;

  rows=rows.filter(m=>{
    if(memberId && !(m.member_id || '').includes(memberId)) return false;
    if(name && !(((m.first_name||'') + (m.last_name||'')).toLowerCase().includes(name))) return false;
    if(group && (m.group || '').toString() != group) return false;
    if(province && !((m.province||'').toLowerCase().includes(province))) return false;
    if(status && (m.member_status || '') != status) return false;
    if(gender && (m.gender || '') != gender) return false;
    if(startDate && new Date(m.join_date) < startDate) return false;
    if(endDate && new Date(m.join_date) > endDate) return false;
    return true;
  });

  if(sortColumn) rows.sort((a,b)=>{
    const aa = (a[sortColumn] || '').toString().toLowerCase();
    const bb = (b[sortColumn] || '').toString().toLowerCase();
    if(aa===bb) return 0;
    return sortAsc ? (aa>bb?1:-1) : (aa<bb?1:-1);
  });

  const start=(currentPage-1)*rowsPerPage;
  const end=start+rowsPerPage;
  const pageRows=rows.slice(start,end);

  tableBody.innerHTML='';
  pageRows.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.member_id||''}</td><td>${m.first_name||''}</td><td>${m.last_name||''}</td><td>${m.group||''}</td><td>${m.province||''}</td><td>${m.member_status||''}</td>
    <td><button class="edit" onclick="editMember('${m.member_id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
    <td><button class="delete" onclick="deleteMember('${m.member_id}')">‡∏•‡∏ö</button></td>`;
    tableBody.appendChild(tr);
  });

  document.getElementById('pageInfo').textContent=`‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}`;
  document.getElementById('resultCount').textContent=`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

/* --- Sorting --- */
document.querySelectorAll('#memberTable th[data-column]').forEach(th=>{
  th.addEventListener('click',()=>{
    const col=th.getAttribute('data-column');
    if(sortColumn===col) sortAsc=!sortAsc; else { sortColumn=col; sortAsc=true; }
    renderTable();
  });
});

/* --- Pagination --- */
document.getElementById('prevPage').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderTable(); } });
document.getElementById('nextPage').addEventListener('click',()=>{ currentPage++; renderTable(); });

/* --- Filters Event --- */
['searchMemberId','searchName','searchGroup','searchProvince','searchStatus','searchGender','searchJoinDateStart','searchJoinDateEnd']
.forEach(id=>document.getElementById(id).addEventListener('input',()=>{ currentPage=1; renderTable(); }));

/* --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡πâ‡∏≥ --- */
function isDuplicateIDCard(id){
  const raw = id.replace(/\D/g, '');
  return allMembers.some(m => (m.id_card && m.id_card.replace(/\D/g,'') === raw));
}

/* --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --- */
form.addEventListener('submit', async(e)=>{
  e.preventDefault();
  const data=Object.fromEntries(new FormData(form));

  const idCardRaw = data.id_card ? data.id_card.replace(/\D/g, '') : '';

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if(idCardRaw && !isValidThaiID(idCardRaw)){
    alert('‚ùå ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    form.elements['id_card'].focus();
    return;
  }

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡πâ‡∏≥ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
  if(idCardRaw && !editId && isDuplicateIDCard(idCardRaw)){
    alert('‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
    form.elements['id_card'].focus();
    return;
  }

  if(idCardRaw) data.id_card = idCardRaw;
  if(editId) data.member_id=editId;

  try{
    const res=await fetch(API_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
    const result=await res.json();
    if(result && result.error){ alert(result.error); return; }
    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    form.reset(); editId=null; formStepIndex=0; showStep(0); await loadMembers();
  }catch(err){ alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+err); }
});

/* --- Edit / Delete --- */
window.editMember=(id)=>{ const m=allMembers.find(x=>x.member_id===id); if(!m) return; editId=id; for(let k in m){ if(form.elements[k]) form.elements[k].value=m[k]; } formStepIndex=0; showStep(0); }
window.deleteMember=async(id)=>{ if(!confirm('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return; try{ await fetch(API_URL+'/'+id,{method:'DELETE'}); allMembers=allMembers.filter(m=>m.member_id!==id); renderTable(); updateSummary(); }catch(err){ alert(err); } }

/* --- Clear Filter --- */
document.getElementById('clearFilter').addEventListener('click',()=>{
  ['searchMemberId','searchName','searchGroup','searchProvince','searchStatus','searchGender','searchJoinDateStart','searchJoinDateEnd']
  .forEach(id=>document.getElementById(id).value='');
  currentPage=1; renderTable();
});

/* --- Print --- */
document.getElementById('printReport').addEventListener('click', () => {
  const groupFilter = document.getElementById('searchGroup').value.toLowerCase();
  const statusFilter = document.getElementById('searchStatus').value;
  const genderFilter = document.getElementById('searchGender').value;
  const joinDateStart=document.getElementById('searchJoinDateStart').value;
  const joinDateEnd=document.getElementById('searchJoinDateEnd').value;

  const filtered = allMembers.filter(m => {
    const joinDate = m.join_date ? (m.join_date.split('T')[0] || m.join_date) : '';
    return (!groupFilter || (m.group && m.group.toLowerCase() === groupFilter)) &&
           (!statusFilter || m.member_status === statusFilter) &&
           (!genderFilter || m.gender === genderFilter) &&
           (!joinDateStart || joinDate >= joinDateStart) &&
           (!joinDateEnd || joinDate <= joinDateEnd);
  });

  const groupLabel = groupFilter ? `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${groupFilter}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
  let printContent = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div style="flex:0 0 auto;"><img src="https://lh5.googleusercontent.com/d/1B0sZdUz54kO4zAv0oJgoN4Aipy3UyCyR=w100-h100" alt="Logo" style="max-width:100px;height:auto;"></div>
      <div style="flex:1;text-align:center;">
        <h2 style="margin:0;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${groupLabel}</h2>
        <div style="font-size:14px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${statusFilter || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'} | ‡πÄ‡∏û‡∏®: ${genderFilter || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</div>
        <div style="font-size:13px;">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${joinDateStart || '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô'} - ${joinDateEnd || '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'}</div>
      </div>
      <div style="flex:0 0 100px;"></div>
    </div>
    <table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse; font-family:'Prompt',sans-serif; font-size:13px;">
      <tr style="background-color:#4a90e2; color:white;">
        <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
        <th>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
        <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
      </tr>`;
  filtered.forEach(m => {
    const fullName = `${m.title||''} ${m.first_name||''} ${m.last_name||''}`.trim();
    const joinDate = m.join_date ? (m.join_date.split('T')[0] || m.join_date) : '';
    const fullAddress = `${m.house_no||''} ${m.moo||''} ${m.street||''} ${m.village||''} ${m.subdistrict||''} ${m.district||''} ${m.province||''} ${m.postal_code||''}`.replace(/\s+/g,' ').trim();
    const phone = m.phone || '';
    printContent += `<tr><td>${m.member_id}</td><td>${fullName}</td><td>${joinDate}</td><td>${fullAddress}</td><td>${phone}</td></tr>`;
  });
  printContent += '</table>';
  const w = window.open('', '', 'width=900,height=600');
  w.document.write('<html><head><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>');
  w.document.write('<style>body{font-family:"Prompt",sans-serif; margin:20px;} h2{text-align:center;}</style></head><body>');
  w.document.write(printContent);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
});

/* ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
loadMembers();
</script>

</body>
</html>
