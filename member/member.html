<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบจัดการข้อมูลสมาชิก</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-blue-50 p-6 text-slate-800">
<div class="max-w-7xl mx-auto space-y-6">

<!-- ================= FILTER ================= -->
<div class="box space-y-3">
  <h2 class="title">ค้นหารายชื่อสมาชิก</h2>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
    <input id="searchText" class="input" placeholder="ค้นหา ชื่อ / นามสกุล / กลุ่ม / เบอร์โทร">
    
    <select id="searchGender" class="input">
      <option value="">เพศทั้งหมด</option>
      <option value="ชาย">ชาย</option>
      <option value="หญิง">หญิง</option>
    </select>

    <button onclick="searchMembers()" class="btn blue">ค้นหา</button>
    <button onclick="resetSearch()" class="btn gray">ล้างการค้นหา</button>
  </div>

  <div class="text-sm text-slate-600">
    ผลการค้นหา: <b><span id="resultCount">0</span></b> รายการ
  </div>
</div>

<!-- ================= TABLE ================= -->
<div class="box">
<h2 class="title">รายชื่อสมาชิก</h2>

<table class="w-full text-sm">
<thead>
<tr>
  <th>รหัส</th>
  <th>ชื่อ-นามสกุล</th>
  <th>กลุ่ม</th>
  <th>โทร</th>
  <th>เพศ</th>
  <th>สถานะ</th>
  <th>จัดการ</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div class="flex justify-between mt-4">
  <button onclick="prevPage()" class="btn gray">◀ ก่อนหน้า</button>
  <span id="pageInfo"></span>
  <button onclick="nextPage()" class="btn gray">ถัดไป ▶</button>
</div>
</div>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
const db = createClient(SUPABASE_URL, SUPABASE_KEY)

const PAGE_SIZE = 15
let page = 1
let lastCount = 0

const rows = document.getElementById('rows')
const searchTextEl = document.getElementById('searchText')
const searchGenderEl = document.getElementById('searchGender')

/* ===== SEARCH ===== */
window.searchMembers = function () {
  page = 1
  loadMembers()
}

window.resetSearch = function () {
  searchTextEl.value = ''
  searchGenderEl.value = ''
  page = 1
  loadMembers()
}

/* ===== LOAD MEMBERS + FILTER ===== */
async function loadMembers() {
  const keyword = searchTextEl.value.trim()
  const gender = searchGenderEl.value

  let query = db.from('members')
    .select(
      'member_id, first_name, last_name, group, phone, gender, member_status',
      { count: 'exact' }
    )
    .order('member_id')

  if (keyword) {
    query = query.or(
      `first_name.ilike.%${keyword}%,last_name.ilike.%${keyword}%,group.ilike.%${keyword}%,phone.ilike.%${keyword}%`
    )
  }

  if (gender) {
    query = query.eq('gender', gender)
  }

  const from = (page - 1) * PAGE_SIZE
  const to = from + PAGE_SIZE - 1

  const { data, count } = await query.range(from, to)

  lastCount = count || 0
  document.getElementById('resultCount').innerText = lastCount

  rows.innerHTML = ''

  data.forEach(function (m) {
    const color =
      m.member_status === 'สมาชิก' ? 'green' :
      m.member_status === 'ลาออก' ? 'orange' : 'red'

    rows.innerHTML += `
    <tr>
      <td>${m.member_id}</td>
      <td>${m.first_name || ''} ${m.last_name || ''}</td>
      <td>${m.group || ''}</td>
      <td>${m.phone || ''}</td>
      <td>${m.gender || ''}</td>
      <td class="${color}">${m.member_status || ''}</td>
      <td>
        <button class="link" onclick="editMember(${m.member_id})">แก้ไข</button>
      </td>
    </tr>`
  })

  const totalPage = Math.max(1, Math.ceil(lastCount / PAGE_SIZE))
  document.getElementById('pageInfo').innerText =
    `หน้า ${page} / ${totalPage}`
}

/* ===== PAGINATION ===== */
window.nextPage = function () {
  if (page * PAGE_SIZE < lastCount) {
    page++
    loadMembers()
  }
}

window.prevPage = function () {
  if (page > 1) {
    page--
    loadMembers()
  }
}

/* ===== INIT ===== */
loadMembers()
</script>

<style>
.box{background:#fff;border:2px solid #93c5fd;border-radius:12px;padding:16px}
.title{font-weight:600;margin-bottom:8px}
.input{border:2px solid #94a3b8;border-radius:6px;padding:6px;width:100%}
.btn{padding:6px 16px;border-radius:8px}
.btn.blue{background:#2563eb;color:#fff}
.btn.gray{background:#e5e7eb}
.green{color:#15803d;font-weight:600}
.orange{color:#c2410c;font-weight:600}
.red{color:#b91c1c;font-weight:600}
.link{color:#2563eb;cursor:pointer}
</style>

</body>
</html>
