<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบจัดการข้อมูลสมาชิก</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-blue-50 p-6 text-slate-800">

<div class="max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <div class="bg-blue-100 border-2 border-blue-300 rounded-xl p-6">
    <h1 class="text-2xl font-semibold">ระบบจัดการข้อมูลสมาชิก</h1>
    <p class="text-sm text-slate-600">ฟอร์มข้อมูลสมาชิก</p>
  </div>

  <!-- ================= FORM ================= -->
  <form id="memberForm" class="space-y-6">

    <!-- ================= ข้อมูลสมาชิก ================= -->
    <div class="section">
      <h2 class="section-title">ข้อมูลสมาชิก</h2>

      <div class="field">
        <label class="field-label">รหัสสมาชิก</label>
        <input id="member_id" type="number" class="field-input" required>
      </div>

      <div class="field">
        <label class="field-label">วันที่สมัคร</label>
        <input id="join_date" type="date" class="field-input">
      </div>

      <div class="field">
        <label class="field-label">คำนำหน้า</label>
        <input id="title" class="field-input">
      </div>

      <div class="field">
        <label class="field-label">ชื่อ</label>
        <input id="first_name" class="field-input" required>
      </div>

      <div class="field">
        <label class="field-label">นามสกุล</label>
        <input id="last_name" class="field-input" required>
      </div>

      <div class="field">
        <label class="field-label">เลขบัตรประชาชน</label>
        <input id="id_card" class="field-input">
      </div>

      <div class="field">
        <label class="field-label">วันเกิด</label>
        <input id="birthday" type="date" class="field-input">
      </div>

      <div class="field">
        <label class="field-label">กลุ่ม</label>
        <input id="group" class="field-input">
      </div>
    </div>

    <!-- ================= ข้อมูลติดต่อ ================= -->
    <div class="section">
      <h2 class="section-title">ข้อมูลติดต่อ</h2>

      <div class="field">
        <label class="field-label">โทรศัพท์</label>
        <input id="phone" class="field-input">
      </div>

      <div class="field">
        <label class="field-label">โทรศัพท์สำรอง</label>
        <input id="phone_alt" class="field-input">
      </div>
    </div>

    <!-- ================= สถานะ ================= -->
    <div class="section">
      <h2 class="section-title">สถานะ</h2>

      <div class="field">
        <label class="field-label">สถานะสมาชิก</label>
        <select id="member_status" class="field-input">
          <option value="">-- เลือก --</option>
          <option value="active">ปกติ</option>
          <option value="inactive">พ้นสภาพ</option>
        </select>
      </div>

      <div class="field">
        <label class="field-label">สถานภาพสมรส</label>
        <select id="marital_status" class="field-input">
          <option value="">-- เลือก --</option>
          <option value="single">โสด</option>
          <option value="married">สมรส</option>
        </select>
      </div>

      <div class="field">
        <label class="field-label">ชื่อคู่สมรส</label>
        <input id="spouse_name" class="field-input">
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-4">
      <button type="submit" class="btn-primary">บันทึกข้อมูล</button>
      <button type="button" onclick="resetForm()" class="btn-secondary">ยกเลิก</button>
    </div>

  </form>

  <!-- ================= TABLE ================= -->
  <div class="bg-white border-2 border-blue-300 rounded-xl p-6">
    <h2 class="section-title mb-4">รายชื่อสมาชิก</h2>

    <table class="w-full text-sm">
      <thead class="bg-blue-100">
        <tr>
          <th class="th">รหัส</th>
          <th class="th">ชื่อ-สกุล</th>
          <th class="th">โทร</th>
          <th class="th">สถานะ</th>
          <th class="th text-center">จัดการ</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4">
      <button onclick="prevPage()" class="btn-page">◀ ก่อนหน้า</button>
      <span id="pageInfo" class="text-sm text-slate-600"></span>
      <button onclick="nextPage()" class="btn-page">ถัดไป ▶</button>
    </div>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const db = createClient(
  'https://ttottijljxoinptmhgtu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

const PAGE_SIZE = 15
let currentPage = 1
let totalCount = 0

const form = document.getElementById('memberForm')
const rows = document.getElementById('rows')

async function loadTotalCount() {
  const { count } = await db
    .from('members')
    .select('member_id', { count: 'exact', head: true })
  totalCount = count || 0
}

async function loadMembers() {
  const from = (currentPage - 1) * PAGE_SIZE
  const to = from + PAGE_SIZE - 1

  rows.innerHTML = `
    <tr>
      <td colspan="5" class="td text-center text-slate-500">
        ⏳ กำลังโหลดข้อมูล...
      </td>
    </tr>
  `

  const { data } = await db
    .from('members')
    .select('member_id, first_name, last_name, phone, member_status')
    .order('member_id')
    .range(from, to)

  rows.innerHTML = ''
  data.forEach(m => {
    rows.innerHTML += `
      <tr class="hover:bg-blue-50">
        <td class="td">${m.member_id}</td>
        <td class="td">${m.first_name} ${m.last_name}</td>
        <td class="td">${m.phone ?? ''}</td>
        <td class="td">${m.member_status ?? ''}</td>
        <td class="td text-center">
          <button onclick="editMember(${m.member_id})"
            class="text-blue-700 hover:underline">แก้ไข</button>
          <button onclick="deleteMember(${m.member_id})"
            class="text-red-600 hover:underline ml-3">ลบ</button>
        </td>
      </tr>`
  })

  updatePageInfo()
}

function updatePageInfo() {
  const totalPage = Math.ceil(totalCount / PAGE_SIZE) || 1
  document.getElementById('pageInfo').innerText =
    `หน้า ${currentPage} / ${totalPage}`
}

window.nextPage = () => {
  if (currentPage * PAGE_SIZE < totalCount) {
    currentPage++
    loadMembers()
  }
}

window.prevPage = () => {
  if (currentPage > 1) {
    currentPage--
    loadMembers()
  }
}

form.addEventListener('submit', async e => {
  e.preventDefault()
  const data = Object.fromEntries(
    [...form.elements].filter(el => el.id).map(el => [el.id, el.value || null])
  )
  await db.from('members').upsert([data], { onConflict: 'member_id' })
  resetForm()
  await loadTotalCount()
  loadMembers()
})

window.editMember = async id => {
  const { data } = await db
    .from('members')
    .select('*')
    .eq('member_id', id)
    .single()

  member_id.value = data.member_id
  member_id.disabled = true

  for (const k in data) {
    if (document.getElementById(k)) {
      document.getElementById(k).value = data[k] ?? ''
    }
  }
}

window.deleteMember = async id => {
  if (!confirm('ยืนยันลบข้อมูลนี้?')) return
  await db.from('members').delete().eq('member_id', id)
  await loadTotalCount()
  loadMembers()
}

window.resetForm = () => {
  form.reset()
  member_id.disabled = false
}

await loadTotalCount()
loadMembers()
</script>

<style>
.section {
  @apply bg-white border-2 border-blue-300 rounded-xl p-6;
}
.section-title {
  @apply text-lg font-semibold mb-4;
}
.field {
  @apply grid grid-cols-12 gap-3 items-center mb-4;
}
.field-label {
  @apply col-span-4 md:col-span-3 text-right pr-2 text-slate-700 font-medium;
}
.field-input {
  @apply col-span-8 md:col-span-9 bg-white border-2 border-slate-400
         rounded-md px-3 py-2
         focus:outline-none focus:border-blue-600
         focus:ring-2 focus:ring-blue-200;
}
.th { @apply px-3 py-2 text-left font-semibold }
.td { @apply px-3 py-2 }
.btn-primary {
  @apply bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg;
}
.btn-secondary {
  @apply bg-slate-300 hover:bg-slate-400 text-slate-800 px-6 py-2 rounded-lg;
}
.btn-page {
  @apply bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-lg;
}
</style>

</body>
</html>
