<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<link rel="stylesheet" href="dist/output.css">
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>

  <!-- ===== FORM ===== -->
  <form id="memberForm" class="grid grid-cols-2 gap-4 mb-6">
    <input name="first_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="border p-2 rounded" required>
    <input name="last_name" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border p-2 rounded" required>
    <input name="house_no" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" class="border p-2 rounded">
    <input name="village_no" placeholder="‡∏´‡∏°‡∏π‡πà" class="border p-2 rounded">
    <input name="street" placeholder="‡∏ñ‡∏ô‡∏ô" class="border p-2 rounded">
    <input name="village" placeholder="‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" class="border p-2 rounded">
    <input name="sub_district" placeholder="‡∏ï‡∏≥‡∏ö‡∏•" class="border p-2 rounded">
    <input name="district" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" class="border p-2 rounded">
    <input name="province" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" class="border p-2 rounded">
    <input name="postal_code" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" class="border p-2 rounded">
    <input name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="border p-2 rounded">
    <input name="alt_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á" class="border p-2 rounded">
    <select name="gender" class="border p-2 rounded">
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
      <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
      <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
    </select>
    <select name="status" class="border p-2 rounded">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
      <option value="Active">Active</option>
      <option value="Inactive">Inactive</option>
    </select>
    <button type="submit" class="col-span-2 bg-blue-500 text-white p-2 rounded">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    </button>
  </form>

  <!-- ===== FILTER ===== -->
  <div class="grid grid-cols-4 gap-2 mb-4">
    <input id="filterName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border p-2 rounded" oninput="applyFilter()">
    <input id="filterPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="border p-2 rounded" oninput="applyFilter()">
    <select id="filterStatus" class="border p-2 rounded" onchange="applyFilter()">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
      <option value="Active">Active</option>
      <option value="Inactive">Inactive</option>
    </select>
    <input id="filterProvince" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" class="border p-2 rounded" oninput="applyFilter()">
  </div>

  <!-- ===== EXPORT / PRINT ===== -->
  <div class="flex gap-2 mb-4">
    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">
      Export Excel
    </button>
    <button onclick="printMembers()" class="bg-blue-600 text-white px-4 py-2 rounded">
      Print
    </button>
  </div>

  <!-- ===== LIST ===== -->
  <ul id="membersList" class="space-y-2"></ul>
</div>

<script>
const API_URL = "https://ttottijljxoinptmhgtu.supabase.co/functions/v1/members";

let editId = null;
let allMembers = [];
let currentRenderedMembers = []; // üîí ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

/* ================= FETCH ================= */
async function fetchMembers() {
  const res = await fetch(API_URL);
  allMembers = await res.json();
  renderMembers(allMembers);
}

/* ================= RENDER (‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á) ================= */
function renderMembers(data){
  currentRenderedMembers = data; // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

  const list = document.getElementById("membersList");
  list.innerHTML = data.map(m => `
    <li class="flex justify-between bg-gray-50 p-2 rounded border">
      <div>
        ${m.first_name} ${m.last_name} - ${m.phone || ""} - ${m.status || ""} - ${m.province || ""}
      </div>
      <div>
        <button onclick="editMember('${m.id}')" class="bg-yellow-400 text-white px-2 rounded mr-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button onclick="deleteMember('${m.id}')" class="bg-red-500 text-white px-2 rounded">‡∏•‡∏ö</button>
      </div>
    </li>
  `).join('');
}

/* ================= FILTER ================= */
function applyFilter(){
  const name = document.getElementById("filterName").value.toLowerCase();
  const phone = document.getElementById("filterPhone").value;
  const status = document.getElementById("filterStatus").value;
  const province = document.getElementById("filterProvince").value.toLowerCase();

  const filtered = allMembers.filter(m => {
    const fullName = `${m.first_name} ${m.last_name}`.toLowerCase();
    return (
      (!name || fullName.includes(name)) &&
      (!phone || (m.phone || "").includes(phone)) &&
      (!status || m.status === status) &&
      (!province || (m.province || "").toLowerCase().includes(province))
    );
  });

  renderMembers(filtered);
}

/* ================= EXPORT (‡πÉ‡∏ä‡πâ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ================= */
function exportExcel(){
  if(!currentRenderedMembers.length){
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export");
    return;
  }

  const rows = currentRenderedMembers.map(m => ({
    fullname: `${m.first_name} ${m.last_name}`,
    phone: m.phone || "",
    status: m.status || "",
    province: m.province || ""
  }));

  const csv =
    Object.keys(rows[0]).join(",") + "\n" +
    rows.map(r => Object.values(r).join(",")).join("\n");

  const a = document.createElement("a");
  a.href = URL.createObjectURL(
    new Blob([csv], { type: "text/csv;charset=utf-8;" })
  );
  a.download = "members_filtered.csv";
  a.click();
}

/* ================= PRINT ================= */
function printMembers(){
  if(!currentRenderedMembers.length){
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå");
    return;
  }

  const rows = currentRenderedMembers.map(m => `
    <tr>
      <td>${m.first_name} ${m.last_name}</td>
      <td>${m.phone || ""}</td>
      <td>${m.status || ""}</td>
      <td>${m.province || ""}</td>
    </tr>
  `).join("");

  const w = window.open("");
  w.document.write(`
    <table border="1" width="100%" cellspacing="0">
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡πÇ‡∏ó‡∏£</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
      </tr>
      ${rows}
    </table>
  `);
  w.print();
}

/* ================= CRUD ‡πÄ‡∏î‡∏¥‡∏° ================= */
document.getElementById("memberForm").onsubmit = async e => {
  e.preventDefault();
  const body = Object.fromEntries(new FormData(e.target));
  if(editId) body.id = editId;

  await fetch(API_URL,{
    method: editId ? "PUT" : "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  e.target.reset();
  editId = null;
  fetchMembers();
};

async function editMember(id){
  const m = allMembers.find(x => x.id === id);
  if(!m) return;
  const f = document.getElementById("memberForm");
  Object.keys(m).forEach(k => f[k] && (f[k].value = m[k] ?? ""));
  editId = id;
}

async function deleteMember(id){
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  await fetch(API_URL,{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id })
  });
  fetchMembers();
}

/* ================= INIT ================= */
fetchMembers();
</script>
</body>
</html>
