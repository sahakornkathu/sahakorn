<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- LINE MINI APP SDK -->
<script src="https://static.line-scdn.net/miniapp/sdk/miniapp.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- SEARCH -->
<div class="sticky top-0 z-50 bg-slate-800 p-3 shadow">
  <input id="searchInput"
    oninput="resetAndRender()"
    class="w-full rounded-xl px-4 py-2 text-black"
    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
</div>

<!-- REFRESH -->
<div class="px-3 pb-2">
  <button id="refreshBtn"
    onclick="refreshMembers()"
    class="w-full bg-gradient-to-r from-emerald-500 to-green-600
           hover:from-emerald-600 hover:to-green-700
           text-white py-2 rounded-xl font-bold shadow">
    üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  </button>
</div>

<!-- SUMMARY -->
<div class="grid grid-cols-3 gap-3 p-4">
  <div class="bg-slate-800 p-3 rounded-xl text-center">
    <div id="totalCount" class="text-2xl font-bold">0</div>
    <div class="text-sm text-slate-400">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
  </div>
  <div class="bg-slate-800 p-3 rounded-xl text-center">
    <div id="memberCount" class="text-2xl font-bold text-green-400">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
  </div>
  <div class="bg-slate-800 p-3 rounded-xl text-center">
    <div id="associateCount" class="text-2xl font-bold text-blue-400">0</div>
    <div class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</div>
  </div>
</div>

<!-- MAP -->
<div class="px-4">
  <div id="map" class="h-72 rounded-xl"></div>
</div>

<!-- CARD LIST -->
<div id="cardList" class="p-4 space-y-3"></div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://ttottijljxoinptmhgtu.supabase.co'
const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

let allMembers = []
let renderIndex = 0
const PAGE_SIZE = 10
let map, markers = []
let isSuperAdmin = false
let adminGroup = null

/* ================= MINI APP AUTH ================= */
async function getMiniAppProfile(){
  if (!window.line) throw new Error('NOT_MINI_APP')

  const token = await line.getAccessToken()
  if (!token) throw new Error('NO_TOKEN')

  const res = await fetch('https://api.line.me/v2/profile', {
    headers: { Authorization: `Bearer ${token}` }
  })

  if (!res.ok) throw new Error('PROFILE_ERROR')
  return await res.json() // { userId }
}

/* ================= INIT ================= */
async function init(){
  let profile
  try {
    profile = await getMiniAppProfile()
  } catch {
    document.body.innerHTML =
      '<div class="text-center mt-20 text-xl">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE Mini App ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>'
    return
  }

  const { data: admin } = await supabaseClient
    .from('adminmember')
    .select('position, approve_status')
    .eq('line_user_id', profile.userId)
    .maybeSingle()

  if (!admin || admin.approve_status !== 'approved') {
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á')
    return
  }

  isSuperAdmin = admin.position === 'superadmin'
  adminGroup = isSuperAdmin ? null : admin.position.match(/\d+/)?.[0]

  initMap()
  loadMembers()
}

/* ================= MAP ================= */
function initMap(){
  map = L.map('map').setView([13.7,100.5],12)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
}

function renderMarkers(){
  markers.forEach(m=>map.removeLayer(m))
  markers = []
  allMembers.forEach(m=>{
    if(m.lat && m.lng){
      markers.push(L.marker([m.lat,m.lng]).addTo(map))
    }
  })
}

/* ================= LOAD MEMBERS ================= */
async function loadMembers(){
  allMembers = []
  let from = 0
  const STEP = 1000
  let done = false

  while (!done){
    let q = supabaseClient
      .from('members')
      .select(`member_id,title,first_name,last_name,group,
        house_no,moo,subdistrict,district,province,
        phone,member_status,lat,lng`)
      .in('member_status',['‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å','‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö'])
      .order('member_id',{ascending:true})
      .range(from, from+STEP-1)

    if (!isSuperAdmin) q = q.eq('group', adminGroup)

    const { data, error } = await q
    if (error) return alert(error.message)

    if (!data || data.length === 0) done = true
    else {
      allMembers = allMembers.concat(data)
      from += STEP
    }
  }

  updateSummary()
  renderMarkers()
  resetAndRender()
}

/* ================= SUMMARY ================= */
function updateSummary(){
  totalCount.innerText = allMembers.length
  memberCount.innerText = allMembers.filter(m=>m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å').length
  associateCount.innerText = allMembers.filter(m=>m.member_status==='‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö').length
}

/* ================= RENDER ================= */
function resetAndRender(){
  renderIndex = 0
  cardList.innerHTML = ''
  renderMore()
}

function renderMore(){
  const kw = searchInput.value.toLowerCase()
  const list = allMembers
    .filter(m =>
      m.member_id.toString().includes(kw) ||
      m.first_name.toLowerCase().includes(kw) ||
      m.last_name.toLowerCase().includes(kw)
    )
    .sort((a,b)=>a.member_id-b.member_id)

  list.slice(renderIndex, renderIndex+PAGE_SIZE).forEach(m=>{
    cardList.innerHTML += `
    <div class="bg-slate-800 p-4 rounded-xl space-y-2">
      <div class="flex justify-between">
        <div>
          <div class="font-bold text-lg">${m.member_id} ¬∑ ${m.first_name} ${m.last_name}</div>
          <div class="text-xs text-slate-400">‡∏Å‡∏•‡∏∏‡πà‡∏° ${m.group}</div>
        </div>
        <span class="text-xs px-2 py-1 rounded ${m.lat?'bg-green-600':'bg-red-600'}">
          ${m.lat?'üìç ‡∏õ‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß':'‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å'}
        </span>
      </div>

      <button onclick="pinGPS(${m.member_id})"
        class="w-full bg-blue-600 rounded py-1">üìç ‡∏õ‡∏±‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>

      ${m.lat ? `
      <a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}"
        target="_blank"
        class="block bg-slate-700 rounded py-1 text-center">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>` : ``}

      <a href="tel:${m.phone}" class="block text-green-400 font-bold">üìû ${m.phone}</a>
    </div>`
  })

  renderIndex += PAGE_SIZE
}

/* ================= GPS ================= */
function pinGPS(memberId){
  Swal.fire({
    title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î',
    icon:'warning',
    showCancelButton:true,
    confirmButtonText:'üìç ‡∏õ‡∏±‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î'
  }).then(r=>{
    if(!r.isConfirmed) return

    navigator.geolocation.getCurrentPosition(async pos=>{
      await supabaseClient.from('members')
        .update({lat:pos.coords.latitude,lng:pos.coords.longitude})
        .eq('member_id',memberId)
      loadMembers()
    })
  })
}

/* ================= REFRESH ================= */
async function refreshMembers(){
  await loadMembers()
  Swal.fire({toast:true,position:'top',icon:'success',title:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',timer:1200,showConfirmButton:false})
}

window.addEventListener('scroll',()=>{
  if(innerHeight + scrollY >= document.body.offsetHeight - 200){
    renderMore()
  }
})

init()
</script>
</body>
</html>
