<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile Minimal</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div id="profile">กำลังโหลด...</div>

<script>
const LIFF_ID = "1661506692-K4XeBbvd";
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const profileContainer = document.getElementById("profile");

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isInClient()) {
      profileContainer.innerHTML = "กรุณาเปิดใน LINE App เท่านั้น";
      return;
    }

    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId;

    // Anonymous login Supabase
    await supabase.auth.signInAnonymously();

    // โหลด profile ครั้งแรก
    const { data } = await supabase
      .from("user_profiles")
      .select("*")
      .eq("userId", userId)
      .maybeSingle();

    if (!data) {
      profileContainer.innerHTML = "ไม่พบข้อมูลผู้ใช้";
      return;
    }

    profileContainer.innerHTML = `
      <p>${data.displayName || 'No Name'}</p>
      <p>Point: ${data.point || 0}</p>
      <p>Role: ${data.role || '-'}</p>
    `;

    // Realtime subscription
    supabase
      .channel('user-profile')
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'user_profiles', filter: `userId=eq.${userId}` }, payload => {
        console.log("Realtime:", payload);
        profileContainer.innerHTML = `
          <p>${payload.new.displayName || 'No Name'}</p>
          <p>Point: ${payload.new.point || 0}</p>
          <p>Role: ${payload.new.role || '-'}</p>
        `;
      })
      .subscribe();

  } catch(err) {
    console.error(err);
    profileContainer.innerHTML = "เกิดข้อผิดพลาด";
  }
}

init();
</script>
</body>
</html>
